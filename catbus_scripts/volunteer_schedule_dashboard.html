<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    :root {
      --accent-color: rgb(142, 0, 0);
      --bg-color-light: #f5f5f5;
      --text-color-light: #1a1a1a;
      --input-bg-light: #ffffff;
      --border-light: #e0e0e0;
      --bg-color-dark: #1e1e1e;
      --text-color-dark: #f0f0f0;
      --input-bg-dark: #2a2a2a;
      --border-dark: #444;
      --success-color: #27ae60;
      --mentor-color: #3498db;
      --frontline-color: #2ecc71;
      --filer-color: #9b59b6;
      --internal-services-color: #e74c3c;
      --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    body.light {
      background-color: var(--bg-color-light);
      color: var(--text-color-light);
    }

    body.dark {
      background-color: var(--bg-color-dark);
      color: var(--text-color-dark);
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Verdana, sans-serif;
      padding: 30px 20px;
      transition: background 0.3s, color 0.3s;
      max-width: 1200px;
      margin: 0 auto;
      line-height: 1.6;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }

    h1 {
      margin: 0;
      color: var(--accent-color);
      font-size: 2em;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    h2 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.3em;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    h3 {
      font-size: 1.1em;
      font-weight: 600;
      letter-spacing: -0.2px;
    }

    .toggle-theme {
      cursor: pointer;
      font-size: 1.4em;
      margin-left: 10px;
    }

    .form-section {
      background: var(--input-bg-light);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-light);
      transition: background 0.3s, border 0.3s, box-shadow 0.3s;
    }

    .form-section:hover {
      box-shadow: var(--shadow-hover);
    }

    body.light .form-section {
      background-color: var(--input-bg-light);
      border-color: var(--border-light);
    }

    body.dark .form-section {
      background-color: var(--input-bg-dark);
      border-color: var(--border-dark);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    body.dark .form-section:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    input[type="text"],
    select,
    button {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-light);
      border-radius: 8px;
      font-size: 14px;
      transition: border 0.3s, background 0.3s, transform 0.2s, box-shadow 0.3s;
      box-sizing: border-box;
    }

    body.light input[type="text"],
    body.light select {
      background-color: #ffffff;
      border-color: var(--border-light);
      color: var(--text-color-light);
    }

    body.dark input[type="text"],
    body.dark select {
      background-color: #333;
      border-color: var(--border-dark);
      color: var(--text-color-dark);
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(142, 0, 0, 0.1);
    }

    button {
      background-color: var(--accent-color);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
    }

    button:hover:not(:disabled) {
      background-color: #a00000;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(142, 0, 0, 0.3);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .results-section {
      margin-top: 25px;
      animation: fadeIn 0.4s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .schedule-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 15px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .schedule-table th,
    .schedule-table td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
    }

    body.dark .schedule-table th,
    body.dark .schedule-table td {
      border-bottom-color: var(--border-dark);
    }

    .schedule-table th {
      background-color: var(--accent-color);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .schedule-table tbody tr {
      transition: background-color 0.2s;
    }

    .schedule-table tbody tr:hover {
      background-color: rgba(142, 0, 0, 0.05);
    }

    body.dark .schedule-table tbody tr:hover {
      background-color: rgba(142, 0, 0, 0.15);
    }

    .schedule-table tr:nth-child(even) {
      background-color: rgba(0, 0, 0, 0.02);
    }

    body.dark .schedule-table tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.02);
    }

    .schedule-table tbody tr:last-child td {
      border-bottom: none;
    }

    .shift-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin: 2px;
      background-color: rgba(142, 0, 0, 0.1);
      color: var(--accent-color);
    }

    .no-results {
      padding: 20px;
      text-align: center;
      color: #666;
    }

    body.dark .no-results {
      color: #aaa;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--accent-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .day-header {
      font-weight: 600;
      color: var(--accent-color);
      margin-top: 25px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--accent-color);
      font-size: 1.1em;
    }

    .volunteer-item {
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 8px;
      transition: background 0.2s, color 0.3s, transform 0.2s, box-shadow 0.2s;
      border: 1px solid transparent;
    }

    .volunteer-item:hover {
      transform: translateX(4px);
      box-shadow: -3px 0 0 0 var(--accent-color);
    }

    body.light .volunteer-item {
      background: #f9f9f9;
      color: var(--text-color-light);
      border-color: var(--border-light);
    }

    body.dark .volunteer-item {
      background: #2d2d2d;
      color: var(--text-color-dark);
      border-color: var(--border-dark);
    }

    .empty-slot {
      padding: 12px 16px;
      transition: color 0.3s;
      font-style: italic;
      color: #999;
    }

    body.light .empty-slot {
      color: #999;
    }

    body.dark .empty-slot {
      color: #666;
    }

    .role-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 600;
      margin-left: 8px;
      transition: transform 0.2s;
    }

    .role-badge.mentor {
      background-color: rgba(52, 152, 219, 0.15);
      color: var(--mentor-color);
      border: 1px solid var(--mentor-color);
    }

    .role-badge.frontline {
      background-color: rgba(46, 204, 113, 0.15);
      color: var(--frontline-color);
      border: 1px solid var(--frontline-color);
    }

    .role-badge.filer {
      background-color: rgba(155, 89, 182, 0.15);
      color: var(--filer-color);
      border: 1px solid var(--filer-color);
    }

    body.dark .role-badge.mentor {
      background-color: rgba(52, 152, 219, 0.25);
    }

    body.dark .role-badge.frontline {
      background-color: rgba(46, 204, 113, 0.25);
    }

    body.dark .role-badge.filer {
      background-color: rgba(155, 89, 182, 0.25);
    }

    .role-badge.internalservices {
      background-color: rgba(231, 76, 60, 0.15);
      color: var(--internal-services-color);
      border: 1px solid var(--internal-services-color);
    }

    body.dark .role-badge.internalservices {
      background-color: rgba(231, 76, 60, 0.25);
    }

    .volunteer-tag {
      display: inline-block;
      padding: 3px 10px;
      margin-left: 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-style: italic;
      font-weight: 500;
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 152, 0, 0.15) 100%);
      color: #b8860b;
      border: 1px dashed rgba(255, 152, 0, 0.4);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .volunteer-tag::before {
      content: '‚ú® ';
      font-style: normal;
    }

    .volunteer-tag:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
    }

    body.dark .volunteer-tag {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.25) 0%, rgba(255, 152, 0, 0.25) 100%);
      color: #ffc107;
      border-color: rgba(255, 193, 7, 0.5);
    }

    body.dark .volunteer-tag:hover {
      box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
    }

    .footer-copyright {
      position: fixed;
      bottom: 10px;
      right: 20px;
      font-size: 11px;
      opacity: 0.6;
      transition: opacity 0.3s, color 0.3s;
      z-index: 1000;
      pointer-events: none;
      max-width: 400px;
      text-align: right;
      line-height: 1.3;
    }

    body.light .footer-copyright {
      color: var(--text-color-light);
    }

    body.dark .footer-copyright {
      color: var(--text-color-dark);
    }

    .footer-copyright:hover {
      opacity: 0.8;
    }

    /* Autocomplete dropdown styles */
    .autocomplete-container {
      position: relative;
      width: 100%;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 300px;
      overflow-y: auto;
      border: 2px solid var(--border-light);
      border-top: none;
      border-radius: 0 0 4px 4px;
      background-color: #ffffff;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    body.dark .autocomplete-dropdown {
      background-color: #333;
      border-color: var(--border-dark);
    }

    .autocomplete-item {
      padding: 12px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid var(--border-light);
    }

    body.dark .autocomplete-item {
      border-bottom-color: var(--border-dark);
    }

    .autocomplete-item:hover {
      background-color: rgba(142, 0, 0, 0.1);
    }

    body.dark .autocomplete-item:hover {
      background-color: rgba(142, 0, 0, 0.2);
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item.highlighted {
      background-color: rgba(142, 0, 0, 0.15);
    }

    body.dark .autocomplete-item.highlighted {
      background-color: rgba(142, 0, 0, 0.3);
    }

    .no-matches {
      padding: 12px;
      color: #666;
      font-style: italic;
    }

    body.dark .no-matches {
      color: #aaa;
    }

    .help-text {
      font-size: 0.9em;
      color: #666;
      margin-top: 8px;
      font-style: italic;
    }

    body.dark .help-text {
      color: #999;
    }

    .total-shifts {
      margin-top: 20px;
      padding: 12px 16px;
      background-color: rgba(142, 0, 0, 0.05);
      border-left: 4px solid var(--accent-color);
      border-radius: 4px;
      font-weight: 600;
    }

    body.dark .total-shifts {
      background-color: rgba(142, 0, 0, 0.15);
    }
  </style>
</head>
<body class="light">
  <header>
    <h1>üìÖ Volunteer Schedule Viewer</h1>
    <div>
      <span class="toggle-theme" onclick="toggleTheme()">‚òÄÔ∏è</span>
    </div>
  </header>

  <div class="form-section">
    <h2>Search by Name</h2>
    <div class="form-group">
      <label for="searchName">Search for your name:</label>
      <div class="autocomplete-container">
        <input type="text" id="searchName" placeholder="Start typing to search for a volunteer..." autocomplete="off" style="flex: 1;">
        <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
      </div>
      <div style="margin-top: 10px; display: flex; gap: 10px;">
        <button type="button" onclick="searchByName()" style="width: auto; min-width: 120px;">üîç Search</button>
        <button type="button" onclick="clearSearch()" style="width: auto; min-width: 120px; background-color: #666;">‚úñÔ∏è Clear</button>
      </div>
    </div>
    
    <div id="nameResults" class="results-section" style="display: none;">
      <h3 id="nameResultsHeader">Your Assigned Shifts</h3>
      <div id="nameResultsContent"></div>
    </div>
  </div>

  <div class="form-section">
    <h2>View Schedule by Day</h2>
    <div class="form-group">
      <label for="selectDay">Select a day:</label>
      <select id="selectDay" onchange="viewDaySchedule()">
        <option value="">Select a day...</option>
        <option value="Day 1" id="dayOption1">Loading...</option>
        <option value="Day 2" id="dayOption2">Loading...</option>
        <option value="Day 3" id="dayOption3">Loading...</option>
        <option value="Day 4" id="dayOption4">Loading...</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="filterRole">Filter by Role (Optional):</label>
      <select id="filterRole" onchange="viewDaySchedule()">
        <option value="">All Roles</option>
        <option value="Mentor">Mentor</option>
        <option value="Frontline">Frontline</option>
        <option value="Filer">Filer</option>
        <option value="Internal Services">Internal Services</option>
      </select>
      <div class="help-text">Leave as "All Roles" to see everyone scheduled</div>
    </div>
    
    <div id="dayResults" class="results-section" style="display: none;">
      <h3 id="dayResultsHeader"></h3>
      <div id="dayResultsContent"></div>
    </div>
  </div>

<?!= include('shared_scripts') ?>
<script>
  // Schedule configuration - loaded from backend Config.gs
  const SHIFT_CONFIG = {
    TIME_SLOTS: {}
  };

  let allVolunteerNames = [];
  let filteredVolunteers = [];
  let highlightedIndex = -1;

  window.addEventListener('load', () => {
    loadVolunteerNames();
    loadScheduleConfig();
    setupAutocomplete();
  });

  function loadScheduleConfig() {
    google.script.run
      .withSuccessHandler(config => {
        // Populate SHIFT_CONFIG from backend
        SHIFT_CONFIG.TIME_SLOTS = config.timeSlots;

        // Update dropdown options with actual day labels
        const dayLabels = config.dayLabels;
        for (let i = 0; i < 4 && i < dayLabels.length; i++) {
          const option = document.getElementById(`dayOption${i + 1}`);
          if (option) {
            option.textContent = dayLabels[i] || `Day ${i + 1}`;
            option.value = dayLabels[i] || `Day ${i + 1}`;
          }
        }
      })
      .withFailureHandler(error => {
        console.error('Error loading schedule config:', error);
      })
      .getScheduleConfig();
  }

  function loadVolunteerNames() {
    google.script.run
      .withSuccessHandler(names => {
        allVolunteerNames = names || [];
        console.log('Loaded ' + allVolunteerNames.length + ' volunteer names');
      })
      .withFailureHandler(error => {
        console.error('Error loading volunteer names:', error);
        allVolunteerNames = [];
      })
      .getAllVolunteerNames();
  }

  function setupAutocomplete() {
    const searchInput = document.getElementById('searchName');
    const dropdown = document.getElementById('autocompleteDropdown');

    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.trim().toLowerCase();
      
      if (searchTerm.length === 0) {
        dropdown.style.display = 'none';
        filteredVolunteers = [];
        return;
      }

      // Filter volunteers
      filteredVolunteers = allVolunteerNames.filter(name => 
        name.toLowerCase().includes(searchTerm)
      );

      highlightedIndex = -1;

      if (filteredVolunteers.length === 0) {
        dropdown.innerHTML = '<div class="no-matches">No volunteers found</div>';
        dropdown.style.display = 'block';
      } else {
        // Show up to 10 results
        const displayCount = Math.min(filteredVolunteers.length, 10);
        let html = '';
        for (let i = 0; i < displayCount; i++) {
          const volunteerName = filteredVolunteers[i];
          // Escape the name for HTML and use data attribute for safer handling
          const escapedName = volunteerName.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          html += `<div class="autocomplete-item" data-index="${i}" data-name="${escapedName}" onclick="selectVolunteer(this.dataset.name)">${highlightMatch(volunteerName, searchTerm)}</div>`;
        }
        if (filteredVolunteers.length > 10) {
          html += `<div class="no-matches">... and ${filteredVolunteers.length - 10} more</div>`;
        }
        dropdown.innerHTML = html;
        dropdown.style.display = 'block';
      }
    });

    // Handle keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
      if (dropdown.style.display === 'none' || filteredVolunteers.length === 0) {
        if (e.key === 'Enter') {
          searchByName();
        }
        return;
      }

      const items = dropdown.querySelectorAll('.autocomplete-item');

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        highlightedIndex = (highlightedIndex + 1) % items.length;
        updateHighlight(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        highlightedIndex = highlightedIndex <= 0 ? items.length - 1 : highlightedIndex - 1;
        updateHighlight(items);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (highlightedIndex >= 0 && highlightedIndex < filteredVolunteers.length) {
          const selectedItem = items[highlightedIndex];
          selectVolunteer(selectedItem.dataset.name);
        } else {
          searchByName();
        }
      } else if (e.key === 'Escape') {
        dropdown.style.display = 'none';
        highlightedIndex = -1;
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
        highlightedIndex = -1;
      }
    });
  }

  function updateHighlight(items) {
    items.forEach((item, index) => {
      if (index === highlightedIndex) {
        item.classList.add('highlighted');
        item.scrollIntoView({ block: 'nearest' });
      } else {
        item.classList.remove('highlighted');
      }
    });
  }

  function highlightMatch(text, searchTerm) {
    if (!searchTerm) return text;
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    return text.replace(regex, '<strong>$1</strong>');
  }

  function selectVolunteer(name) {
    document.getElementById('searchName').value = name;
    document.getElementById('autocompleteDropdown').style.display = 'none';
    highlightedIndex = -1;
    // Automatically search when a volunteer is selected
    searchByName();
  }

  function clearSearch() {
    document.getElementById('searchName').value = '';
    document.getElementById('autocompleteDropdown').style.display = 'none';
    document.getElementById('nameResults').style.display = 'none';
    filteredVolunteers = [];
    highlightedIndex = -1;
  }

  function searchByName() {
    const searchTerm = document.getElementById('searchName').value.trim().toLowerCase();
    
    if (!searchTerm) {
      alert('Please enter a name to search');
      return;
    }

    const nameResults = document.getElementById('nameResults');
    const nameResultsContent = document.getElementById('nameResultsContent');
    nameResults.style.display = 'block';
    nameResultsContent.innerHTML = '<div class="loading"></div> Loading...';

    google.script.run
      .withSuccessHandler(result => {
        displayNameResults(result, searchTerm);
      })
      .withFailureHandler(error => {
        nameResultsContent.innerHTML = `<div class="no-results">Error loading schedule: ${error.message || error}</div>`;
      })
      .getVolunteerScheduleByName(searchTerm);
  }

  function displayNameResults(result, searchTerm) {
    const nameResultsContent = document.getElementById('nameResultsContent');
    const nameResultsHeader = document.getElementById('nameResultsHeader');
    
    if (!result || !result.shifts || result.shifts.length === 0) {
      nameResultsHeader.textContent = 'Search Results';
      nameResultsContent.innerHTML = `<div class="no-results">No scheduled shifts found for "${searchTerm}"</div>`;
      return;
    }

    // Display volunteer name with tag if available
    const tagHtml = result.volunteerTag
      ? `<span class="volunteer-tag">${escapeHtml(result.volunteerTag)}</span>`
      : '';
    nameResultsHeader.innerHTML = `Assigned Shifts for: ${escapeHtml(result.volunteerName || searchTerm)} ${tagHtml}`;

    let html = `
      <table class="schedule-table">
        <thead>
          <tr>
            <th>Day</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody>
    `;

    result.shifts.forEach(shift => {
      html += `
        <tr>
          <td>${shift.day}</td>
          <td>${shift.time}</td>
        </tr>
      `;
    });

    html += `
        </tbody>
      </table>
      <div class="total-shifts">üìä Total Shifts: ${result.shifts.length}</div>
    `;

    // Show "My Senior Mentor" section if volunteer is a mentor with senior assignments
    if (result.seniorsByDay && Object.keys(result.seniorsByDay).length > 0) {
      html += `
        <div class="senior-mentor-section" style="margin-top: 20px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 8px; border: 1px solid rgba(52, 152, 219, 0.3);">
          <h3 style="margin: 0 0 12px 0; color: var(--mentor-color); font-size: 16px;">üë§ My Senior Mentor</h3>
          <div style="display: grid; gap: 8px;">
      `;

      // Sort days chronologically by parsing dates
      const sortedDays = Object.entries(result.seniorsByDay).sort((a, b) => {
        const dateA = new Date(a[0].replace(/^(Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday)\s+/, ''));
        const dateB = new Date(b[0].replace(/^(Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday)\s+/, ''));
        return dateA - dateB;
      });

      for (const [day, senior] of sortedDays) {
        const seniorDisplay = senior || '<span style="color: #999;">Unassigned</span>';
        html += `
          <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255,255,255,0.5); border-radius: 4px;">
            <span style="font-weight: 500;">${day}</span>
            <span>${seniorDisplay}</span>
          </div>
        `;
      }

      html += `
          </div>
        </div>
      `;
    }

    // Show "My Team" section if volunteer is a senior mentor with team members
    if (result.teamMembersByDay && Object.keys(result.teamMembersByDay).length > 0) {
      html += `
        <div class="team-section" style="margin-top: 20px; padding: 15px; background: rgba(155, 89, 182, 0.1); border-radius: 8px; border: 1px solid rgba(155, 89, 182, 0.3);">
          <h3 style="margin: 0 0 12px 0; color: #9b59b6; font-size: 16px;">üë• My Team</h3>
          <div style="display: grid; gap: 8px;">
      `;

      // Sort days chronologically
      const sortedTeamDays = Object.entries(result.teamMembersByDay).sort((a, b) => {
        const dateA = new Date(a[0].replace(/^(Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday)\s+/, ''));
        const dateB = new Date(b[0].replace(/^(Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday)\s+/, ''));
        return dateA - dateB;
      });

      for (const [day, members] of sortedTeamDays) {
        html += `
          <div style="padding: 8px 12px; background: rgba(255,255,255,0.5); border-radius: 4px;">
            <div style="font-weight: 500; margin-bottom: 4px;">${day}</div>
            <div style="color: #666;">${members.join(', ')}</div>
          </div>
        `;
      }

      html += `
          </div>
        </div>
      `;
    }

    nameResultsContent.innerHTML = html;
  }

  function viewDaySchedule() {
    const selectedDay = document.getElementById('selectDay').value;
    const filterRole = document.getElementById('filterRole').value;
    
    if (!selectedDay) {
      document.getElementById('dayResults').style.display = 'none';
      return;
    }

    const dayResults = document.getElementById('dayResults');
    const dayResultsHeader = document.getElementById('dayResultsHeader');
    const dayResultsContent = document.getElementById('dayResultsContent');
    
    dayResults.style.display = 'block';
    dayResultsContent.innerHTML = '<div class="loading"></div> Loading...';

    google.script.run
      .withSuccessHandler(result => {
        displayDayResults(result, selectedDay, filterRole);
      })
      .withFailureHandler(error => {
        dayResultsContent.innerHTML = `<div class="no-results">Error loading schedule: ${error.message || error}</div>`;
      })
      .getVolunteerScheduleByDay(selectedDay, filterRole);
  }

  function displayDayResults(result, day, filterRole) {
    const dayResultsContent = document.getElementById('dayResultsContent');
    const dayResultsHeader = document.getElementById('dayResultsHeader');
    
    // Use the actual day label from the result if available
    const displayDay = result.dayLabel || day;
    
    // Update header with actual day label
    let headerText = `Schedule for ${displayDay}`;
    if (filterRole) {
      headerText += ` - ${filterRole} only`;
    }
    dayResultsHeader.textContent = headerText;
    
    if (!result || !result.schedule || Object.keys(result.schedule).length === 0) {
      let message = `No volunteers scheduled for ${displayDay}`;
      if (filterRole) {
        message += ` with role ${filterRole}`;
      }
      dayResultsContent.innerHTML = `<div class="no-results">${message}</div>`;
      return;
    }

    // Build volunteer role map and custom tags from result
    const volunteerRoles = result.volunteerRoles || {};
    const volunteerTags = result.volunteerTags || {};

    // Initialize all time slots with empty arrays (will be populated from schedule)
    const timeSlots = {};
    Object.keys(SHIFT_CONFIG.TIME_SLOTS).forEach(slotKey => {
      const display = SHIFT_CONFIG.TIME_SLOTS[slotKey].display;
      timeSlots[display] = [];
    });

    // Populate time slots from schedule data
    Object.keys(result.schedule).forEach(timeSlotKey => {
      let volunteers = result.schedule[timeSlotKey] || [];
      
      // Filter by role if specified
      if (filterRole && filterRole.trim() && volunteers.length > 0) {
        volunteers = volunteers.filter(volunteer => {
          const role = volunteerRoles[volunteer];
          return role === filterRole.trim();
        });
      }
      
      // Dynamically match time slot using SHIFT_CONFIG
      let matchedTimeDisplay = null;
      Object.keys(SHIFT_CONFIG.TIME_SLOTS).forEach(slotKey => {
        const display = SHIFT_CONFIG.TIME_SLOTS[slotKey].display; // "9:45-1:15", "1:00-4:45", "4:30-8:15"
        if (timeSlotKey.includes(display)) {
          matchedTimeDisplay = display;
        }
      });

      // Update the time slot with filtered volunteers
      if (matchedTimeDisplay && timeSlots[matchedTimeDisplay] !== undefined) {
        timeSlots[matchedTimeDisplay] = volunteers;
      }
    });

    let html = '';

    Object.keys(timeSlots).forEach(timeSlot => {
      const volunteerCount = timeSlots[timeSlot].length;
      html += `<div class="day-header">${timeSlot} <span style="font-weight: normal; opacity: 0.8;">(${volunteerCount} ${volunteerCount === 1 ? 'volunteer' : 'volunteers'})</span></div>`;
      
      if (volunteerCount > 0) {
        html += '<ul style="list-style: none; padding-left: 0;">';
        timeSlots[timeSlot].forEach(volunteer => {
          const role = volunteerRoles[volunteer] || 'N/A';
          const roleClass = role.toLowerCase().replace(/\s+/g, '');
          const customTag = volunteerTags[volunteer] || '';
          const tagHtml = customTag ? `<span class="volunteer-tag">${escapeHtml(customTag)}</span>` : '';
          html += `<li class="volunteer-item">
            <strong>${escapeHtml(volunteer)}</strong>${tagHtml} <span class="role-badge ${escapeHtml(role)}">${escapeHtml(role)}</span>
          </li>`;
        });
        html += '</ul>';
      } else {
        html += '<div class="empty-slot">No volunteers scheduled for this time slot</div>';
      }
    });

    if (!html) {
      let message = `No volunteers scheduled for ${displayDay}`;
      if (filterRole) {
        message += ` with role ${filterRole}`;
      }
      html = `<div class="no-results">${message}</div>`;
    }

    dayResultsContent.innerHTML = html;
  }

  // Enter key handling is now in setupAutocomplete() for better autocomplete integration
</script>
<div class="footer-copyright">The Client And Tax Booking Utility System (CATBUS) is designed for use only by UW AFSA Tax Clinic.</div>
</body>
</html>
