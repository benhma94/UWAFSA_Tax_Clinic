{"files":[{"id":"fb5f0dbd-cd4a-4020-b3d5-58ef48e4bb5c","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"America/New_York\",\n  \"dependencies\": {},\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  },\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}"},{"id":"49850d48-a2a9-4f3f-8696-fa2cd2d15eff","name":"Code","type":"server_js","source":"// Entry point to load the dashboard as a web app\nfunction doGet() {\n  return HtmlService.createHtmlOutputFromFile(\u0027dashboard\u0027)\n    .setTitle(\u0027Live Help Request Dashboard\u0027)\n    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL); // Optional: embed support\n}\n\n// Returns all currently Active or Escalated help requests\nfunction getLiveHelpRequests() {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const sheet \u003d ss.getSheetByName(\u0027Help Requests\u0027);\n  const data \u003d sheet.getDataRange().getValues();\n  const now \u003d new Date();\n  const output \u003d [];\n\n  for (let i \u003d 1; i \u003c data.length; i++) {\n    const timestamp \u003d data[i][0];\n    const volunteer \u003d data[i][1]?.toString().trim();\n    const status \u003d data[i][2]?.toString().trim().toLowerCase();\n\n    if (!timestamp || !volunteer || !status) continue;\n    if (status !\u003d\u003d \"active\" \u0026\u0026 status !\u003d\u003d \"escalated\") continue;\n\n    const minutesAgo \u003d Math.floor((now - new Date(timestamp)) / 60000);\n\n    output.push({\n      volunteer,\n      timestamp: Utilities.formatDate(new Date(timestamp), Session.getScriptTimeZone(), \u0027M/d/yyyy HH:mm\u0027),\n      status,\n      minutesAgo,\n      rawTimestamp: new Date(timestamp).getTime() // for sorting\n    });\n  }\n\n  // Sort by time waited (descending: oldest first)\n  output.sort((a, b) \u003d\u003e b.minutesAgo - a.minutesAgo); // or use rawTimestamp\n\n  return output;\n}\n\nfunction clearHelpRequest(volunteer) {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const sheet \u003d ss.getSheetByName(\u0027Help Requests\u0027);\n  const data \u003d sheet.getDataRange().getValues();\n\n  for (let i \u003d 1; i \u003c data.length; i++) {\n    const v \u003d data[i][1]?.toString().trim();\n    const status \u003d data[i][2]?.toString().trim().toLowerCase();\n    if (v \u003d\u003d\u003d volunteer \u0026\u0026 (status \u003d\u003d\u003d \"active\" || status \u003d\u003d\u003d \"escalated\")) {\n      sheet.getRange(i + 1, 3).setValue(\"Cleared\");\n      break;\n    }\n  }\n}\nfunction getReturnSummary() {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const sheet \u003d ss.getSheetByName(\u0027Tax Return Tracker\u0027);\n  const data \u003d sheet.getDataRange().getValues();\n  const today \u003d new Date();\n  const timezone \u003d Session.getScriptTimeZone();\n\n  let totalCompleted \u003d 0;\n  let completedToday \u003d 0;\n  const hourlyCounts \u003d {};\n\n  for (let i \u003d 1; i \u003c data.length; i++) {\n    const row \u003d data[i];\n    const timestamp \u003d row[0];\n    const efile \u003d row[6]?.toString().toLowerCase() \u003d\u003d\u003d \u0027yes\u0027;\n    const paper \u003d row[7]?.toString().toLowerCase() \u003d\u003d\u003d \u0027yes\u0027;\n\n    if (efile || paper) {\n      totalCompleted++;\n\n      const ts \u003d new Date(timestamp);\n      const sameDay \u003d ts.getFullYear() \u003d\u003d\u003d today.getFullYear()\n                   \u0026\u0026 ts.getMonth() \u003d\u003d\u003d today.getMonth()\n                   \u0026\u0026 ts.getDate() \u003d\u003d\u003d today.getDate();\n\n      if (sameDay) {\n        completedToday++;\n\n        const hour \u003d ts.getHours();\n        hourlyCounts[hour] \u003d (hourlyCounts[hour] || 0) + 1;\n      }\n    }\n  }\n\n  return {\n    totalCompleted,\n    completedToday,\n    hourlyCounts\n  };\n}"},{"id":"16102410-826e-4f85-8751-21bbd15b0643","name":"dashboard","type":"html","source":"\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n  \u003cbase target\u003d\"_top\"\u003e\n  \u003cstyle\u003e\n    :root {\n      --accent-color: rgb(142, 0, 0);\n      --bg-color-light: #ffffff;\n      --text-color-light: #1a1a1a;\n      --input-bg-light: #f2f2f2;\n      --border-light: #ccc;\n\n      --bg-color-dark: #1e1e1e;\n      --text-color-dark: #f0f0f0;\n      --input-bg-dark: #2a2a2a;\n      --border-dark: #444;\n    }\n\n    body.light {\n      background-color: var(--bg-color-light);\n      color: var(--text-color-light);\n    }\n\n    body.dark {\n      background-color: var(--bg-color-dark);\n      color: var(--text-color-dark);\n    }\n\n    body {\n      margin: 0;\n      font-family: \u0027Segoe UI\u0027, Verdana, sans-serif;\n      padding: 20px;\n      transition: background 0.3s, color 0.3s;\n    }\n\n    .request {\n      padding: 12px;\n      border-radius: 8px;\n      margin-bottom: 8px;\n      color: white;\n      font-weight: bold;\n    }\n    .toggle-theme {\n      cursor: pointer;\n      font-size: 1.4em;\n      margin-left: 10px;\n    }\n    .request.active {\n      background-color: #f4b400;\n    }\n\n    .request.escalated {\n      background-color: #d93025;\n      animation: pulse 1.2s infinite;\n    }\n\n    @keyframes pulse {\n      0% { transform: scale(1); opacity: 1; }\n      50% { transform: scale(1.03); opacity: 0.9; }\n      100% { transform: scale(1); opacity: 1; }\n    }\n\n    .summary-box {\n      background: var(--input-bg-light);\n      padding: 16px;\n      border-radius: 8px;\n      margin-top: 30px;\n      color: var(--text-color-light);\n    }\n\n    canvas {\n      margin-top: 20px;\n      width: 100%;\n      max-width: 400px;  /* controls how wide the chart can go */\n      height: auto;\n    }\n\n    header {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      margin-bottom: 30px;\n    }\n  \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody class\u003d\"light\"\u003e\n  \u003cheader\u003e\n    \u003cdiv\u003e\n      \u003cspan class\u003d\"toggle-theme\" onclick\u003d\"toggleTheme()\"\u003e‚òÄÔ∏è\u003c/span\u003e\n    \u003c/div\u003e\n  \u003c/header\u003e\n\n  \u003ch3\u003eüö® AFSA Tax Clinic QQ Dashboard\u003c/h3\u003e\n  \u003cdiv id\u003d\"container\"\u003eLoading help requests...\u003c/div\u003e\n\n  \u003cdiv class\u003d\"summary-box\"\u003e\n    \u003ch3\u003eüìä Return Completion Summary\u003c/h3\u003e\n    \u003cp\u003eTotal Completed: \u003cstrong id\u003d\"totalCount\"\u003e0\u003c/strong\u003e\u003c/p\u003e\n    \u003cp\u003eCompleted Today: \u003cstrong id\u003d\"todayCount\"\u003e0\u003c/strong\u003e\u003c/p\u003e\n    \u003ccanvas id\u003d\"completionChart\" width \u003d \"400\" height \u003d \"200\"\u003e\u003c/canvas\u003e\n  \u003c/div\u003e\n\n  \u003cscript src\u003d\"https://cdn.jsdelivr.net/npm/chart.js\"\u003e\u003c/script\u003e\n\u003cscript src\u003d\"https://cdn.jsdelivr.net/npm/chart.js\"\u003e\u003c/script\u003e\n\u003cscript\u003e\n  let lastRequestsSerialized \u003d \"\";\n  let lastSummarySerialized \u003d \"\";\n  let chartInstance \u003d null;   // persist chart instead of recreating\n\n  function toggleTheme() {\n    const body \u003d document.body;\n    const toggle \u003d document.querySelector(\u0027.toggle-theme\u0027);\n    if (body.classList.contains(\u0027dark\u0027)) {\n      body.classList.replace(\u0027dark\u0027, \u0027light\u0027);\n      toggle.textContent \u003d \u0027‚òÄÔ∏è\u0027;\n    } else {\n      body.classList.replace(\u0027light\u0027, \u0027dark\u0027);\n      toggle.textContent \u003d \u0027üåô\u0027;\n    }\n  }\n\n  function render(requests) {\n    const serialized \u003d JSON.stringify(requests);\n    if (serialized \u003d\u003d\u003d lastRequestsSerialized) return;  // no changes ‚Üí do nothing\n    lastRequestsSerialized \u003d serialized;\n\n    const container \u003d document.getElementById(\"container\");\n    container.innerHTML \u003d \"\";\n\n    if (requests.length \u003d\u003d\u003d 0) {\n      container.innerHTML \u003d \"\u003cp\u003eNo active or escalated help requests.\u003c/p\u003e\";\n      return;\n    }\n\n    for (const req of requests) {\n      const div \u003d document.createElement(\"div\");\n      div.className \u003d `request ${req.status}`;\n      div.innerHTML \u003d `\n        \u003cdiv\u003e\u003cstrong\u003e${req.volunteer}\u003c/strong\u003e\u003c/div\u003e\n        \u003cdiv\u003e‚è±Ô∏è ${req.minutesAgo} minutes ago\u003c/div\u003e\n        \u003cdiv\u003eüïí ${req.timestamp}\u003c/div\u003e\n      `;\n      container.appendChild(div);\n    }\n  }\n\n  function renderSummary(data) {\n    const serialized \u003d JSON.stringify(data);\n    if (serialized \u003d\u003d\u003d lastSummarySerialized) return; // unchanged ‚Üí skip\n    lastSummarySerialized \u003d serialized;\n\n    document.getElementById(\"totalCount\").textContent \u003d data.totalCompleted;\n    document.getElementById(\"todayCount\").textContent \u003d data.completedToday;\n\n    const labels \u003d Object.keys(data.hourlyCounts).map(h \u003d\u003e `${h}:00`);\n    const counts \u003d Object.values(data.hourlyCounts);\n\n    const ctx \u003d document.getElementById(\"completionChart\").getContext(\"2d\");\n\n    // If a chart exists, update it instead of creating a new one\n    if (chartInstance) {\n      chartInstance.data.labels \u003d labels;\n      chartInstance.data.datasets[0].data \u003d counts;\n      chartInstance.update();\n    } else {\n      chartInstance \u003d new Chart(ctx, {\n        type: \u0027bar\u0027,\n        data: {\n          labels: labels,\n          datasets: [{\n            label: \"Returns Completed\",\n            data: counts,\n            backgroundColor: \u0027#8e0000\u0027\n          }]\n        },\n        options: {\n          animation: false,\n          scales: {\n            y: {\n              beginAtZero: true,\n              ticks: { stepSize: 1 }\n            }\n          }\n        }\n      });\n    }\n  }\n\n  function refresh() {\n    google.script.run.withSuccessHandler(render).getLiveHelpRequests();\n    google.script.run.withSuccessHandler(renderSummary).getReturnSummary();\n  }\n\n  // Initial load\n  window.addEventListener(\u0027load\u0027, refresh);\n\n  // üîÑ Auto-refresh every 10 seconds\n  setInterval(refresh, 10000);\n\u003c/script\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"}]}