{"files":[{"id":"e20b9641-e154-40b6-82f0-4a20aaf76b1c","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"America/New_York\",\n  \"dependencies\": {},\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\",\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  }\n}"},{"id":"264d914a-40cf-4e80-bb01-fcfd961edcad","name":"Code","type":"server_js","source":"// Entry point to serve the HTML form\nfunction doGet() {\n  return HtmlService.createHtmlOutputFromFile(\u0027form\u0027)\n  .setTitle(\u0027AFSA Tax Clinic Control Sheet\u0027);\n}\n\n// Returns a mapping: Volunteer Name ‚Üí [List of Assigned (but not completed) Clients]\nfunction getVolunteersAndClients() {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const sheet \u003d ss.getSheetByName(\u0027Client Assignment\u0027);\n  const data \u003d sheet.getDataRange().getValues();\n\n  const volunteerToClients \u003d {};\n\n  for (let i \u003d 1; i \u003c data.length; i++) {\n    const volunteer \u003d data[i][2]?.toString().trim(); // Column C\n    const client \u003d data[i][1]?.toString().trim();    // Column B\n    const completed \u003d data[i][3]?.toString().trim(); // Column D\n\n    if (volunteer \u0026\u0026 client \u0026\u0026 (!completed || completed.toLowerCase() !\u003d\u003d \"complete\")) {\n      if (!volunteerToClients[volunteer]) {\n        volunteerToClients[volunteer] \u003d [];\n      }\n      volunteerToClients[volunteer].push(client);\n    }\n  }\n\n  return volunteerToClients;\n}\n\n// Finalizes client and appends per-tax-year data to the tracker\nfunction finalizeReturnsAndStore(volunteer, client, rows) {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n\n  // 1. Mark client as Complete in \u0027Client Assignment\u0027\n  const assignSheet \u003d ss.getSheetByName(\u0027Client Assignment\u0027);\n  const assignData \u003d assignSheet.getDataRange().getValues();\n\n  for (let i \u003d 1; i \u003c assignData.length; i++) {\n    const v \u003d assignData[i][2]?.toString().trim();\n    const c \u003d assignData[i][1]?.toString().trim();\n    if (v \u003d\u003d\u003d volunteer \u0026\u0026 c \u003d\u003d\u003d client) {\n      assignSheet.getRange(i + 1, 4).setValue(\"Complete\"); // Column D\n      break;\n    }\n  }\n\n  // 2. Append tax year data to \u0027Tax Return Tracker\u0027\n  const trackerSheet \u003d ss.getSheetByName(\u0027Tax Return Tracker\u0027);\n  const toAppend \u003d rows.map(r \u003d\u003e [\n    new Date(),                        // Timestamp\n    volunteer,\n    client,\n    r.taxYear,\n    r.reviewer,\n    r.secondaryReviewer ||\"\",\n    r.married ? \"Yes\" : \"No\",\n    r.efile ? \"Yes\" : \"\",\n    r.paper ? \"Yes\" : \"\",\n    r.incomplete ? \"Yes\" : \"\"\n  ]);\n\n  trackerSheet.getRange(\n    trackerSheet.getLastRow() + 1,\n    1,\n    toAppend.length,\n    toAppend[0].length\n  ).setValues(toAppend);\n\n  return true; // spinner can hide after this resolves\n}\n\n// Returns a sorted list of mentor names from \u0027Volunteer List\u0027\nfunction getMentorList() {\n  const sheet \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const volunteerSheet \u003d sheet.getSheetByName(\u0027Volunteer List\u0027);\n  const data \u003d volunteerSheet.getDataRange().getValues();\n\n  const today \u003d new Date();\n  today.setHours(0, 0, 0, 0);\n\n  const mentorsToday \u003d new Set();\n  const seniorMentorsToday \u003d new Set();\n\n  for (let i \u003d 1; i \u003c data.length; i++) {\n    const timestamp \u003d data[i][0]; // Column A: Timestamp\n    const name \u003d data[i][1]?.toString().trim();\n    const role \u003d data[i][2]?.toString().trim().toLowerCase();\n\n    if (name \u0026\u0026 timestamp instanceof Date) {\n      const signedInDate \u003d new Date(timestamp);\n      signedInDate.setHours(0, 0, 0, 0);\n\n      const isToday \u003d signedInDate.getTime() \u003d\u003d\u003d today.getTime();\n\n      if (isToday) {\n        if (role \u003d\u003d\u003d \"mentor\") mentorsToday.add(name);\n        if (role \u003d\u003d\u003d \"senior mentor\") seniorMentorsToday.add(name);\n      }\n    }\n  }\n  const allReviewers \u003d new Set([...mentorsToday, ...seniorMentorsToday]);\n\n  return {\n    reviewers: [...allReviewers].sort(),\n    seniors: [...seniorMentorsToday].sort()\n  };\n}\n\nfunction sendHelpRequest(volunteer) {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const sheet \u003d ss.getSheetByName(\u0027Help Requests\u0027);\n  const data \u003d sheet.getDataRange().getValues();\n\n  let found \u003d false;\n  for (let i \u003d 1; i \u003c data.length; i++) {\n    if (data[i][1] \u003d\u003d\u003d volunteer \u0026\u0026 data[i][2] \u003d\u003d\u003d \"Active\") {\n      found \u003d true;\n      break;\n    }\n  }\n\n  if (!found) {\n    sheet.appendRow([new Date(), volunteer, \"Active\"]);\n  }\n}\n\nfunction clearHelpRequest(volunteer) {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const sheet \u003d ss.getSheetByName(\u0027Help Requests\u0027);\n  const data \u003d sheet.getDataRange().getValues();\n\n  for (let i \u003d 1; i \u003c data.length; i++) {\n    const v \u003d data[i][1]?.toString().trim();\n    const status \u003d data[i][2]?.toString().trim().toLowerCase();\n    if (v \u003d\u003d\u003d volunteer \u0026\u0026 (status \u003d\u003d\u003d \"active\" || status \u003d\u003d\u003d \"escalated\")) {\n      sheet.getRange(i + 1, 3).setValue(\"Cleared\");\n    }\n  }\n}\n\nfunction escalateHelpRequest(volunteer) {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const sheet \u003d ss.getSheetByName(\u0027Help Requests\u0027);\n  const data \u003d sheet.getDataRange().getValues();\n\n  for (let i \u003d 1; i \u003c data.length; i++) {\n    const v \u003d data[i][1]?.toString().trim();\n    const status \u003d data[i][2]?.toString().trim().toLowerCase();\n    if (v \u003d\u003d\u003d volunteer \u0026\u0026 status \u003d\u003d\u003d \"active\") {\n      sheet.getRange(i + 1, 3).setValue(\"Escalated\");\n    }\n  }\n}\n\nfunction getHelpStatus(volunteer) {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const sheet \u003d ss.getSheetByName(\u0027Help Requests\u0027);\n  const data \u003d sheet.getDataRange().getValues();\n\n  for (let i \u003d data.length - 1; i \u003e\u003d 1; i--) {\n    const v \u003d data[i][1]?.toString().trim();\n    const status \u003d data[i][2]?.toString().trim().toLowerCase();\n    if (v \u003d\u003d\u003d volunteer \u0026\u0026 (status \u003d\u003d\u003d \"active\" || status \u003d\u003d\u003d \"escalated\")) {\n      return status;\n    }\n  }\n\n  return \"cleared\"; // no active or escalated row\n}\n\nfunction getClientIntakeInfo(clientID) {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const sheet \u003d ss.getSheetByName(\u0027Client Intake\u0027);\n  const data \u003d sheet.getDataRange().getValues();\n\n  for (let i \u003d 1; i \u003c data.length; i++) {\n    const id \u003d data[i][5]?.toString().trim(); // Column F: Client ID\n    const needsSeniorReview \u003d data[i][6] \u003d\u003d\u003d true || data[i][6]?.toString().toLowerCase() \u003d\u003d\u003d \"true\"; // Column G\n    if (id \u003d\u003d\u003d clientID) {\n      const filingYears \u003d data[i][2]?.toString().split(\u0027,\u0027).map(y \u003d\u003e y.trim());\n      const situations \u003d data[i][3]?.toString().split(\u0027,\u0027).map(s \u003d\u003e s.trim());\n      const notes \u003d data[i][4]?.toString().trim(); // Column E\n      return {\n        filingYears,\n        situations,\n        notes,\n        needsSeniorReview\n      };\n    }\n  }\n  return null;\n}\n\n"},{"id":"c7edcf7d-35e5-4d2c-b8bc-be91b519d584","name":"form","type":"html","source":"\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n  \u003cbase target\u003d\"_top\"\u003e\n  \u003cstyle\u003e\n    :root {\n      --accent-color: rgb(142, 0, 0);\n      --bg-color-light: #ffffff;\n      --text-color-light: #1a1a1a;\n      --input-bg-light: #f2f2f2;\n      --border-light: #ccc;\n\n      --bg-color-dark: #1e1e1e;\n      --text-color-dark: #f0f0f0;\n      --input-bg-dark: #2a2a2a;\n      --border-dark: #444;\n    }\n\n    body.light {\n      background-color: var(--bg-color-light);\n      color: var(--text-color-light);\n    }\n\n    body.dark {\n      background-color: var(--bg-color-dark);\n      color: var(--text-color-dark);\n    }\n\n    body {\n      margin: 0;\n      font-family: \u0027Segoe UI\u0027, Verdana, sans-serif;\n      padding: 20px;\n      transition: background 0.3s, color 0.3s;\n    }\n\n    header {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      margin-bottom: 30px;\n    }\n\n    header h3 {\n      font-family: Verdana, sans-serif;\n      color: var(--accent-color);\n      font-size: 1.5rem;\n      margin: 0;\n    }\n\n    header img {\n      height: 60px;\n    }\n\n    .toggle-theme {\n      cursor: pointer;\n      font-size: 1.4em;\n      margin-left: 10px;\n    }\n\n    .form-row {\n      display: flex;\n      gap: 20px;\n      flex-wrap: wrap;\n      margin-bottom: 20px;\n    }\n\n    label {\n      font-weight: 500;\n    }\n\n    input[list], select {\n      padding: 6px 10px;\n      border-radius: 5px;\n      width: 220px;\n      transition: background 0.3s, color 0.3s, border 0.3s;\n    }\n\n    body.light input[list], body.light select {\n      background-color: var(--input-bg-light);\n      color: var(--text-color-light);\n      border: 1px solid var(--border-light);\n    }\n\n    body.dark input[list], body.dark select {\n      background-color: var(--input-bg-dark);\n      color: var(--text-color-dark);\n      border: 1px solid var(--border-dark);\n    }\n\n    table {\n      width: 100%;\n      border-collapse: collapse;\n      margin-top: 10px;\n    }\n\n    th, td {\n      padding: 10px;\n      text-align: left;\n    }\n\n    body.light th, body.light td {\n      border: 1px solid var(--border-light);\n    }\n\n    body.dark th, body.dark td {\n      border: 1px solid var(--border-dark);\n    }\n\n    th {\n      background-color: #444;\n      color: white;\n    }\n\n    .error-highlight {\n      background-color: #501919 !important;\n    }\n\n    button {\n      padding: 8px 16px;\n      border: none;\n      border-radius: 5px;\n      cursor: pointer;\n      font-weight: 500;\n      background-color: var(--accent-color);\n      color: white;\n      transition: background 0.2s;\n    }\n\n    button:disabled {\n      background-color: #888 !important;\n      cursor: not-allowed;\n    }\n\n    button:hover:not(:disabled) {\n      background-color: #a00000;\n    }\n\n    #messageBox, #errorBox {\n      display: none;\n      padding: 10px;\n      margin: 15px 0;\n      border-radius: 5px;\n    }\n\n    #messageBox {\n      background-color: #27ae60;\n      color: white;\n    }\n\n    #errorBox {\n      background-color: #c0392b;\n      color: white;\n    }\n\n    #confirmModal {\n      display: none;\n      position: fixed;\n      top: 0; left: 0;\n      width: 100%; height: 100%;\n      background: rgba(0, 0, 0, 0.6);\n      z-index: 1000;\n      align-items: center;\n      justify-content: center;\n      animation: fadeIn 0.3s ease-in-out;\n    }\n\n    #confirmModal .modal-content {\n      background-color: #2e2e2e;\n      padding: 20px;\n      border-radius: 10px;\n      width: 300px;\n      text-align: center;\n      color: white;\n      animation: slideIn 0.3s ease;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);\n    }\n\n    @keyframes fadeIn {\n      from { background-color: rgba(0, 0, 0, 0); }\n      to { background-color: rgba(0, 0, 0, 0.6); }\n    }\n\n    @keyframes slideIn {\n      from { transform: scale(0.95); opacity: 0; }\n      to { transform: scale(1); opacity: 1; }\n    }\n\n    #spinner {\n      display: none;\n      margin-top: 10px;\n      text-align: center;\n    }\n\n    .lds-ring {\n      display: inline-block;\n      position: relative;\n      width: 40px;\n      height: 40px;\n    }\n\n    .lds-ring div {\n      box-sizing: border-box;\n      display: block;\n      position: absolute;\n      width: 32px;\n      height: 32px;\n      margin: 4px;\n      border: 4px solid white;\n      border-radius: 50%;\n      animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;\n      border-color: white transparent transparent transparent;\n    }\n\n    .lds-ring div:nth-child(1) { animation-delay: -0.45s; }\n    .lds-ring div:nth-child(2) { animation-delay: -0.3s; }\n    .lds-ring div:nth-child(3) { animation-delay: -0.15s; }\n\n    @keyframes lds-ring {\n      0% { transform: rotate(0deg); }\n      100% { transform: rotate(360deg); }\n    }\n\n    hr {\n      border: 1px solid #333;\n    }\n    #helpBtn {\n      background-color: #cccccc;  /* Neutral gray by default */\n      color: black;\n      padding: 8px 14px;\n      border-radius: 5px;\n      font-weight: bold;\n      border: none;\n      cursor: pointer;\n      transition: background 0.2s ease;\n    }\n\n    #helpBtn:hover {\n      background-color: #b3b3b3;\n    }\n\n    #helpBtn.active {\n      background-color: #f39c12;  /* Bright amber for active state */\n      color: white;\n    }\n    body.light #notesDisplay {\n      background-color: #f2f2f2;\n      color: #1a1a1a;\n    }\n\n    body.dark #notesDisplay {\n      background-color: #2a2a2a;\n      color: #f0f0f0;\n    }\n  \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody class\u003d\"light\" onload\u003d\"loadDropdowns()\"\u003e\n  \u003cheader\u003e\n    \u003ch3\u003eAFSA Tax Clinic Control Sheet\u003c/h3\u003e\n    \u003cdiv\u003e\n      \u003cspan class\u003d\"toggle-theme\" onclick\u003d\"toggleTheme()\"\u003e‚òÄÔ∏è\u003c/span\u003e\n    \u003c/div\u003e\n  \u003c/header\u003e\n\n  \u003cdiv class\u003d\"form-row\"\u003e\n    \u003cdiv\u003e\n      \u003clabel for\u003d\"volunteer\"\u003eVolunteer:\u003c/label\u003e\u003cbr\u003e\n      \u003cinput id\u003d\"volunteer\" list\u003d\"volunteerList\" placeholder\u003d\"Start typing volunteer name\" oninput\u003d\"updateClients(); checkFormReady();\"\u003e\n      \u003cdatalist id\u003d\"volunteerList\"\u003e\u003c/datalist\u003e\n    \u003c/div\u003e\n    \u003cdiv\u003e\n      \u003clabel for\u003d\"client\"\u003eAssigned Client:\u003c/label\u003e\u003cbr\u003e\n      \u003cselect id\u003d\"client\" onchange\u003d\"checkFormReady();\"\u003e\n        \u003coption value\u003d\"\"\u003eSelect Client\u003c/option\u003e\n      \u003c/select\u003e\n    \u003c/div\u003e\n    \u003cdiv style\u003d\"align-self: end; margin-top: 20px;\"\u003e\n      \u003cbutton id\u003d\"helpBtn\" onclick\u003d\"toggleHelpRequest()\"\u003eüìû Quick Question!/Review\u003c/button\u003e\n      \u003cbutton id\u003d\"escalateBtn\" onclick\u003d\"escalateHelpRequest()\" style\u003d\"display: none;\"\u003eüö® Escalate to Senior Mentor\u003c/button\u003e\n    \u003c/div\u003e\n\u003c/div\u003e\n    \u003cdiv id\u003d\"notesContainer\" style\u003d\"display: none; margin-top: 10px;\"\u003e\n      \u003cstrong\u003eNotes from Reception:\u003c/strong\u003e\n      \u003cdiv id\u003d\"notesDisplay\" style\u003d\"margin-top: 4px; padding: 8px; border-radius: 5px; font-style: italic;\"\u003e\u003c/div\u003e\n    \u003c/div\u003e\n  \u003chr\u003e\n\n  \u003ch3\u003eTax Year Details\u003c/h3\u003e\n  \u003ctable id\u003d\"taxYearTable\"\u003e\n    \u003ctr\u003e\n      \u003cth\u003eTax Year\u003c/th\u003e\n      \u003cth\u003eReviewer\u003c/th\u003e\n      \u003cth\u003eMarried/Common-Law\u003c/th\u003e\n      \u003cth\u003eFiling Status\u003c/th\u003e\n      \u003cth\u003eRemove\u003c/th\u003e\n    \u003c/tr\u003e\n  \u003c/table\u003e\n\n  \u003cbr\u003e\n  \u003cbutton onclick\u003d\"addTaxYearRow()\"\u003eAdd Additional Tax Year\u003c/button\u003e\n  \u003cbr\u003e\u003cbr\u003e\n\n  \u003cdiv id\u003d\"messageBox\"\u003e\u003c/div\u003e\n  \u003cdiv id\u003d\"errorBox\"\u003e\u003c/div\u003e\n  \u003cdiv id\u003d\"spinner\"\u003e\u003cdiv class\u003d\"lds-ring\"\u003e\u003cdiv\u003e\u003c/div\u003e\u003cdiv\u003e\u003c/div\u003e\u003cdiv\u003e\u003c/div\u003e\u003cdiv\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\n\n  \u003cbutton id\u003d\"finalizeBtn\" onclick\u003d\"finalizeReturns()\" disabled\u003eFinalize Returns\u003c/button\u003e\n\n  \u003c!-- Modal --\u003e\n  \u003cdiv id\u003d\"confirmModal\"\u003e\n    \u003cdiv class\u003d\"modal-content\"\u003e\n      \u003cp\u003eAre you sure you\u0027d like to finalize?\u003cbr\u003eHave all returns been finalized/EFILEd at this point?\u003c/p\u003e\n      \u003cbutton onclick\u003d\"proceedFinalize()\"\u003eYes, finalize\u003c/button\u003e\n      \u003cbutton onclick\u003d\"closeModal()\"\u003eCancel\u003c/button\u003e\n    \u003c/div\u003e\n  \u003c/div\u003e\n\n  \u003cscript defer\u003e\n    let volunteerMap \u003d {};\n    let rowCount \u003d 1;\n\n    function toggleTheme() {\n      const body \u003d document.body;\n      const toggle \u003d document.querySelector(\u0027.toggle-theme\u0027);\n      if (body.classList.contains(\u0027dark\u0027)) {\n        body.classList.replace(\u0027dark\u0027, \u0027light\u0027);\n        toggle.textContent \u003d \u0027‚òÄÔ∏è\u0027;\n      } else {\n        body.classList.replace(\u0027light\u0027, \u0027dark\u0027);\n        toggle.textContent \u003d \u0027üåô\u0027;\n      }\n    }\n\n    function checkFormReady() {\n      const volunteer \u003d document.getElementById(\u0027volunteer\u0027).value.trim();\n      const client \u003d document.getElementById(\u0027client\u0027).value.trim();\n      document.getElementById(\u0027finalizeBtn\u0027).disabled \u003d !(volunteer \u0026\u0026 client);\n    }\n\n    function loadDropdowns() {\n      google.script.run.withSuccessHandler(data \u003d\u003e {\n        volunteerMap \u003d data;\n        const datalist \u003d document.getElementById(\u0027volunteerList\u0027);\n        datalist.innerHTML \u003d \u0027\u0027; // Clear existing\n        Object.keys(volunteerMap).sort().forEach(name \u003d\u003e {\n          const option \u003d document.createElement(\u0027option\u0027);\n          option.value \u003d name;\n          datalist.appendChild(option);\n        });\n        checkFormReady();\n      }).getVolunteersAndClients();\n      setInterval(pollHelpStatus, 10000);\n      document.getElementById(\u0027volunteer\u0027).focus();\n    }\n\n    function updateClients() {\n      const volunteer \u003d document.getElementById(\u0027volunteer\u0027).value;\n      const clientSelect \u003d document.getElementById(\u0027client\u0027);\n      clientSelect.innerHTML \u003d \u0027\u003coption value\u003d\"\"\u003eSelect Client\u003c/option\u003e\u0027;\n\n      if (volunteerMap[volunteer]) {\n        volunteerMap[volunteer].forEach(client \u003d\u003e {\n          const option \u003d document.createElement(\u0027option\u0027);\n          option.value \u003d client;\n          option.textContent \u003d client;\n          clientSelect.appendChild(option);\n        });\n      }\n\n      // Clear tax year table\n      const table \u003d document.getElementById(\u0027taxYearTable\u0027);\n      while (table.rows.length \u003e 1) table.deleteRow(1);\n      rowCount \u003d 1;\n    }\n\n    document.getElementById(\u0027client\u0027).addEventListener(\u0027change\u0027, function () {\n      const clientID \u003d this.value;\n      if (!clientID) {\n        document.getElementById(\u0027notesContainer\u0027).style.display \u003d \u0027none\u0027;\n        return;\n      }\n\n      google.script.run.withSuccessHandler(data \u003d\u003e {\n        preloadTaxYearRows(data);\n        if (data \u0026\u0026 data.notes) {\n          document.getElementById(\u0027notesDisplay\u0027).textContent \u003d data.notes;\n          document.getElementById(\u0027notesContainer\u0027).style.display \u003d \u0027block\u0027;\n        } else {\n          document.getElementById(\u0027notesDisplay\u0027).textContent \u003d \u0027\u0027;\n          document.getElementById(\u0027notesContainer\u0027).style.display \u003d \u0027none\u0027;\n        }\n      }).getClientIntakeInfo(clientID);\n    });\n\n    function addTaxYearRow() {\n      google.script.run.withSuccessHandler(data \u003d\u003e {\n        const reviewerOptions \u003d data.reviewers;\n        const seniorOptions \u003d data.seniors;\n\n        const table \u003d document.getElementById(\u0027taxYearTable\u0027);\n        const row \u003d table.insertRow();\n        const taxYearOptions \u003d Array.from({ length: 16 }, (_, i) \u003d\u003e (2025 - i).toString());\n\n        row.innerHTML \u003d `\n          \u003ctd\u003e\n            \u003cselect name\u003d\"taxYear\"\u003e\n              ${taxYearOptions.map(y \u003d\u003e `\u003coption value\u003d\"${y}\" ${y \u003d\u003d\u003d \u00272024\u0027 ? \u0027selected\u0027 : \u0027\u0027}\u003e${y}\u003c/option\u003e`).join(\u0027\u0027)}\n            \u003c/select\u003e\n          \u003c/td\u003e\n          \u003ctd\u003e\n            \u003cinput list\u003d\"reviewerList${rowCount}\" name\u003d\"reviewer\" placeholder\u003d\"Start typing reviewer\"\u003e\n            \u003cdatalist id\u003d\"reviewerList${rowCount}\"\u003e\n              ${reviewerOptions.map(r \u003d\u003e `\u003coption value\u003d\"${r}\"\u003e`).join(\u0027\u0027)}\n            \u003c/datalist\u003e\n            ${needsSeniorReview ? `\n              \u003cbr\u003e\n              \u003cinput list\u003d\"reviewerList${rowCount}_secondary\" name\u003d\"secondaryReviewer\" placeholder\u003d\"Start typing Senior reviewer\"\u003e\n              \u003cdatalist id\u003d\"reviewerList${rowCount}_secondary\"\u003e\n                ${seniorOptions.map(r \u003d\u003e `\u003coption value\u003d\"${r}\"\u003e`).join(\u0027\u0027)}\n              \u003c/datalist\u003e\n            ` : \u0027\u0027}\n          \u003c/td\u003e\n          \u003ctd\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"married\" ${isMarried ? \"checked\" : \"\"}\u003e\u003c/td\u003e\n          \u003ctd\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"filingStatus${rowCount}\" value\u003d\"efile\"\u003e EFILE\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"filingStatus${rowCount}\" value\u003d\"paper\"\u003e Paper\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"filingStatus${rowCount}\" value\u003d\"incomplete\"\u003e Incomplete\u003c/label\u003e\n          \u003c/td\u003e\n          \u003ctd\u003e\u003cbutton onclick\u003d\"removeRow(this)\"\u003eRemove\u003c/button\u003e\u003c/td\u003e\n        `;\n        rowCount++;\n      }).getMentorList();\n    }\n\n    function pollHelpStatus() {\n      const volunteer \u003d document.getElementById(\u0027volunteer\u0027).value;\n      if (!volunteer) return;\n\n      google.script.run.withSuccessHandler(status \u003d\u003e {\n        const helpBtn \u003d document.getElementById(\u0027helpBtn\u0027);\n        const escalateBtn \u003d document.getElementById(\u0027escalateBtn\u0027);\n\n        if (status \u003d\u003d\u003d \"active\" || status \u003d\u003d\u003d \"escalated\") {\n          helpActive \u003d true;\n          helpBtn.textContent \u003d \u0027‚úÖ Cancel Call\u0027;\n          helpBtn.classList.add(\u0027active\u0027);\n          escalateBtn.style.display \u003d \u0027inline-block\u0027;\n          escalateBtn.disabled \u003d (status \u003d\u003d\u003d \"escalated\");\n        } else {\n          helpActive \u003d false;\n          helpBtn.textContent \u003d \u0027üìû Quick Question!/Review\u0027;\n          helpBtn.classList.remove(\u0027active\u0027);\n          escalateBtn.style.display \u003d \u0027none\u0027;\n        }\n      }).getHelpStatus(volunteer);\n    }\n\n    // Poll every 10 seconds\n\n    function finalizeReturns() {\n      const volunteer \u003d document.getElementById(\u0027volunteer\u0027).value;\n      const client \u003d document.getElementById(\u0027client\u0027).value;\n      if (!volunteer || !client) {\n        showError(\u0027Please select both a volunteer and a client.\u0027);\n        return;\n      }\n      document.getElementById(\u0027confirmModal\u0027).style.display \u003d \u0027flex\u0027;\n    }\n\n    function proceedFinalize() {\n      closeModal();\n      document.getElementById(\u0027spinner\u0027).style.display \u003d \u0027block\u0027;\n\n      const volunteer \u003d document.getElementById(\u0027volunteer\u0027).value;\n      const client \u003d document.getElementById(\u0027client\u0027).value;\n      const rows \u003d [];\n      const taxYears \u003d new Set();\n      const table \u003d document.getElementById(\u0027taxYearTable\u0027);\n\n      for (let i \u003d 1; i \u003c table.rows.length; i++) {\n        const row \u003d table.rows[i];\n        row.classList.remove(\"error-highlight\");\n\n        const taxYear \u003d row.querySelector(\u0027select[name\u003d\"taxYear\"]\u0027).value;\n        const reviewer \u003d row.querySelector(\u0027input[name\u003d\"reviewer\"]\u0027).value.trim();\n        const secondaryReviewer \u003d row.querySelector(\u0027input[name\u003d\"secondaryReviewer\"]\u0027)?.value.trim() || \"\";\n        const married \u003d row.querySelector(\u0027input[name\u003d\"married\"]\u0027).checked;\n        const statusGroup \u003d row.querySelectorAll(`input[name\u003d\"filingStatus${i}\"]`);\n        let selectedStatus \u003d \"\";\n        statusGroup.forEach(r \u003d\u003e { if (r.checked) selectedStatus \u003d r.value; });\n\n        if (!reviewer || !selectedStatus || taxYears.has(taxYear)) {\n          row.classList.add(\"error-highlight\");\n          showError(`Please correct tax year ${taxYear}.`);\n          document.getElementById(\u0027spinner\u0027).style.display \u003d \u0027none\u0027;\n          return;\n        }\n\n        taxYears.add(taxYear);\n        rows.push({\n          taxYear,\n          reviewer,\n          secondaryReviewer,\n          married,\n          efile: selectedStatus \u003d\u003d\u003d \"efile\",\n          paper: selectedStatus \u003d\u003d\u003d \"paper\",\n          incomplete: selectedStatus \u003d\u003d\u003d \"incomplete\"\n        });\n      }\n\n      google.script.run.withSuccessHandler(success \u003d\u003e {\n        document.getElementById(\u0027spinner\u0027).style.display \u003d \u0027none\u0027;\n        if (success) {\n          showMessage(\u0027Returns finalized. Please direct client to exit receptionist.\u0027, true);\n          loadDropdowns();\n          setTimeout(clearForm, 5000);\n        } else {\n          showError(\u0027Could not finalize. Please try again.\u0027);\n        }\n      }).finalizeReturnsAndStore(volunteer, client, rows);\n    }\n\n    function closeModal() {\n      document.getElementById(\u0027confirmModal\u0027).style.display \u003d \u0027none\u0027;\n    }\n\n    function showError(message) {\n      const box \u003d document.getElementById(\u0027errorBox\u0027);\n      box.textContent \u003d message;\n      box.style.display \u003d \u0027block\u0027;\n      setTimeout(() \u003d\u003e box.style.display \u003d \u0027none\u0027, 5000);\n    }\n\n    function showMessage(message, success \u003d false) {\n      const box \u003d document.getElementById(\u0027messageBox\u0027);\n      box.textContent \u003d message;\n      box.style.backgroundColor \u003d success ? \u0027#27ae60\u0027 : \u0027#c0392b\u0027;\n      box.style.display \u003d \u0027block\u0027;\n      setTimeout(() \u003d\u003e box.style.display \u003d \u0027none\u0027, 5000);\n    }\n\n    function clearForm() {\n      document.getElementById(\u0027volunteer\u0027).value \u003d \u0027\u0027;\n      document.getElementById(\u0027client\u0027).innerHTML \u003d \u0027\u003coption value\u003d\"\"\u003eSelect Client\u003c/option\u003e\u0027;\n      const table \u003d document.getElementById(\u0027taxYearTable\u0027);\n      while (table.rows.length \u003e 1) table.deleteRow(1);\n      rowCount \u003d 1;\n    }\n\n    function removeRow(button) {\n      const row \u003d button.closest(\u0027tr\u0027);\n      row.remove();\n    }\n\n    let helpActive \u003d false;\n    function toggleHelpRequest() {\n      const volunteer \u003d document.getElementById(\u0027volunteer\u0027).value;\n      const helpBtn \u003d document.getElementById(\u0027helpBtn\u0027);\n      const escalateBtn \u003d document.getElementById(\u0027escalateBtn\u0027);\n\n      if (!volunteer) {\n        showError(\u0027Please select a volunteer before calling for help.\u0027);\n        return;\n      }\n\n      helpActive \u003d !helpActive;\n\n      if (helpActive) {\n        google.script.run.withSuccessHandler(() \u003d\u003e {\n          showMessage(\u0027Help request sent.\u0027);\n          helpBtn.textContent \u003d \u0027‚úÖ Cancel Call\u0027;\n          helpBtn.classList.add(\u0027active\u0027);\n          escalateBtn.style.display \u003d \u0027inline-block\u0027;  // Show escalate button\n          escalateBtn.disabled \u003d false; // Enable it\n        }).sendHelpRequest(volunteer);\n      } else {\n        google.script.run.withSuccessHandler(() \u003d\u003e {\n          showMessage(\u0027Help request cleared.\u0027);\n          helpBtn.textContent \u003d \u0027üìû Call for Help\u0027;\n          helpBtn.classList.remove(\u0027active\u0027);\n          escalateBtn.style.display \u003d \u0027none\u0027;          // Hide on cancel\n        }).clearHelpRequest(volunteer);\n      }\n    }\n    function escalateHelpRequest() {\n      const volunteer \u003d document.getElementById(\u0027volunteer\u0027).value;\n      const escalateBtn \u003d document.getElementById(\u0027escalateBtn\u0027);\n\n      if (!volunteer) {\n        showError(\u0027Please select a volunteer before escalating.\u0027);\n        return;\n      }\n\n      google.script.run.withSuccessHandler(() \u003d\u003e {\n        showMessage(`Help request escalated for ${volunteer}.`);\n        escalateBtn.disabled \u003d true;\n      }).escalateHelpRequest(volunteer);\n    }\n    function preloadTaxYearRows(data) {\n      if (!data || !data.filingYears || data.filingYears.length \u003d\u003d\u003d 0) return;\n\n      // Reset current rows\n      const table \u003d document.getElementById(\u0027taxYearTable\u0027);\n      while (table.rows.length \u003e 1) table.deleteRow(1);\n      rowCount \u003d 1;\n\n      const isMarried \u003d data.situations?.includes(\"Married/Common-Law\");\n      const needsSeniorReview \u003d data?.needsSeniorReview \u003d\u003d\u003d true;\n      // Fetch mentor list first\n        google.script.run.withSuccessHandler(data \u003d\u003e {\n          const reviewerOptions \u003d data.reviewers;\n          const seniorOptions \u003d data.seniors;\n\n          const table \u003d document.getElementById(\u0027taxYearTable\u0027);\n          const row \u003d table.insertRow();\n          const taxYearOptions \u003d Array.from({ length: 16 }, (_, i) \u003d\u003e (2025 - i).toString());\n\n          row.innerHTML \u003d `\n            \u003ctd\u003e\n              \u003cselect name\u003d\"taxYear\"\u003e\n                ${taxYearOptions.map(y \u003d\u003e `\u003coption value\u003d\"${y}\" ${y \u003d\u003d\u003d \u00272024\u0027 ? \u0027selected\u0027 : \u0027\u0027}\u003e${y}\u003c/option\u003e`).join(\u0027\u0027)}\n              \u003c/select\u003e\n            \u003c/td\u003e\n            \u003ctd\u003e\n              \u003cinput list\u003d\"reviewerList${rowCount}\" name\u003d\"reviewer\" placeholder\u003d\"Start typing reviewer\"\u003e\n              \u003cdatalist id\u003d\"reviewerList${rowCount}\"\u003e\n                ${reviewerOptions.map(r \u003d\u003e `\u003coption value\u003d\"${r}\"\u003e`).join(\u0027\u0027)}\n              \u003c/datalist\u003e\n              ${needsSeniorReview ? `\n                \u003cbr\u003e\n                \u003cinput list\u003d\"reviewerList${rowCount}_secondary\" name\u003d\"secondaryReviewer\" placeholder\u003d\"Start typing Senior reviewer\"\u003e\n                \u003cdatalist id\u003d\"reviewerList${rowCount}_secondary\"\u003e\n                  ${seniorOptions.map(r \u003d\u003e `\u003coption value\u003d\"${r}\"\u003e`).join(\u0027\u0027)}\n                \u003c/datalist\u003e\n              ` : \u0027\u0027}\n            \u003c/td\u003e\n            \u003ctd\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"married\"\u003e\u003c/td\u003e\n            \u003ctd\u003e\n              \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"filingStatus${rowCount}\" value\u003d\"efile\"\u003e EFILE\u003c/label\u003e\n              \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"filingStatus${rowCount}\" value\u003d\"paper\"\u003e Paper\u003c/label\u003e\n              \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"filingStatus${rowCount}\" value\u003d\"incomplete\"\u003e Incomplete\u003c/label\u003e\n            \u003c/td\u003e\n            \u003ctd\u003e\u003cbutton onclick\u003d\"removeRow(this)\"\u003eRemove\u003c/button\u003e\u003c/td\u003e\n          `;\n          rowCount++;\n        }).getMentorList();\n    }\n  \u003c/script\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"}]}