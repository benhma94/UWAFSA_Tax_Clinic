{"files":[{"id":"9f4a8710-b653-4b49-abfd-db15910ac35c","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"America/New_York\",\n  \"dependencies\": {},\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\",\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  }\n}"},{"id":"45d7533c-09bd-4e44-a04e-5c4d8817581a","name":"AdminDashboard","type":"server_js","source":"/**\n * Admin Dashboard Functions\n * Functions for the admin dashboard\n */\n\n/**\n * Gets return completion summary\n * @returns {Object} Summary with totalCompleted, completedToday, and hourlyCounts\n */\nfunction getReturnSummary() {\n  return safeExecute(() \u003d\u003e {\n    const sheet \u003d getSheet(CONFIG.SHEETS.TAX_RETURN_TRACKER);\n    const data \u003d sheet.getDataRange().getValues();\n    const today \u003d new Date();\n    const timezone \u003d Session.getScriptTimeZone();\n    \n    let totalCompleted \u003d 0;\n    let completedToday \u003d 0;\n    const hourlyCounts \u003d {};\n    \n    for (let i \u003d 1; i \u003c data.length; i++) {\n      const row \u003d data[i];\n      const timestamp \u003d row[CONFIG.COLUMNS.TAX_RETURN_TRACKER.TIMESTAMP];\n      const efile \u003d row[CONFIG.COLUMNS.TAX_RETURN_TRACKER.EFILE]?.toString().toLowerCase() \u003d\u003d\u003d \u0027yes\u0027;\n      const paper \u003d row[CONFIG.COLUMNS.TAX_RETURN_TRACKER.PAPER]?.toString().toLowerCase() \u003d\u003d\u003d \u0027yes\u0027;\n      \n      if (efile || paper) {\n        totalCompleted++;\n        \n        const ts \u003d new Date(timestamp);\n        const sameDay \u003d ts.getFullYear() \u003d\u003d\u003d today.getFullYear() \u0026\u0026\n                       ts.getMonth() \u003d\u003d\u003d today.getMonth() \u0026\u0026\n                       ts.getDate() \u003d\u003d\u003d today.getDate();\n        \n        if (sameDay) {\n          completedToday++;\n          \n          const hour \u003d ts.getHours();\n          hourlyCounts[hour] \u003d (hourlyCounts[hour] || 0) + 1;\n        }\n      }\n    }\n    \n    return {\n      totalCompleted,\n      completedToday,\n      hourlyCounts\n    };\n  }, \u0027getReturnSummary\u0027);\n}\n"},{"id":"8196c778-efb6-4702-b263-20f32a48c741","name":"AdminDashboardApp","type":"server_js","source":"/**\n * Admin Dashboard App Entry Point\n * This is the entry point for the Admin Dashboard web app deployment\n */\n\n/**\n * Entry point for Admin Dashboard web app\n * @returns {HtmlOutput} The HTML output for the admin dashboard\n */\nfunction doGetAdminDashboard() {\n  return HtmlService.createHtmlOutputFromFile(\u0027admin_dashboard\u0027)\n    .setTitle(\u0027Live Help Request Dashboard\u0027)\n    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);\n}\n"},{"id":"212d4da7-c716-42bd-9051-e24c294dfabd","name":"ClientIntake","type":"server_js","source":"/**\n * Client Intake Functions\n * Functions specific to the client intake process\n */\n\n/**\n * Stores main form data and generates client ID\n * Uses LockService to prevent race conditions when multiple receptionists submit simultaneously\n * @param {Object} formData - Form data object\n * @returns {string} Generated client ID\n */\nfunction storeMainFormData(formData) {\n  return safeExecute(() \u003d\u003e {\n    // Validate input\n    if (!formData || !formData.filingYears || formData.filingYears.length \u003d\u003d\u003d 0) {\n      throw new Error(\u0027At least one filing year is required\u0027);\n    }\n    \n    // Use LockService to serialize ID generation and prevent race conditions\n    const lock \u003d LockService.getScriptLock();\n    \n    try {\n      // Try to acquire lock with 10 second timeout\n      if (!lock.tryLock(10000)) {\n        throw new Error(\u0027System is busy generating client ID. Please try again.\u0027);\n      }\n      \n      const sheet \u003d getSheet(CONFIG.SHEETS.CLIENT_INTAKE);\n      \n      // Get last row to optimize - only read what we need\n      const lastRow \u003d sheet.getLastRow();\n      const clientIdCol \u003d CONFIG.COLUMNS.CLIENT_INTAKE.CLIENT_ID + 1;\n      \n      // Only read rows that have data (optimization: don\u0027t read entire sheet)\n      const numRows \u003d lastRow \u003e 1 ? lastRow - 1 : 0;\n      if (numRows \u003e 0) {\n        const allData \u003d sheet.getRange(2, clientIdCol, numRows, 1).getValues();\n        const idMap \u003d {};\n        \n        for (let row of allData) {\n          if (!row[0]) continue; // skip blank\n          let entry \u003d row[0].toString().trim();\n          if (validateClientID(entry)) {\n            const letter \u003d entry[0];\n            const num \u003d parseInt(entry.substring(1));\n            if (!idMap[letter]) idMap[letter] \u003d new Set();\n            idMap[letter].add(num);\n          }\n        }\n        \n        // Generate next available ID safely\n        let letter \u003d \u0027A\u0027;\n        while (true) {\n          let usedNums \u003d idMap[letter] || new Set();\n          let num \u003d 1;\n          while (usedNums.has(num)) num++;\n          \n          if (num \u003c\u003d 999) {\n            var clientID \u003d `${letter}${String(num).padStart(3, \u00270\u0027)}`;\n            break;\n          }\n          \n          // If we run out of numbers, move to next letter\n          letter \u003d String.fromCharCode(letter.charCodeAt(0) + 1);\n          if (letter \u003e \u0027Z\u0027) {\n            throw new Error(\u0027Client ID limit reached (A-Z999)\u0027);\n          }\n        }\n      } else {\n        // First client - start with A001\n        var clientID \u003d \u0027A001\u0027;\n      }\n      \n      // Append the row\n      sheet.appendRow([\n        new Date(),\n        formData.householdsize,\n        formData.filingYears.join(\u0027, \u0027),\n        formData.situations.join(\u0027, \u0027),\n        formData.notes || \u0027\u0027,\n        clientID,\n        formData.needsSeniorReview || false\n      ]);\n      \n      logAudit(\u0027Client Intake Created\u0027, `Client ID: ${clientID}`, Session.getActiveUser().getEmail());\n      return clientID;\n    } finally {\n      // Always release the lock\n      lock.releaseLock();\n    }\n  }, \u0027storeMainFormData\u0027);\n}\n\n/**\n * Submits initial client intake eligibility data\n * @param {Object} data - Eligibility form data\n * @returns {boolean} True if successful\n */\nfunction submitClientIntake(data) {\n  return safeExecute(() \u003d\u003e {\n    const sheet \u003d getSheet(CONFIG.SHEETS.CLIENT_INTAKE);\n    \n    const row \u003d [\n      new Date(),\n      data.tuition || \u0027\u0027,\n      data.incomeLimit || \u0027\u0027,\n      data.documentsReady || \u0027\u0027,\n      data.selfEmployment || \u0027\u0027,\n      data.bankruptcyOrDeceased || \u0027\u0027,\n      data.rentalOrGains || \u0027\u0027,\n      data.foreignProperty || \u0027\u0027,\n      data.householdCount || \u0027\u0027,\n      data.yearsNeeded || \u0027\u0027,\n      data.specialSituations || \u0027\u0027,\n      data.ticketNumber || \u0027\u0027,\n      data.allPresent || \u0027\u0027,\n      data.needsReview || false\n    ];\n    \n    sheet.appendRow(row);\n    logAudit(\u0027Client Intake Eligibility Submitted\u0027, `Ticket: ${data.ticketNumber || \u0027N/A\u0027}`);\n    return true;\n  }, \u0027submitClientIntake\u0027);\n}\n"},{"id":"23910fa1-15b9-4473-9b7a-6a9337e68a02","name":"ClientIntakeApp","type":"server_js","source":"/**\n * Client Intake App Entry Point\n * This is the entry point for the Client Intake web app deployment\n */\n\n/**\n * Entry point for Client Intake web app\n * @returns {HtmlOutput} The HTML output for the intake form\n */\nfunction doGetClientIntake() {\n  return HtmlService.createHtmlOutputFromFile(\u0027catbus_intake_form\u0027)\n    .setTitle(\u0027AFSA Tax Clinic Intake Form\u0027)\n    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);\n}\n"},{"id":"7680009a-4a2e-4789-81a5-9f9c4eea1abf","name":"Config","type":"server_js","source":"/**\n * CATBUS Configuration\n * Centralized configuration for all CATBUS scripts\n */\n\nconst CONFIG \u003d {\n  // Spreadsheet ID - Update this if you need to change spreadsheets\n  SPREADSHEET_ID: \u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027,\n  \n  // Sheet Names\n  SHEETS: {\n    CLIENT_INTAKE: \u0027Client Intake\u0027,\n    CLIENT_ASSIGNMENT: \u0027Client Assignment\u0027,\n    HELP_REQUESTS: \u0027Help Requests\u0027,\n    TAX_RETURN_TRACKER: \u0027Tax Return Tracker\u0027,\n    VOLUNTEER_LIST: \u0027Volunteer List\u0027,\n    SIGNOUT: \u0027SignOut\u0027\n  },\n  \n  // Column Mappings (0-indexed)\n  COLUMNS: {\n    CLIENT_INTAKE: {\n      TIMESTAMP: 0,\n      HOUSEHOLD_SIZE: 1,\n      FILING_YEARS: 2,\n      SITUATIONS: 3,\n      NOTES: 4,\n      CLIENT_ID: 5,\n      NEEDS_SENIOR_REVIEW: 6\n    },\n    CLIENT_ASSIGNMENT: {\n      TIMESTAMP: 0,\n      CLIENT_ID: 1,\n      VOLUNTEER: 2,\n      COMPLETED: 3\n    },\n    HELP_REQUESTS: {\n      TIMESTAMP: 0,\n      VOLUNTEER: 1,\n      STATUS: 2\n    },\n    TAX_RETURN_TRACKER: {\n      TIMESTAMP: 0,\n      VOLUNTEER: 1,\n      CLIENT_ID: 2,\n      TAX_YEAR: 3,\n      REVIEWER: 4,\n      SECONDARY_REVIEWER: 5,\n      MARRIED: 6,\n      EFILE: 7,\n      PAPER: 8,\n      INCOMPLETE: 9\n    }\n  },\n  \n  // Help Request Status Values\n  HELP_STATUS: {\n    ACTIVE: \u0027Active\u0027,\n    ESCALATED: \u0027Escalated\u0027,\n    CLEARED: \u0027Cleared\u0027\n  },\n  \n  // Timezone\n  TIMEZONE: \u0027America/New_York\u0027\n};\n\n/**\n * Get the main spreadsheet\n * @returns {Spreadsheet} The spreadsheet object\n */\nfunction getSpreadsheet() {\n  return SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);\n}\n\n/**\n * Get a specific sheet by name\n * @param {string} sheetName - Name of the sheet\n * @returns {Sheet} The sheet object\n */\nfunction getSheet(sheetName) {\n  const ss \u003d getSpreadsheet();\n  const sheet \u003d ss.getSheetByName(sheetName);\n  if (!sheet) {\n    throw new Error(`Sheet \"${sheetName}\" not found`);\n  }\n  return sheet;\n}\n"},{"id":"74d0b013-9d72-4b97-9ea4-79aae19507b3","name":"ControlSheet","type":"server_js","source":"/**\n * Utility Functions\n * Shared utility functions for error handling, validation, etc.\n */\n\n/**\n * Wraps a function in error handling with retry logic for rate limits\n * @param {Function} operation - The function to execute\n * @param {string} context - Context description for logging\n * @param {number} maxRetries - Maximum number of retries (default: 3)\n * @returns {*} The result of the operation\n */\nfunction safeExecute(operation, context \u003d \u0027Operation\u0027, maxRetries \u003d 3) {\n  let lastError;\n  \n  for (let attempt \u003d 0; attempt \u003c maxRetries; attempt++) {\n    try {\n      return operation();\n    } catch (error) {\n      lastError \u003d error;\n      const errorMsg \u003d error.message || error.toString();\n      \n      // Check if it\u0027s a rate limit or quota error\n      const isRateLimit \u003d errorMsg.toLowerCase().includes(\u0027rate\u0027) || \n                         errorMsg.toLowerCase().includes(\u0027quota\u0027) ||\n                         errorMsg.toLowerCase().includes(\u0027too many\u0027) ||\n                         errorMsg.toLowerCase().includes(\u0027service invoked\u0027);\n      \n      if (isRateLimit \u0026\u0026 attempt \u003c maxRetries - 1) {\n        // Exponential backoff: 100ms, 200ms, 400ms\n        const delay \u003d 100 * Math.pow(2, attempt);\n        Logger.log(`${context} Rate limit hit, retrying in ${delay}ms (attempt ${attempt + 1}/${maxRetries})`);\n        Utilities.sleep(delay);\n        continue;\n      }\n      \n      // Not a rate limit error, or max retries reached\n      Logger.log(`${context} Error: ${errorMsg}`);\n      Logger.log(`Stack: ${error.stack}`);\n      \n      // Translate to user-friendly error\n      throw translateError(error, context);\n    }\n  }\n  \n  // If we get here, all retries failed\n  Logger.log(`${context} Failed after ${maxRetries} attempts`);\n  throw translateError(lastError, context);\n}\n\n/**\n * Translates technical errors to user-friendly messages\n * @param {Error} error - The error object\n * @param {string} context - Context description\n * @returns {Error} User-friendly error\n */\nfunction translateError(error, context \u003d \u0027Operation\u0027) {\n  const errorMsg \u003d error.message || error.toString();\n  const lowerMsg \u003d errorMsg.toLowerCase();\n  \n  // Rate limit errors\n  if (lowerMsg.includes(\u0027rate\u0027) || lowerMsg.includes(\u0027quota\u0027) || \n      lowerMsg.includes(\u0027too many\u0027) || lowerMsg.includes(\u0027service invoked\u0027)) {\n    return new Error(\u0027The system is busy right now. Please try again in a moment.\u0027);\n  }\n  \n  // Not found errors\n  if (lowerMsg.includes(\u0027not found\u0027) || lowerMsg.includes(\u0027does not exist\u0027)) {\n    if (lowerMsg.includes(\u0027client\u0027)) {\n      return new Error(\u0027Client ID not found. Please check the ID and try again.\u0027);\n    }\n    return new Error(\u0027The requested information was not found. Please try again.\u0027);\n  }\n  \n  // Already assigned/duplicate errors\n  if (lowerMsg.includes(\u0027already assigned\u0027) || lowerMsg.includes(\u0027already exists\u0027)) {\n    if (lowerMsg.includes(\u0027client\u0027)) {\n      const match \u003d errorMsg.match(/already assigned to (.+)/i);\n      if (match) {\n        return new Error(`This client has already been assigned to ${match[1]}.`);\n      }\n      return new Error(\u0027This client has already been assigned to another volunteer.\u0027);\n    }\n    return new Error(\u0027This item already exists. Please check and try again.\u0027);\n  }\n  \n  // Validation errors\n  if (lowerMsg.includes(\u0027invalid\u0027) || lowerMsg.includes(\u0027required\u0027)) {\n    return new Error(errorMsg); // Keep validation messages as-is (they\u0027re usually clear)\n  }\n  \n  // Lock timeout errors\n  if (lowerMsg.includes(\u0027busy generating\u0027) || lowerMsg.includes(\u0027lock\u0027)) {\n    return new Error(\u0027The system is busy processing another request. Please try again in a moment.\u0027);\n  }\n  \n  // Generic fallback - keep original message but make it more user-friendly\n  if (errorMsg.startsWith(context)) {\n    return error; // Already has context\n  }\n  \n  return new Error(`${context} failed. Please try again. If the problem persists, contact support.`);\n}\n\n/**\n * Validates client ID format (e.g., A001, B123)\n * @param {string} clientID - Client ID to validate\n * @returns {boolean} True if valid format\n */\nfunction validateClientID(clientID) {\n  if (!clientID || typeof clientID !\u003d\u003d \u0027string\u0027) {\n    return false;\n  }\n  return /^[A-Z]\\d{3}$/.test(clientID.trim());\n}\n\n/**\n * Validates tax year\n * @param {string|number} year - Tax year to validate\n * @returns {boolean} True if valid\n */\nfunction validateTaxYear(year) {\n  const currentYear \u003d new Date().getFullYear();\n  const yearNum \u003d parseInt(year);\n  return yearNum \u003e\u003d currentYear - 10 \u0026\u0026 yearNum \u003c\u003d currentYear;\n}\n\n/**\n * Gets available tax years (current year and previous 9 years)\n * @returns {Array\u003cstring\u003e} Array of tax year strings\n */\nfunction getAvailableTaxYears() {\n  const currentYear \u003d new Date().getFullYear();\n  return Array.from({ length: 10 }, (_, i) \u003d\u003e (currentYear - i).toString());\n}\n\n/**\n * Formats elapsed time in milliseconds to human-readable string\n * @param {number} milliseconds - Time in milliseconds\n * @returns {string} Formatted time (e.g., \"2h 30m\" or \"45m\")\n */\nfunction formatElapsedTime(milliseconds) {\n  const totalMinutes \u003d Math.floor(milliseconds / 60000);\n  const hours \u003d Math.floor(totalMinutes / 60);\n  const minutes \u003d totalMinutes % 60;\n\n  if (hours \u003e 0) {\n    return `${hours}h ${minutes}m`;\n  } else {\n    return `${minutes}m`;\n  }\n}\n\n/**\n * Parses wait time string to minutes\n * @param {string} waitStr - Wait time string (e.g., \"2h 30m\")\n * @returns {number} Total minutes\n */\nfunction parseWaitTimeToMinutes(waitStr) {\n  const parts \u003d waitStr.split(\u0027 \u0027);\n  let total \u003d 0;\n  for (const part of parts) {\n    if (part.endsWith(\u0027h\u0027)) {\n      total +\u003d parseInt(part) * 60;\n    }\n    if (part.endsWith(\u0027m\u0027)) {\n      total +\u003d parseInt(part);\n    }\n  }\n  return total;\n}\n\n/**\n * Logs an operation to the audit log (if you create one)\n * @param {string} action - Action performed\n * @param {string} details - Additional details\n * @param {string} user - User who performed the action (optional)\n */\nfunction logAudit(action, details, user \u003d null) {\n  // Optional: Create an Audit Log sheet and log here\n  const timestamp \u003d new Date();\n  Logger.log(`[AUDIT] ${timestamp.toISOString()} - ${action} - ${details}${user ? ` - User: ${user}` : \u0027\u0027}`);\n}\n"},{"id":"cb7016bb-830f-4eb1-adfc-87db5bb5528b","name":"ControlSheetApp","type":"server_js","source":"/**\n * Control Sheet App Entry Point\n * This is the entry point for the Control Sheet web app deployment\n */\n\n/**\n * Entry point for Control Sheet web app\n * @returns {HtmlOutput} The HTML output for the control sheet form\n */\nfunction doGetControlSheet() {\n  return HtmlService.createHtmlOutputFromFile(\u0027control_sheet_form\u0027)\n    .setTitle(\u0027AFSA Tax Clinic Control Sheet\u0027)\n    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);\n}\n"},{"id":"457bbb94-6a8c-4d5c-91f0-2a0c07677528","name":"HelpRequests","type":"server_js","source":"/**\n * Help Request Functions\n * Consolidated help request management functions\n */\n\n/**\n * Sends a help request for a volunteer\n * Optimized to check only recent requests instead of entire sheet\n * @param {string} volunteer - Volunteer name\n * @returns {boolean} True if successful\n */\nfunction sendHelpRequest(volunteer) {\n  return safeExecute(() \u003d\u003e {\n    if (!volunteer || !volunteer.trim()) {\n      throw new Error(\u0027Volunteer name is required\u0027);\n    }\n    \n    const sheet \u003d getSheet(CONFIG.SHEETS.HELP_REQUESTS);\n    const lastRow \u003d sheet.getLastRow();\n    \n    // Optimization: Only check last 200 requests (most are recent)\n    if (lastRow \u003e 1) {\n      const checkRows \u003d Math.min(200, lastRow - 1);\n      const startRow \u003d Math.max(2, lastRow - checkRows + 1);\n      const data \u003d sheet.getRange(startRow, CONFIG.COLUMNS.HELP_REQUESTS.VOLUNTEER + 1, checkRows, 2).getValues();\n      \n      // Check from most recent backwards\n      for (let i \u003d data.length - 1; i \u003e\u003d 0; i--) {\n        if (data[i][0] \u003d\u003d\u003d volunteer \u0026\u0026 data[i][1] \u003d\u003d\u003d CONFIG.HELP_STATUS.ACTIVE) {\n          // Already has active request\n          return true;\n        }\n      }\n    }\n    \n    // Add new help request\n    sheet.appendRow([\n      new Date(),\n      volunteer,\n      CONFIG.HELP_STATUS.ACTIVE\n    ]);\n    \n    logAudit(\u0027Help Request Sent\u0027, `Volunteer: ${volunteer}`);\n    return true;\n  }, \u0027sendHelpRequest\u0027);\n}\n\n/**\n * Clears a help request for a volunteer\n * @param {string} volunteer - Volunteer name\n * @returns {boolean} True if successful\n */\nfunction clearHelpRequest(volunteer) {\n  return safeExecute(() \u003d\u003e {\n    if (!volunteer || !volunteer.trim()) {\n      throw new Error(\u0027Volunteer name is required\u0027);\n    }\n    \n    const sheet \u003d getSheet(CONFIG.SHEETS.HELP_REQUESTS);\n    const data \u003d sheet.getDataRange().getValues();\n    \n    for (let i \u003d 1; i \u003c data.length; i++) {\n      const v \u003d data[i][CONFIG.COLUMNS.HELP_REQUESTS.VOLUNTEER]?.toString().trim();\n      const status \u003d data[i][CONFIG.COLUMNS.HELP_REQUESTS.STATUS]?.toString().trim().toLowerCase();\n      \n      if (v \u003d\u003d\u003d volunteer \u0026\u0026 \n          (status \u003d\u003d\u003d CONFIG.HELP_STATUS.ACTIVE.toLowerCase() || \n           status \u003d\u003d\u003d CONFIG.HELP_STATUS.ESCALATED.toLowerCase())) {\n        sheet.getRange(i + 1, CONFIG.COLUMNS.HELP_REQUESTS.STATUS + 1)\n          .setValue(CONFIG.HELP_STATUS.CLEARED);\n        logAudit(\u0027Help Request Cleared\u0027, `Volunteer: ${volunteer}`);\n        return true;\n      }\n    }\n    \n    return true; // Already cleared or doesn\u0027t exist\n  }, \u0027clearHelpRequest\u0027);\n}\n\n/**\n * Escalates a help request for a volunteer\n * @param {string} volunteer - Volunteer name\n * @returns {boolean} True if successful\n */\nfunction escalateHelpRequest(volunteer) {\n  return safeExecute(() \u003d\u003e {\n    if (!volunteer || !volunteer.trim()) {\n      throw new Error(\u0027Volunteer name is required\u0027);\n    }\n    \n    const sheet \u003d getSheet(CONFIG.SHEETS.HELP_REQUESTS);\n    const data \u003d sheet.getDataRange().getValues();\n    \n    for (let i \u003d 1; i \u003c data.length; i++) {\n      const v \u003d data[i][CONFIG.COLUMNS.HELP_REQUESTS.VOLUNTEER]?.toString().trim();\n      const status \u003d data[i][CONFIG.COLUMNS.HELP_REQUESTS.STATUS]?.toString().trim().toLowerCase();\n      \n      if (v \u003d\u003d\u003d volunteer \u0026\u0026 status \u003d\u003d\u003d CONFIG.HELP_STATUS.ACTIVE.toLowerCase()) {\n        sheet.getRange(i + 1, CONFIG.COLUMNS.HELP_REQUESTS.STATUS + 1)\n          .setValue(CONFIG.HELP_STATUS.ESCALATED);\n        logAudit(\u0027Help Request Escalated\u0027, `Volunteer: ${volunteer}`);\n        return true;\n      }\n    }\n    \n    return false; // No active request found\n  }, \u0027escalateHelpRequest\u0027);\n}\n\n/**\n * Gets the current help status for a volunteer\n * Optimized to check only recent requests\n * @param {string} volunteer - Volunteer name\n * @returns {string} Status: \"active\", \"escalated\", or \"cleared\"\n */\nfunction getHelpStatus(volunteer) {\n  return safeExecute(() \u003d\u003e {\n    if (!volunteer || !volunteer.trim()) {\n      return CONFIG.HELP_STATUS.CLEARED.toLowerCase();\n    }\n    \n    const sheet \u003d getSheet(CONFIG.SHEETS.HELP_REQUESTS);\n    const lastRow \u003d sheet.getLastRow();\n    \n    // Optimization: Only check last 200 requests (most are recent)\n    if (lastRow \u003e 1) {\n      const checkRows \u003d Math.min(200, lastRow - 1);\n      const startRow \u003d Math.max(2, lastRow - checkRows + 1);\n      const data \u003d sheet.getRange(startRow, CONFIG.COLUMNS.HELP_REQUESTS.VOLUNTEER + 1, checkRows, 2).getValues();\n      \n      // Check from most recent to oldest\n      for (let i \u003d data.length - 1; i \u003e\u003d 0; i--) {\n        const v \u003d data[i][0]?.toString().trim();\n        const status \u003d data[i][1]?.toString().trim().toLowerCase();\n        \n        if (v \u003d\u003d\u003d volunteer \u0026\u0026 \n            (status \u003d\u003d\u003d CONFIG.HELP_STATUS.ACTIVE.toLowerCase() || \n             status \u003d\u003d\u003d CONFIG.HELP_STATUS.ESCALATED.toLowerCase())) {\n          return status;\n        }\n      }\n    }\n    \n    return CONFIG.HELP_STATUS.CLEARED.toLowerCase();\n  }, \u0027getHelpStatus\u0027);\n}\n\n/**\n * Gets all currently active or escalated help requests\n * Optimized to read only necessary columns\n * @returns {Array\u003cObject\u003e} Array of help request objects\n */\nfunction getLiveHelpRequests() {\n  return safeExecute(() \u003d\u003e {\n    const sheet \u003d getSheet(CONFIG.SHEETS.HELP_REQUESTS);\n    const lastRow \u003d sheet.getLastRow();\n    \n    // Optimization: Only read rows with data and only necessary columns\n    const data \u003d lastRow \u003e 1\n      ? sheet.getRange(2, 1, lastRow - 1, 3).getValues()\n      : [];\n    \n    const now \u003d new Date();\n    const output \u003d [];\n\n    for (let i \u003d 0; i \u003c data.length; i++) {\n      const timestamp \u003d data[i][CONFIG.COLUMNS.HELP_REQUESTS.TIMESTAMP];\n      const volunteer \u003d data[i][CONFIG.COLUMNS.HELP_REQUESTS.VOLUNTEER]?.toString().trim();\n      const status \u003d data[i][CONFIG.COLUMNS.HELP_REQUESTS.STATUS]?.toString().trim().toLowerCase();\n\n      if (!timestamp || !volunteer || !status) continue;\n      if (status !\u003d\u003d CONFIG.HELP_STATUS.ACTIVE.toLowerCase() \u0026\u0026 \n          status !\u003d\u003d CONFIG.HELP_STATUS.ESCALATED.toLowerCase()) continue;\n\n      const minutesAgo \u003d Math.floor((now - new Date(timestamp)) / 60000);\n\n      output.push({\n        volunteer,\n        timestamp: Utilities.formatDate(new Date(timestamp), Session.getScriptTimeZone(), \u0027M/d/yyyy HH:mm\u0027),\n        status,\n        minutesAgo,\n        rawTimestamp: new Date(timestamp).getTime()\n      });\n    }\n\n    // Sort by time waited (descending: oldest first)\n    output.sort((a, b) \u003d\u003e b.minutesAgo - a.minutesAgo);\n\n    return output;\n  }, \u0027getLiveHelpRequests\u0027);\n}\n"},{"id":"11342def-8f13-4b95-94a4-c20e609db77f","name":"QueueDashBoardApp","type":"server_js","source":"/**\n * Queue Dashboard App Entry Point\n * This is the entry point for the Queue Dashboard web app deployment\n */\n\n/**\n * Entry point for Queue Dashboard web app\n * @returns {HtmlOutput} The HTML output for the queue dashboard\n */\nfunction doGetQueueDashboard() {\n  return HtmlService.createTemplateFromFile(\u0027queue_dashboard\u0027)\n    .evaluate()\n    .setTitle(\u0027Tax Clinic Queue Master Dashboard\u0027)\n    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);\n}\n\n/**\n * Helper function for including HTML files (if needed)\n * @param {string} filename - Name of the HTML file to include\n * @returns {string} Content of the HTML file\n */\nfunction include(filename) {\n  return HtmlService.createHtmlOutputFromFile(filename).getContent();\n}\n"},{"id":"09e50b8b-ad90-4ab9-93d5-b2d171531ccc","name":"QueueManagement","type":"server_js","source":"/**\n * Help Request Functions\n * Consolidated help request management functions\n */\n\n/**\n * Sends a help request for a volunteer\n * Optimized to check only recent requests instead of entire sheet\n * @param {string} volunteer - Volunteer name\n * @returns {boolean} True if successful\n */\nfunction sendHelpRequest(volunteer) {\n  return safeExecute(() \u003d\u003e {\n    if (!volunteer || !volunteer.trim()) {\n      throw new Error(\u0027Volunteer name is required\u0027);\n    }\n    \n    const sheet \u003d getSheet(CONFIG.SHEETS.HELP_REQUESTS);\n    const lastRow \u003d sheet.getLastRow();\n    \n    // Optimization: Only check last 200 requests (most are recent)\n    if (lastRow \u003e 1) {\n      const checkRows \u003d Math.min(200, lastRow - 1);\n      const startRow \u003d Math.max(2, lastRow - checkRows + 1);\n      const data \u003d sheet.getRange(startRow, CONFIG.COLUMNS.HELP_REQUESTS.VOLUNTEER + 1, checkRows, 2).getValues();\n      \n      // Check from most recent backwards\n      for (let i \u003d data.length - 1; i \u003e\u003d 0; i--) {\n        if (data[i][0] \u003d\u003d\u003d volunteer \u0026\u0026 data[i][1] \u003d\u003d\u003d CONFIG.HELP_STATUS.ACTIVE) {\n          // Already has active request\n          return true;\n        }\n      }\n    }\n    \n    // Add new help request\n    sheet.appendRow([\n      new Date(),\n      volunteer,\n      CONFIG.HELP_STATUS.ACTIVE\n    ]);\n    \n    logAudit(\u0027Help Request Sent\u0027, `Volunteer: ${volunteer}`);\n    return true;\n  }, \u0027sendHelpRequest\u0027);\n}\n\n/**\n * Clears a help request for a volunteer\n * @param {string} volunteer - Volunteer name\n * @returns {boolean} True if successful\n */\nfunction clearHelpRequest(volunteer) {\n  return safeExecute(() \u003d\u003e {\n    if (!volunteer || !volunteer.trim()) {\n      throw new Error(\u0027Volunteer name is required\u0027);\n    }\n    \n    const sheet \u003d getSheet(CONFIG.SHEETS.HELP_REQUESTS);\n    const data \u003d sheet.getDataRange().getValues();\n    \n    for (let i \u003d 1; i \u003c data.length; i++) {\n      const v \u003d data[i][CONFIG.COLUMNS.HELP_REQUESTS.VOLUNTEER]?.toString().trim();\n      const status \u003d data[i][CONFIG.COLUMNS.HELP_REQUESTS.STATUS]?.toString().trim().toLowerCase();\n      \n      if (v \u003d\u003d\u003d volunteer \u0026\u0026 \n          (status \u003d\u003d\u003d CONFIG.HELP_STATUS.ACTIVE.toLowerCase() || \n           status \u003d\u003d\u003d CONFIG.HELP_STATUS.ESCALATED.toLowerCase())) {\n        sheet.getRange(i + 1, CONFIG.COLUMNS.HELP_REQUESTS.STATUS + 1)\n          .setValue(CONFIG.HELP_STATUS.CLEARED);\n        logAudit(\u0027Help Request Cleared\u0027, `Volunteer: ${volunteer}`);\n        return true;\n      }\n    }\n    \n    return true; // Already cleared or doesn\u0027t exist\n  }, \u0027clearHelpRequest\u0027);\n}\n\n/**\n * Escalates a help request for a volunteer\n * @param {string} volunteer - Volunteer name\n * @returns {boolean} True if successful\n */\nfunction escalateHelpRequest(volunteer) {\n  return safeExecute(() \u003d\u003e {\n    if (!volunteer || !volunteer.trim()) {\n      throw new Error(\u0027Volunteer name is required\u0027);\n    }\n    \n    const sheet \u003d getSheet(CONFIG.SHEETS.HELP_REQUESTS);\n    const data \u003d sheet.getDataRange().getValues();\n    \n    for (let i \u003d 1; i \u003c data.length; i++) {\n      const v \u003d data[i][CONFIG.COLUMNS.HELP_REQUESTS.VOLUNTEER]?.toString().trim();\n      const status \u003d data[i][CONFIG.COLUMNS.HELP_REQUESTS.STATUS]?.toString().trim().toLowerCase();\n      \n      if (v \u003d\u003d\u003d volunteer \u0026\u0026 status \u003d\u003d\u003d CONFIG.HELP_STATUS.ACTIVE.toLowerCase()) {\n        sheet.getRange(i + 1, CONFIG.COLUMNS.HELP_REQUESTS.STATUS + 1)\n          .setValue(CONFIG.HELP_STATUS.ESCALATED);\n        logAudit(\u0027Help Request Escalated\u0027, `Volunteer: ${volunteer}`);\n        return true;\n      }\n    }\n    \n    return false; // No active request found\n  }, \u0027escalateHelpRequest\u0027);\n}\n\n/**\n * Gets the current help status for a volunteer\n * Optimized to check only recent requests\n * @param {string} volunteer - Volunteer name\n * @returns {string} Status: \"active\", \"escalated\", or \"cleared\"\n */\nfunction getHelpStatus(volunteer) {\n  return safeExecute(() \u003d\u003e {\n    if (!volunteer || !volunteer.trim()) {\n      return CONFIG.HELP_STATUS.CLEARED.toLowerCase();\n    }\n    \n    const sheet \u003d getSheet(CONFIG.SHEETS.HELP_REQUESTS);\n    const lastRow \u003d sheet.getLastRow();\n    \n    // Optimization: Only check last 200 requests (most are recent)\n    if (lastRow \u003e 1) {\n      const checkRows \u003d Math.min(200, lastRow - 1);\n      const startRow \u003d Math.max(2, lastRow - checkRows + 1);\n      const data \u003d sheet.getRange(startRow, CONFIG.COLUMNS.HELP_REQUESTS.VOLUNTEER + 1, checkRows, 2).getValues();\n      \n      // Check from most recent to oldest\n      for (let i \u003d data.length - 1; i \u003e\u003d 0; i--) {\n        const v \u003d data[i][0]?.toString().trim();\n        const status \u003d data[i][1]?.toString().trim().toLowerCase();\n        \n        if (v \u003d\u003d\u003d volunteer \u0026\u0026 \n            (status \u003d\u003d\u003d CONFIG.HELP_STATUS.ACTIVE.toLowerCase() || \n             status \u003d\u003d\u003d CONFIG.HELP_STATUS.ESCALATED.toLowerCase())) {\n          return status;\n        }\n      }\n    }\n    \n    return CONFIG.HELP_STATUS.CLEARED.toLowerCase();\n  }, \u0027getHelpStatus\u0027);\n}\n\n/**\n * Gets all currently active or escalated help requests\n * Optimized to read only necessary columns\n * @returns {Array\u003cObject\u003e} Array of help request objects\n */\nfunction getLiveHelpRequests() {\n  return safeExecute(() \u003d\u003e {\n    const sheet \u003d getSheet(CONFIG.SHEETS.HELP_REQUESTS);\n    const lastRow \u003d sheet.getLastRow();\n    \n    // Optimization: Only read rows with data and only necessary columns\n    const data \u003d lastRow \u003e 1\n      ? sheet.getRange(2, 1, lastRow - 1, 3).getValues()\n      : [];\n    \n    const now \u003d new Date();\n    const output \u003d [];\n\n    for (let i \u003d 0; i \u003c data.length; i++) {\n      const timestamp \u003d data[i][CONFIG.COLUMNS.HELP_REQUESTS.TIMESTAMP];\n      const volunteer \u003d data[i][CONFIG.COLUMNS.HELP_REQUESTS.VOLUNTEER]?.toString().trim();\n      const status \u003d data[i][CONFIG.COLUMNS.HELP_REQUESTS.STATUS]?.toString().trim().toLowerCase();\n\n      if (!timestamp || !volunteer || !status) continue;\n      if (status !\u003d\u003d CONFIG.HELP_STATUS.ACTIVE.toLowerCase() \u0026\u0026 \n          status !\u003d\u003d CONFIG.HELP_STATUS.ESCALATED.toLowerCase()) continue;\n\n      const minutesAgo \u003d Math.floor((now - new Date(timestamp)) / 60000);\n\n      output.push({\n        volunteer,\n        timestamp: Utilities.formatDate(new Date(timestamp), Session.getScriptTimeZone(), \u0027M/d/yyyy HH:mm\u0027),\n        status,\n        minutesAgo,\n        rawTimestamp: new Date(timestamp).getTime()\n      });\n    }\n\n    // Sort by time waited (descending: oldest first)\n    output.sort((a, b) \u003d\u003e b.minutesAgo - a.minutesAgo);\n\n    return output;\n  }, \u0027getLiveHelpRequests\u0027);\n}\n"},{"id":"77d04964-e911-4106-8667-383180e68928","name":"Utils","type":"server_js","source":"/**\n * Utility Functions\n * Shared utility functions for error handling, validation, etc.\n */\n\n/**\n * Wraps a function in error handling\n * @param {Function} operation - The function to execute\n * @param {string} context - Context description for logging\n * @returns {*} The result of the operation\n */\nfunction safeExecute(operation, context \u003d \u0027Operation\u0027) {\n  try {\n    return operation();\n  } catch (error) {\n    Logger.log(`${context} Error: ${error.message}`);\n    Logger.log(`Stack: ${error.stack}`);\n    throw new Error(`${context} failed: ${error.message}`);\n  }\n}\n\n/**\n * Validates client ID format (e.g., A001, B123)\n * @param {string} clientID - Client ID to validate\n * @returns {boolean} True if valid format\n */\nfunction validateClientID(clientID) {\n  if (!clientID || typeof clientID !\u003d\u003d \u0027string\u0027) {\n    return false;\n  }\n  return /^[A-Z]\\d{3}$/.test(clientID.trim());\n}\n\n/**\n * Validates tax year\n * @param {string|number} year - Tax year to validate\n * @returns {boolean} True if valid\n */\nfunction validateTaxYear(year) {\n  const currentYear \u003d new Date().getFullYear();\n  const yearNum \u003d parseInt(year);\n  return yearNum \u003e\u003d currentYear - 10 \u0026\u0026 yearNum \u003c\u003d currentYear;\n}\n\n/**\n * Gets available tax years (current year and previous 9 years)\n * @returns {Array\u003cstring\u003e} Array of tax year strings\n */\nfunction getAvailableTaxYears() {\n  const currentYear \u003d new Date().getFullYear();\n  return Array.from({ length: 10 }, (_, i) \u003d\u003e (currentYear - i).toString());\n}\n\n/**\n * Formats elapsed time in milliseconds to human-readable string\n * @param {number} milliseconds - Time in milliseconds\n * @returns {string} Formatted time (e.g., \"2h 30m\" or \"45m\")\n */\nfunction formatElapsedTime(milliseconds) {\n  const totalMinutes \u003d Math.floor(milliseconds / 60000);\n  const hours \u003d Math.floor(totalMinutes / 60);\n  const minutes \u003d totalMinutes % 60;\n\n  if (hours \u003e 0) {\n    return `${hours}h ${minutes}m`;\n  } else {\n    return `${minutes}m`;\n  }\n}\n\n/**\n * Parses wait time string to minutes\n * @param {string} waitStr - Wait time string (e.g., \"2h 30m\")\n * @returns {number} Total minutes\n */\nfunction parseWaitTimeToMinutes(waitStr) {\n  const parts \u003d waitStr.split(\u0027 \u0027);\n  let total \u003d 0;\n  for (const part of parts) {\n    if (part.endsWith(\u0027h\u0027)) {\n      total +\u003d parseInt(part) * 60;\n    }\n    if (part.endsWith(\u0027m\u0027)) {\n      total +\u003d parseInt(part);\n    }\n  }\n  return total;\n}\n\n/**\n * Logs an operation to the audit log (if you create one)\n * @param {string} action - Action performed\n * @param {string} details - Additional details\n * @param {string} user - User who performed the action (optional)\n */\nfunction logAudit(action, details, user \u003d null) {\n  // Optional: Create an Audit Log sheet and log here\n  const timestamp \u003d new Date();\n  Logger.log(`[AUDIT] ${timestamp.toISOString()} - ${action} - ${details}${user ? ` - User: ${user}` : \u0027\u0027}`);\n}\n"},{"id":"41cd7e83-f6e5-409c-a410-ca1c9d9e73c5","name":"admin_dashboard","type":"html","source":"// Entry point to load the dashboard as a web app\nfunction doGet() {\n  return HtmlService.createHtmlOutputFromFile(\u0027dashboard\u0027)\n    .setTitle(\u0027Live Help Request Dashboard\u0027)\n    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL); // Optional: embed support\n}\n\n// Returns all currently Active or Escalated help requests\nfunction getLiveHelpRequests() {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const sheet \u003d ss.getSheetByName(\u0027Help Requests\u0027);\n  const data \u003d sheet.getDataRange().getValues();\n  const now \u003d new Date();\n  const output \u003d [];\n\n  for (let i \u003d 1; i \u003c data.length; i++) {\n    const timestamp \u003d data[i][0];\n    const volunteer \u003d data[i][1]?.toString().trim();\n    const status \u003d data[i][2]?.toString().trim().toLowerCase();\n\n    if (!timestamp || !volunteer || !status) continue;\n    if (status !\u003d\u003d \"active\" \u0026\u0026 status !\u003d\u003d \"escalated\") continue;\n\n    const minutesAgo \u003d Math.floor((now - new Date(timestamp)) / 60000);\n\n    output.push({\n      volunteer,\n      timestamp: Utilities.formatDate(new Date(timestamp), Session.getScriptTimeZone(), \u0027M/d/yyyy HH:mm\u0027),\n      status,\n      minutesAgo,\n      rawTimestamp: new Date(timestamp).getTime() // for sorting\n    });\n  }\n\n  // Sort by time waited (descending: oldest first)\n  output.sort((a, b) \u003d\u003e b.minutesAgo - a.minutesAgo); // or use rawTimestamp\n\n  return output;\n}\n\nfunction clearHelpRequest(volunteer) {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const sheet \u003d ss.getSheetByName(\u0027Help Requests\u0027);\n  const data \u003d sheet.getDataRange().getValues();\n\n  for (let i \u003d 1; i \u003c data.length; i++) {\n    const v \u003d data[i][1]?.toString().trim();\n    const status \u003d data[i][2]?.toString().trim().toLowerCase();\n    if (v \u003d\u003d\u003d volunteer \u0026\u0026 (status \u003d\u003d\u003d \"active\" || status \u003d\u003d\u003d \"escalated\")) {\n      sheet.getRange(i + 1, 3).setValue(\"Cleared\");\n      break;\n    }\n  }\n}\nfunction getReturnSummary() {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const sheet \u003d ss.getSheetByName(\u0027Tax Return Tracker\u0027);\n  const data \u003d sheet.getDataRange().getValues();\n  const today \u003d new Date();\n  const timezone \u003d Session.getScriptTimeZone();\n\n  let totalCompleted \u003d 0;\n  let completedToday \u003d 0;\n  const hourlyCounts \u003d {};\n\n  for (let i \u003d 1; i \u003c data.length; i++) {\n    const row \u003d data[i];\n    const timestamp \u003d row[0];\n    const efile \u003d row[6]?.toString().toLowerCase() \u003d\u003d\u003d \u0027yes\u0027;\n    const paper \u003d row[7]?.toString().toLowerCase() \u003d\u003d\u003d \u0027yes\u0027;\n\n    if (efile || paper) {\n      totalCompleted++;\n\n      const ts \u003d new Date(timestamp);\n      const sameDay \u003d ts.getFullYear() \u003d\u003d\u003d today.getFullYear()\n                   \u0026\u0026 ts.getMonth() \u003d\u003d\u003d today.getMonth()\n                   \u0026\u0026 ts.getDate() \u003d\u003d\u003d today.getDate();\n\n      if (sameDay) {\n        completedToday++;\n\n        const hour \u003d ts.getHours();\n        hourlyCounts[hour] \u003d (hourlyCounts[hour] || 0) + 1;\n      }\n    }\n  }\n\n  return {\n    totalCompleted,\n    completedToday,\n    hourlyCounts\n  };\n}"},{"id":"7f6bdcf5-0049-46a7-ab6d-95349c4a3f78","name":"catbus_intake_form","type":"html","source":"\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n  \u003cbase target\u003d\"_top\"\u003e\n  \u003cstyle\u003e\n    :root {\n      --accent-color: rgb(142, 0, 0);\n      --bg-color-light: #ffffff;\n      --text-color-light: #1a1a1a;\n      --input-bg-light: #f2f2f2;\n      --border-light: #ccc;\n      --bg-color-dark: #1e1e1e;\n      --text-color-dark: #f0f0f0;\n      --input-bg-dark: #2a2a2a;\n      --border-dark: #444;\n    }\n\n    body.light {\n      background-color: var(--bg-color-light);\n      color: var(--text-color-light);\n    }\n\n    body.dark {\n      background-color: var(--bg-color-dark);\n      color: var(--text-color-dark);\n    }\n\n    body {\n      margin: 0;\n      font-family: \u0027Segoe UI\u0027, Verdana, sans-serif;\n      padding: 20px;\n      transition: background 0.3s, color 0.3s;\n    }\n\n    header {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      margin-bottom: 30px;\n    }\n\n    header h3 {\n      font-family: Verdana, sans-serif;\n      color: var(--accent-color);\n      font-size: 1.5rem;\n      margin: 0 auto;\n      text-align: center;\n    }\n\n    header img {\n      height: 60px;\n    }\n\n    .toggle-theme {\n      cursor: pointer;\n      font-size: 1.4em;\n      margin-left: auto;\n    }\n\n    .form-wrapper {\n      max-width: 600px;\n      margin: 0 auto;\n    }\n\n    .form-group {\n      margin-bottom: 20px;\n    }\n\n    .radio-horizontal {\n      display: flex;\n      gap: 20px;\n    }\n\n    label {\n      font-weight: 500;\n      display: block;\n      margin-bottom: 6px;\n    }\n\n    input[type\u003d\"radio\"] {\n      margin-right: 6px;\n    }\n\n    body.light input, body.light textarea {\n      background-color: var(--input-bg-light);\n      color: var(--text-color-light);\n      border-color: var(--border-light);\n    }\n\n    body.dark input, body.dark textarea {\n      background-color: var(--input-bg-dark);\n      color: var(--text-color-dark);\n      border-color: var(--border-dark);\n    }\n\n    .checkbox-horizontal {\n      display: flex;\n      flex-wrap: wrap;\n      gap: 12px;\n      align-items: center;\n    }\n\n    #mainForm { display: none; text-align: left; }\n    #ineligibleMsg { display: none; color: red; margin-top: 20px; font-weight: bold; text-align: left; }\n    #incomeLimitGroup, #conditionalQuestions { display: none; }\n\n    #notes {\n      width: 700px;\n      max-width: 100%;\n    }\n    button {\n      padding: 8px 16px;\n      border: none;\n      border-radius: 5px;\n      cursor: pointer;\n      font-weight: 500;\n      background-color: var(--accent-color);\n      color: white;\n      transition: background 0.2s;\n      display: block;\n      margin: 20px auto;\n    }\n\n    button:hover {\n      background-color: #a00000;\n    }\n\n    table.income-table {\n      margin-top: 10px;\n      border-collapse: collapse;\n      width: 100%;\n      max-width: 400px;\n    }\n\n    table.income-table, .income-table th, .income-table td {\n      border: 1px solid #999;\n    }\n\n    .income-table th, .income-table td {\n      padding: 6px;\n      text-align: left;\n    }\n\n    .income-table caption {\n      font-weight: bold;\n      margin-bottom: 5px;\n    }\n\n    .filing-error {\n      border: 2px solid red;\n      padding: 10px;\n      border-radius: 5px;\n    }\n    #receptionHelpBtn {\n      background-color: #cccccc;  /* Neutral gray by default */\n      color: black;\n      padding: 8px 14px;\n      border-radius: 5px;\n      font-weight: bold;\n      border: none;\n      cursor: pointer;\n      transition: background 0.2s ease;\n    }\n\n    #receptionHelpBtn:hover {\n      background-color: #b3b3b3;\n    }\n\n    #receptionHelpBtn.active {\n      background-color: #f39c12;  /* Bright amber when active */\n      color: white;\n    }\n\n    #receptionEscalateBtn {\n      background-color: #e74c3c;\n      color: white;\n      padding: 8px 14px;\n      border-radius: 5px;\n      font-weight: bold;\n      border: none;\n      cursor: pointer;\n      transition: background 0.2s ease;\n      margin-left: 10px;\n    }\n\n    #receptionEscalateBtn:disabled {\n      background-color: #aaa;\n      cursor: not-allowed;\n    }\n\n    #receptionHelpArea {\n      margin-top: 30px;\n      text-align: center;\n    }\n    .tooltip {\n      display: inline-block;\n      position: relative;\n      cursor: pointer;\n      margin-left: 6px;\n      color: var(--accent-color);\n      font-weight: bold;\n    }\n\n    .tooltip::after {\n      content: attr(data-tooltip);\n      position: absolute;\n      bottom: 125%;\n      left: 50%;\n      transform: translateX(-50%);\n      background-color: #333;\n      color: #fff;\n      padding: 6px 10px;\n      border-radius: 5px;\n      white-space: nowrap;\n      opacity: 0;\n      pointer-events: none;\n      font-size: 0.85em;\n      transition: opacity 0.2s ease;\n      z-index: 10;\n    }\n\n    .tooltip:hover::after {\n      opacity: 1;\n    }\n  \u003c/style\u003e\n  \u003cscript\u003e\n    function toggleIncomeQuestion() {\n      const tuition \u003d document.querySelector(\u0027input[name\u003d\"tuition\"]:checked\u0027);\n      const group \u003d document.getElementById(\u0027incomeLimitGroup\u0027);\n      group.style.display \u003d tuition \u0026\u0026 tuition.value \u003d\u003d\u003d \u0027No\u0027 ? \u0027block\u0027 : \u0027none\u0027;\n    }\n\n    function checkEligibility() {\n      const tuition \u003d document.querySelector(\u0027input[name\u003d\"tuition\"]:checked\u0027)?.value;\n      const income \u003d document.querySelector(\u0027input[name\u003d\"incomeLimit\"]:checked\u0027)?.value;\n      const docs \u003d document.querySelector(\u0027input[name\u003d\"documentsReady\"]:checked\u0027)?.value;\n      const present \u003d document.querySelector(\u0027input[name\u003d\"allPresent\"]:checked\u0027)?.value;\n      const selfEmp \u003d document.querySelector(\u0027input[name\u003d\"selfEmployment\"]:checked\u0027)?.value;\n      const bankrupt \u003d document.querySelector(\u0027input[name\u003d\"bankruptcyOrDeceased\"]:checked\u0027)?.value;\n      const rental \u003d document.querySelector(\u0027input[name\u003d\"rentalOrGains\"]:checked\u0027)?.value;\n      const foreign \u003d document.querySelector(\u0027input[name\u003d\"foreignProperty\"]:checked\u0027)?.value;\n\n      const showCond \u003d tuition \u003d\u003d\u003d \u0027Yes\u0027 || (tuition \u003d\u003d\u003d \u0027No\u0027 \u0026\u0026 income \u003d\u003d\u003d \u0027No\u0027);\n      document.getElementById(\u0027conditionalQuestions\u0027).style.display \u003d showCond ? \u0027block\u0027 : \u0027none\u0027;\n\n      const isIneligible \u003d (\n        (tuition \u003d\u003d\u003d \u0027No\u0027 \u0026\u0026 income \u003d\u003d\u003d \u0027Yes\u0027) ||\n        docs \u003d\u003d\u003d \u0027No\u0027 ||\n        present \u003d\u003d\u003d \u0027No\u0027 ||\n        selfEmp \u003d\u003d\u003d \u0027Yes\u0027 ||\n        bankrupt \u003d\u003d\u003d \u0027Yes\u0027 ||\n        rental \u003d\u003d\u003d \u0027Yes\u0027 ||\n        foreign \u003d\u003d\u003d \u0027Yes\u0027\n      );\n\n      document.getElementById(\u0027mainForm\u0027).style.display \u003d !isIneligible \u0026\u0026 docs \u0026\u0026 present \u0026\u0026 selfEmp \u0026\u0026 bankrupt \u0026\u0026 rental \u0026\u0026 foreign ? \u0027block\u0027 : \u0027none\u0027;\n      document.getElementById(\u0027ineligibleMsg\u0027).style.display \u003d isIneligible ? \u0027block\u0027 : \u0027none\u0027;\n    }\n\n    function resetForm() {\n      document.getElementById(\u0027eligibilityForm\u0027).reset();\n      document.getElementById(\u0027mainForm\u0027).style.display \u003d \u0027none\u0027;\n      document.getElementById(\u0027ineligibleMsg\u0027).style.display \u003d \u0027none\u0027;\n      document.getElementById(\u0027incomeLimitGroup\u0027).style.display \u003d \u0027none\u0027;\n      document.getElementById(\u0027conditionalQuestions\u0027).style.display \u003d \u0027none\u0027;\n    }\n\n    function submitMainForm() {\n      const filingYearCheckboxes \u003d document.querySelectorAll(\u0027input[name\u003d\"filingYears\"]:checked\u0027);\n      const errorBox \u003d document.getElementById(\u0027filingYearsError\u0027);\n\n      // Validation: At least one filing year must be checked\n      if (filingYearCheckboxes.length \u003d\u003d\u003d 0) {\n        errorBox.style.display \u003d \u0027block\u0027;\n        return;\n      } else {\n        errorBox.style.display \u003d \u0027none\u0027;\n      }\n\n      const formData \u003d {\n        householdsize: document.getElementById(\u0027householdsize\u0027).value,\n        filingYears: [...filingYearCheckboxes].map(cb \u003d\u003e cb.value),\n        situations: [...document.querySelectorAll(\u0027input[name\u003d\"situations\"]:checked\u0027)].map(cb \u003d\u003e cb.value),\n        notes: document.getElementById(\u0027notes\u0027).value,\n        needsSeniorReview: document.getElementById(\u0027needsSeniorReview\u0027).checked\n      };\n\n      google.script.run\n        .withSuccessHandler(clientID \u003d\u003e {\n          document.getElementById(\u0027clientIDDisplay\u0027).textContent \u003d clientID;\n          showModal();\n        })\n        .storeMainFormData(formData);\n    }\n    function showModal() {\n      const modal \u003d document.getElementById(\u0027confirmationModal\u0027);\n      modal.style.display \u003d \u0027flex\u0027; // force flex display\n    }\n\n    function closeModal() {\n      document.getElementById(\u0027confirmationModal\u0027).style.display \u003d \u0027none\u0027;\n      document.getElementById(\u0027eligibilityForm\u0027).reset();\n      document.getElementById(\u0027mainForm\u0027).reset();\n\n      // Reset UI state\n      document.getElementById(\u0027mainForm\u0027).style.display \u003d \u0027none\u0027;\n      document.getElementById(\u0027ineligibleMsg\u0027).style.display \u003d \u0027none\u0027;\n      document.getElementById(\u0027incomeLimitGroup\u0027).style.display \u003d \u0027none\u0027;\n      document.getElementById(\u0027conditionalQuestions\u0027).style.display \u003d \u0027none\u0027;\n    }\n    function toggleTheme() {\n      const body \u003d document.body;\n      const themeIcon \u003d document.querySelector(\u0027.toggle-theme\u0027);\n\n      if (body.classList.contains(\u0027light\u0027)) {\n        body.classList.remove(\u0027light\u0027);\n        body.classList.add(\u0027dark\u0027);\n        themeIcon.textContent \u003d \u0027\u0027;\n      } else {\n        body.classList.remove(\u0027dark\u0027);\n        body.classList.add(\u0027light\u0027);\n        themeIcon.textContent \u003d \u0027\u0027;\n      }\n    }\n    let receptionHelpActive \u003d false;\n\n    function toggleReceptionHelp() {\n      const helpBtn \u003d document.getElementById(\u0027receptionHelpBtn\u0027);\n      const escalateBtn \u003d document.getElementById(\u0027receptionEscalateBtn\u0027);\n      const volunteer \u003d \"Reception\";\n\n      receptionHelpActive \u003d !receptionHelpActive;\n\n      if (receptionHelpActive) {\n        google.script.run.withSuccessHandler(() \u003d\u003e {\n          helpBtn.textContent \u003d \u0027 Cancel Call\u0027;\n          helpBtn.classList.add(\u0027active\u0027);\n          escalateBtn.style.display \u003d \u0027inline-block\u0027;\n          escalateBtn.disabled \u003d false;\n        }).sendHelpRequest(volunteer);\n      } else {\n        google.script.run.withSuccessHandler(() \u003d\u003e {\n          helpBtn.textContent \u003d \u0027 Call for Help\u0027;\n          helpBtn.classList.remove(\u0027active\u0027);\n          escalateBtn.style.display \u003d \u0027none\u0027;\n        }).clearHelpRequest(volunteer);\n      }\n    }\n\n    function escalateReceptionHelp() {\n      const volunteer \u003d \"Reception\";\n      const escalateBtn \u003d document.getElementById(\u0027receptionEscalateBtn\u0027);\n\n      google.script.run.withSuccessHandler(() \u003d\u003e {\n        escalateBtn.disabled \u003d true;\n      }).escalateHelpRequest(volunteer);\n    }\n  \u003c/script\u003e\n\u003c/head\u003e\n\u003cbody class\u003d\"light\"\u003e\n  \u003cheader\u003e\n    \u003ch3\u003eAFSA Tax Clinic Client Intake Form\u003c/h3\u003e\n    \u003cdiv\u003e\n      \u003cspan class\u003d\"toggle-theme\" onclick\u003d\"toggleTheme()\"\u003e\u003c/span\u003e\n    \u003c/div\u003e\n  \u003c/header\u003e\n\n  \u003cdiv class\u003d\"form-wrapper\"\u003e\n    \u003cform id\u003d\"eligibilityForm\" oninput\u003d\"checkEligibility()\"\u003e\n      \u003cdiv class\u003d\"form-group\"\u003e\n        \u003clabel\u003eAre you claiming tuition credits (T2202)\u003cspan class\u003d\"tooltip\" data-tooltip\u003d\"Tuition credits can be either accrued from current year or prior year carryforward.\"\u003e?\u003c/span\u003e\u003c/label\u003e\n        \u003cdiv class\u003d\"radio-horizontal\"\u003e\n          \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"tuition\" value\u003d\"Yes\" onchange\u003d\"toggleIncomeQuestion()\"\u003e Yes\u003c/label\u003e\n          \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"tuition\" value\u003d\"No\" onchange\u003d\"toggleIncomeQuestion()\"\u003e No\u003c/label\u003e\n        \u003c/div\u003e\n      \u003c/div\u003e\n      \u003cdiv class\u003d\"form-group\" id\u003d\"incomeLimitGroup\"\u003e\n        \u003clabel\u003eDo you have income in excess of our limits\u003cspan class\u003d\"tooltip\" data-tooltip\u003d\"This is a hard limit - no exceptions. For income limit not to apply, must claim tuition credits. If client is unsure, ask for their slips\"\u003e?\u003c/span\u003e\u003c/label\u003e\n        \u003ctable class\u003d\"income-table\"\u003e\n          \u003ccaption\u003eIncome Limits\u003c/caption\u003e\n          \u003ctr\u003e\u003cth\u003eTaxpayer Status\u003c/th\u003e\u003cth\u003eFamily Income\u003c/th\u003e\u003c/tr\u003e\n          \u003ctr\u003e\u003ctd\u003eIndividual\u003c/td\u003e\u003ctd\u003e$35,000\u003c/td\u003e\u003c/tr\u003e\n          \u003ctr\u003e\u003ctd\u003eCouple\u003c/td\u003e\u003ctd\u003e$45,000\u003c/td\u003e\u003c/tr\u003e\n          \u003ctr\u003e\u003ctd\u003eEach additional dependant\u003c/td\u003e\u003ctd\u003e+$2,500\u003c/td\u003e\u003c/tr\u003e\n          \u003ctr\u003e\u003ctd\u003eInterest income over $1,000\u003c/td\u003e\u003ctd\u003eIneligible\u003c/td\u003e\u003c/tr\u003e\n        \u003c/table\u003e\n        \u003csmall\u003e*For each additional dependant you have, add $2,500 to the maximum family income.\u003c/small\u003e\u003cbr\u003e\u003cbr\u003e\n        \u003cdiv class\u003d\"radio-horizontal\"\u003e\n          \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"incomeLimit\" value\u003d\"Yes\"\u003e Yes\u003c/label\u003e\n          \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"incomeLimit\" value\u003d\"No\"\u003e No\u003c/label\u003e\n        \u003c/div\u003e\n      \u003c/div\u003e\n      \u003cdiv id\u003d\"conditionalQuestions\"\u003e\n        \u003cdiv class\u003d\"form-group\"\u003e\n          \u003clabel\u003eDo you have all your documents available now\u003cspan class\u003d\"tooltip\" data-tooltip\u003d\"Digital documentation is fine. Rent receipts do not need to be present at the moment, but client must know exact amount and be able to get receipts in the future\"\u003e?\u003c/span\u003e\u003c/label\u003e\n          \u003cdiv class\u003d\"radio-horizontal\"\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"documentsReady\" value\u003d\"Yes\"\u003e Yes\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"documentsReady\" value\u003d\"No\"\u003e No\u003c/label\u003e\n          \u003c/div\u003e\n        \u003c/div\u003e\n        \u003cdiv class\u003d\"form-group\"\u003e\n          \u003clabel\u003eAre all clients filing a return present here today\u003cspan class\u003d\"tooltip\" data-tooltip\u003d\"We do need a signature from all filing individuals to finalize the return. If the individual is not present, representative must be able to show 1) Power of Attorney or 2)the missing peron\u0027s ID + they video call in on finalization\"\u003e?\u003c/span\u003e\u003c/label\u003e\n          \u003cdiv class\u003d\"radio-horizontal\"\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"allPresent\" value\u003d\"Yes\"\u003e Yes\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"allPresent\" value\u003d\"No\"\u003e No\u003c/label\u003e\n          \u003c/div\u003e\n        \u003c/div\u003e\n        \u003cdiv class\u003d\"form-group\"\u003e\n          \u003clabel\u003eDo you have self-employment income or crypto transactions\u003cspan class\u003d\"tooltip\" data-tooltip\u003d\"Self-employment includes Door-Dash/Uber Eats. Holding or buying crypto is fine, but not if they sold during the year\"\u003e?\u003c/span\u003e\u003c/label\u003e\n          \u003cdiv class\u003d\"radio-horizontal\"\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"selfEmployment\" value\u003d\"Yes\"\u003e Yes\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"selfEmployment\" value\u003d\"No\"\u003e No\u003c/label\u003e\n          \u003c/div\u003e\n        \u003c/div\u003e\n        \u003cdiv class\u003d\"form-group\"\u003e\n          \u003clabel\u003eAre you filing for bankruptcy or for a deceased person\u003cspan class\u003d\"tooltip\" data-tooltip\u003d\"Our software doesn\u0027t do terminal returns (nor are the volunteers trained to do this)\"\u003e?\u003c/span\u003e\u003c/label\u003e\n          \u003cdiv class\u003d\"radio-horizontal\"\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"bankruptcyOrDeceased\" value\u003d\"Yes\"\u003e Yes\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"bankruptcyOrDeceased\" value\u003d\"No\"\u003e No\u003c/label\u003e\n          \u003c/div\u003e\n        \u003c/div\u003e\n        \u003cdiv class\u003d\"form-group\"\u003e\n          \u003clabel\u003e Do you have rental income or capital gains\u003cspan class\u003d\"tooltip\" data-tooltip\u003d\"Rental income does not include subletting - subletting for a profit is illegal in Ontario.\"\u003e?\u003c/span\u003e\u003c/label\u003e\n          \u003cdiv class\u003d\"radio-horizontal\"\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"rentalOrGains\" value\u003d\"Yes\"\u003e Yes\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"rentalOrGains\" value\u003d\"No\"\u003e No\u003c/label\u003e\n          \u003c/div\u003e\n        \u003c/div\u003e\n        \u003cdiv class\u003d\"form-group\"\u003e\n          \u003clabel\u003e Do you have foreign property over $100K\u003cspan class\u003d\"tooltip\" data-tooltip\u003d\"Rental properties or foreign stock portfolios. Personal homes do not count\"\u003e?\u003c/span\u003e\u003c/label\u003e\n          \u003cdiv class\u003d\"radio-horizontal\"\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"foreignProperty\" value\u003d\"Yes\"\u003e Yes\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"foreignProperty\" value\u003d\"No\"\u003e No\u003c/label\u003e\n          \u003c/div\u003e\n        \u003c/div\u003e\n      \u003c/div\u003e\n    \u003c/form\u003e\n\n    \u003cdiv id\u003d\"ineligibleMsg\"\u003eUnfortunately, this client does not meet our eligibility requirements. \u003cbutton onclick\u003d\"resetForm()\"\u003eReset\u003c/button\u003e\u003c/div\u003e\n\n    \u003cform id\u003d\"mainForm\" onsubmit\u003d\"submitMainForm(); return false;\"\u003e\n      \u003cp\u003eClient is eligible for services, please complete the below inputs.\u003c/p\u003e\n    \n        \u003cdiv class\u003d\"form-group\"\u003e\n          \u003clabel for\u003d\"householdsize\"\u003e How many tax-filing individuals are we filing for?\u003c/label\u003e\n          \u003cinput type\u003d\"Number\" id\u003d\"householdsize\" name\u003d\"householdsize\" min\u003d\"1\" required\u003e\n        \u003c/div\u003e\n\n        \u003cdiv class\u003d\"form-group\"\u003e\n          \u003clabel\u003eWhich tax years do we need to complete?\u003c/label\u003e\n          \u003cdiv class\u003d\"checkbox-horizontal\"\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"filingYears\" value\u003d\"2025\"\u003e 2025\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"filingYears\" value\u003d\"2024\"\u003e 2024\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"filingYears\" value\u003d\"2023\"\u003e 2023\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"filingYears\" value\u003d\"2022\"\u003e 2022\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"filingYears\" value\u003d\"2021\"\u003e 2021\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"filingYears\" value\u003d\"2020\"\u003e 2020\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"filingYears\" value\u003d\"2019\"\u003e 2019\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"filingYears\" value\u003d\"2018\"\u003e 2018\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"filingYears\" value\u003d\"2017\"\u003e 2017\u003c/label\u003e\n          \u003c/div\u003e\n          \u003cdiv id\u003d\"filingYearsError\" style\u003d\"color: red; margin-top: 5px; display: none;\"\u003e\n            Please select at least one tax year.\n          \u003c/div\u003e\n        \u003c/div\u003e\n\n        \u003cdiv class\u003d\"form-group\"\u003e\n          \u003clabel\u003eWhich situations are applicable?\u003c/label\u003e\n          \u003cdiv class\u003d\"checkbox-horizontal\"\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"situations\" value\u003d\"Student\"\u003e Student\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"situations\" value\u003d\"Employed\"\u003e Employed\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"situations\" value\u003d\"Married/Common-Law\"\u003e Married/Common-Law\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"situations\" value\u003d\"Newcomer\"\u003e Newcomer\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"situations\" value\u003d\"Children\"\u003e Children\u003c/label\u003e\n          \u003c/div\u003e\n        \u003c/div\u003e\n        \u003cbr\u003e\n        \u003cdiv class\u003d\"form-group\"\u003e\n          \u003clabel\u003ePlease briefly identify the documents that client has and complete the checklist.\u003cspan class\u003d\"tooltip\" data-tooltip\u003d\"Refer to the checklist and provided guide for samples of documents\"\u003e?\u003c/span\u003e\u003c/label\u003e\n        \u003c/div\u003e\n        \u003cbr\u003e\n        \u003cdiv class\u003d\"form-group\"\u003e\n          \u003clabel for\u003d\"notes\"\u003eAdditional Notes (optional):\u003c/label\u003e\n          \u003ctextarea id\u003d\"notes\" name\u003d\"notes\" rows\u003d\"3\"\u003e\u003c/textarea\u003e\n        \u003c/div\u003e\n\n        \u003cdiv class\u003d\"form-group\"\u003e\n          \u003clabel\u003e\u003cinput type\u003d\"checkbox\" id\u003d\"needsSeniorReview\" name\u003d\"needsSeniorReview\"\u003e Flag for senior review (please indicate in notes why this is the case)\u003cspan class\u003d\"tooltip\" data-tooltip\u003d\"Couples/families are complex situations. Newcomers/immigrants are not necessarily complex situations unless they are U.S. Citizens. Use judgement accordingly based on provided guidance - panic/confusions/unpreparedness of the client does not warrant senior review.\"\u003e?\u003c/span\u003e\u003c/label\u003e\n        \u003c/div\u003e\n\n      \u003cbutton type\u003d\"submit\"\u003eSubmit\u003c/button\u003e\n    \u003c/form\u003e\n    \u003cdiv id\u003d\"receptionHelpArea\" style\u003d\"text-align: center; margin-top: 30px;\"\u003e\n      \u003cbutton id\u003d\"receptionHelpBtn\" onclick\u003d\"toggleReceptionHelp()\"\u003e Call for Help\u003c/button\u003e\n      \u003cbutton id\u003d\"receptionEscalateBtn\" onclick\u003d\"escalateReceptionHelp()\" style\u003d\"display: none;\"\u003e Escalate to Senior Mentor\u003c/button\u003e\n    \u003c/div\u003e\n  \u003c/div\u003e\n\n  \u003cdiv id\u003d\"confirmationModal\" style\u003d\"display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;\"\u003e\n    \u003cdiv style\u003d\"background:white; padding:30px 40px; border-radius:8px; text-align:center; max-width:300px; margin:auto;\"\u003e\n      \u003ch3 style\u003d\"margin-bottom:20px;\"\u003eClient submitted. Please note the Client ID and direct Client to next stage\u003c/h3\u003e\n      \u003cp style\u003d\"margin-bottom:20px;\"\u003eClient ID: \u003cstrong id\u003d\"clientIDDisplay\"\u003e\u003c/strong\u003e\u003c/p\u003e\n      \u003cbutton onclick\u003d\"closeModal()\" style\u003d\"padding:8px 16px; background-color:#8e0000; color:white; border:none; border-radius:5px; cursor:pointer;\"\u003eReset Form\u003c/button\u003e\n    \u003c/div\u003e\n  \u003c/div\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},{"id":"e7907ee8-f4e4-4551-840c-11569396a894","name":"control_sheet_form","type":"html","source":"\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n  \u003cbase target\u003d\"_top\"\u003e\n  \u003cstyle\u003e\n    :root {\n      --accent-color: rgb(142, 0, 0);\n      --bg-color-light: #ffffff;\n      --text-color-light: #1a1a1a;\n      --input-bg-light: #f2f2f2;\n      --border-light: #ccc;\n\n      --bg-color-dark: #1e1e1e;\n      --text-color-dark: #f0f0f0;\n      --input-bg-dark: #2a2a2a;\n      --border-dark: #444;\n    }\n\n    body.light {\n      background-color: var(--bg-color-light);\n      color: var(--text-color-light);\n    }\n\n    body.dark {\n      background-color: var(--bg-color-dark);\n      color: var(--text-color-dark);\n    }\n\n    body {\n      margin: 0;\n      font-family: \u0027Segoe UI\u0027, Verdana, sans-serif;\n      padding: 20px;\n      transition: background 0.3s, color 0.3s;\n    }\n\n    header {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      margin-bottom: 30px;\n    }\n\n    header h3 {\n      font-family: Verdana, sans-serif;\n      color: var(--accent-color);\n      font-size: 1.5rem;\n      margin: 0;\n    }\n\n    header img {\n      height: 60px;\n    }\n\n    .toggle-theme {\n      cursor: pointer;\n      font-size: 1.4em;\n      margin-left: 10px;\n    }\n\n    .form-row {\n      display: flex;\n      gap: 20px;\n      flex-wrap: wrap;\n      margin-bottom: 20px;\n    }\n\n    label {\n      font-weight: 500;\n    }\n\n    input[list], select {\n      padding: 6px 10px;\n      border-radius: 5px;\n      width: 220px;\n      transition: background 0.3s, color 0.3s, border 0.3s;\n    }\n\n    body.light input[list], body.light select {\n      background-color: var(--input-bg-light);\n      color: var(--text-color-light);\n      border: 1px solid var(--border-light);\n    }\n\n    body.dark input[list], body.dark select {\n      background-color: var(--input-bg-dark);\n      color: var(--text-color-dark);\n      border: 1px solid var(--border-dark);\n    }\n\n    table {\n      width: 100%;\n      border-collapse: collapse;\n      margin-top: 10px;\n    }\n\n    th, td {\n      padding: 10px;\n      text-align: left;\n    }\n\n    body.light th, body.light td {\n      border: 1px solid var(--border-light);\n    }\n\n    body.dark th, body.dark td {\n      border: 1px solid var(--border-dark);\n    }\n\n    th {\n      background-color: #444;\n      color: white;\n    }\n\n    .error-highlight {\n      background-color: #501919 !important;\n    }\n\n    button {\n      padding: 8px 16px;\n      border: none;\n      border-radius: 5px;\n      cursor: pointer;\n      font-weight: 500;\n      background-color: var(--accent-color);\n      color: white;\n      transition: background 0.2s;\n    }\n\n    button:disabled {\n      background-color: #888 !important;\n      cursor: not-allowed;\n    }\n\n    button:hover:not(:disabled) {\n      background-color: #a00000;\n    }\n\n    #messageBox, #errorBox {\n      display: none;\n      padding: 10px;\n      margin: 15px 0;\n      border-radius: 5px;\n    }\n\n    #messageBox {\n      background-color: #27ae60;\n      color: white;\n    }\n\n    #errorBox {\n      background-color: #c0392b;\n      color: white;\n    }\n\n    #confirmModal {\n      display: none;\n      position: fixed;\n      top: 0; left: 0;\n      width: 100%; height: 100%;\n      background: rgba(0, 0, 0, 0.6);\n      z-index: 1000;\n      align-items: center;\n      justify-content: center;\n      animation: fadeIn 0.3s ease-in-out;\n    }\n\n    #confirmModal .modal-content {\n      background-color: #2e2e2e;\n      padding: 20px;\n      border-radius: 10px;\n      width: 300px;\n      text-align: center;\n      color: white;\n      animation: slideIn 0.3s ease;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);\n    }\n\n    @keyframes fadeIn {\n      from { background-color: rgba(0, 0, 0, 0); }\n      to { background-color: rgba(0, 0, 0, 0.6); }\n    }\n\n    @keyframes slideIn {\n      from { transform: scale(0.95); opacity: 0; }\n      to { transform: scale(1); opacity: 1; }\n    }\n\n    #spinner {\n      display: none;\n      margin-top: 10px;\n      text-align: center;\n    }\n\n    .lds-ring {\n      display: inline-block;\n      position: relative;\n      width: 40px;\n      height: 40px;\n    }\n\n    .lds-ring div {\n      box-sizing: border-box;\n      display: block;\n      position: absolute;\n      width: 32px;\n      height: 32px;\n      margin: 4px;\n      border: 4px solid white;\n      border-radius: 50%;\n      animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;\n      border-color: white transparent transparent transparent;\n    }\n\n    .lds-ring div:nth-child(1) { animation-delay: -0.45s; }\n    .lds-ring div:nth-child(2) { animation-delay: -0.3s; }\n    .lds-ring div:nth-child(3) { animation-delay: -0.15s; }\n\n    @keyframes lds-ring {\n      0% { transform: rotate(0deg); }\n      100% { transform: rotate(360deg); }\n    }\n\n    hr {\n      border: 1px solid #333;\n    }\n    #helpBtn {\n      background-color: #cccccc;  /* Neutral gray by default */\n      color: black;\n      padding: 8px 14px;\n      border-radius: 5px;\n      font-weight: bold;\n      border: none;\n      cursor: pointer;\n      transition: background 0.2s ease;\n    }\n\n    #helpBtn:hover {\n      background-color: #b3b3b3;\n    }\n\n    #helpBtn.active {\n      background-color: #f39c12;  /* Bright amber for active state */\n      color: white;\n    }\n    body.light #notesDisplay {\n      background-color: #f2f2f2;\n      color: #1a1a1a;\n    }\n\n    body.dark #notesDisplay {\n      background-color: #2a2a2a;\n      color: #f0f0f0;\n    }\n  \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody class\u003d\"light\" onload\u003d\"loadDropdowns()\"\u003e\n  \u003cheader\u003e\n    \u003ch3\u003eAFSA Tax Clinic Control Sheet\u003c/h3\u003e\n    \u003cdiv\u003e\n      \u003cspan class\u003d\"toggle-theme\" onclick\u003d\"toggleTheme()\"\u003e\u003c/span\u003e\n    \u003c/div\u003e\n  \u003c/header\u003e\n\n  \u003cdiv class\u003d\"form-row\"\u003e\n    \u003cdiv\u003e\n      \u003clabel for\u003d\"volunteer\"\u003eVolunteer:\u003c/label\u003e\u003cbr\u003e\n      \u003cinput id\u003d\"volunteer\" list\u003d\"volunteerList\" placeholder\u003d\"Start typing volunteer name\" oninput\u003d\"updateClients(); checkFormReady();\"\u003e\n      \u003cdatalist id\u003d\"volunteerList\"\u003e\u003c/datalist\u003e\n    \u003c/div\u003e\n    \u003cdiv\u003e\n      \u003clabel for\u003d\"client\"\u003eAssigned Client:\u003c/label\u003e\u003cbr\u003e\n      \u003cselect id\u003d\"client\" onchange\u003d\"checkFormReady();\"\u003e\n        \u003coption value\u003d\"\"\u003eSelect Client\u003c/option\u003e\n      \u003c/select\u003e\n    \u003c/div\u003e\n    \u003cdiv style\u003d\"align-self: end; margin-top: 20px;\"\u003e\n      \u003cbutton id\u003d\"helpBtn\" onclick\u003d\"toggleHelpRequest()\"\u003e Quick Question!/Review\u003c/button\u003e\n      \u003cbutton id\u003d\"escalateBtn\" onclick\u003d\"escalateHelpRequest()\" style\u003d\"display: none;\"\u003e Escalate to Senior Mentor\u003c/button\u003e\n    \u003c/div\u003e\n\u003c/div\u003e\n    \u003cdiv id\u003d\"notesContainer\" style\u003d\"display: none; margin-top: 10px;\"\u003e\n      \u003cstrong\u003eNotes from Reception:\u003c/strong\u003e\n      \u003cdiv id\u003d\"notesDisplay\" style\u003d\"margin-top: 4px; padding: 8px; border-radius: 5px; font-style: italic;\"\u003e\u003c/div\u003e\n    \u003c/div\u003e\n  \u003chr\u003e\n\n  \u003ch3\u003eTax Year Details\u003c/h3\u003e\n  \u003ctable id\u003d\"taxYearTable\"\u003e\n    \u003ctr\u003e\n      \u003cth\u003eTax Year\u003c/th\u003e\n      \u003cth\u003eReviewer\u003c/th\u003e\n      \u003cth\u003eMarried/Common-Law\u003c/th\u003e\n      \u003cth\u003eFiling Status\u003c/th\u003e\n      \u003cth\u003eRemove\u003c/th\u003e\n    \u003c/tr\u003e\n  \u003c/table\u003e\n\n  \u003cbr\u003e\n  \u003cbutton onclick\u003d\"addTaxYearRow()\"\u003eAdd Additional Tax Year\u003c/button\u003e\n  \u003cbr\u003e\u003cbr\u003e\n\n  \u003cdiv id\u003d\"messageBox\"\u003e\u003c/div\u003e\n  \u003cdiv id\u003d\"errorBox\"\u003e\u003c/div\u003e\n  \u003cdiv id\u003d\"spinner\"\u003e\u003cdiv class\u003d\"lds-ring\"\u003e\u003cdiv\u003e\u003c/div\u003e\u003cdiv\u003e\u003c/div\u003e\u003cdiv\u003e\u003c/div\u003e\u003cdiv\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\n\n  \u003cbutton id\u003d\"finalizeBtn\" onclick\u003d\"finalizeReturns()\" disabled\u003eFinalize Returns\u003c/button\u003e\n\n  \u003c!-- Modal --\u003e\n  \u003cdiv id\u003d\"confirmModal\"\u003e\n    \u003cdiv class\u003d\"modal-content\"\u003e\n      \u003cp\u003eAre you sure you\u0027d like to finalize?\u003cbr\u003eHave all returns been finalized/EFILEd at this point?\u003c/p\u003e\n      \u003cbutton onclick\u003d\"proceedFinalize()\"\u003eYes, finalize\u003c/button\u003e\n      \u003cbutton onclick\u003d\"closeModal()\"\u003eCancel\u003c/button\u003e\n    \u003c/div\u003e\n  \u003c/div\u003e\n\n  \u003cscript defer\u003e\n    let volunteerMap \u003d {};\n    let rowCount \u003d 1;\n\n    function toggleTheme() {\n      const body \u003d document.body;\n      const toggle \u003d document.querySelector(\u0027.toggle-theme\u0027);\n      if (body.classList.contains(\u0027dark\u0027)) {\n        body.classList.replace(\u0027dark\u0027, \u0027light\u0027);\n        toggle.textContent \u003d \u0027\u0027;\n      } else {\n        body.classList.replace(\u0027light\u0027, \u0027dark\u0027);\n        toggle.textContent \u003d \u0027\u0027;\n      }\n    }\n\n    function checkFormReady() {\n      const volunteer \u003d document.getElementById(\u0027volunteer\u0027).value.trim();\n      const client \u003d document.getElementById(\u0027client\u0027).value.trim();\n      document.getElementById(\u0027finalizeBtn\u0027).disabled \u003d !(volunteer \u0026\u0026 client);\n    }\n\n    function loadDropdowns() {\n      google.script.run.withSuccessHandler(data \u003d\u003e {\n        volunteerMap \u003d data;\n        const datalist \u003d document.getElementById(\u0027volunteerList\u0027);\n        datalist.innerHTML \u003d \u0027\u0027; // Clear existing\n        Object.keys(volunteerMap).sort().forEach(name \u003d\u003e {\n          const option \u003d document.createElement(\u0027option\u0027);\n          option.value \u003d name;\n          datalist.appendChild(option);\n        });\n        checkFormReady();\n      }).getVolunteersAndClients();\n      setInterval(pollHelpStatus, 10000);\n      document.getElementById(\u0027volunteer\u0027).focus();\n    }\n\n    function updateClients() {\n      const volunteer \u003d document.getElementById(\u0027volunteer\u0027).value;\n      const clientSelect \u003d document.getElementById(\u0027client\u0027);\n      clientSelect.innerHTML \u003d \u0027\u003coption value\u003d\"\"\u003eSelect Client\u003c/option\u003e\u0027;\n\n      if (volunteerMap[volunteer]) {\n        volunteerMap[volunteer].forEach(client \u003d\u003e {\n          const option \u003d document.createElement(\u0027option\u0027);\n          option.value \u003d client;\n          option.textContent \u003d client;\n          clientSelect.appendChild(option);\n        });\n      }\n\n      // Clear tax year table\n      const table \u003d document.getElementById(\u0027taxYearTable\u0027);\n      while (table.rows.length \u003e 1) table.deleteRow(1);\n      rowCount \u003d 1;\n    }\n\n    document.getElementById(\u0027client\u0027).addEventListener(\u0027change\u0027, function () {\n      const clientID \u003d this.value;\n      if (!clientID) {\n        document.getElementById(\u0027notesContainer\u0027).style.display \u003d \u0027none\u0027;\n        return;\n      }\n\n      google.script.run.withSuccessHandler(data \u003d\u003e {\n        preloadTaxYearRows(data);\n        if (data \u0026\u0026 data.notes) {\n          document.getElementById(\u0027notesDisplay\u0027).textContent \u003d data.notes;\n          document.getElementById(\u0027notesContainer\u0027).style.display \u003d \u0027block\u0027;\n        } else {\n          document.getElementById(\u0027notesDisplay\u0027).textContent \u003d \u0027\u0027;\n          document.getElementById(\u0027notesContainer\u0027).style.display \u003d \u0027none\u0027;\n        }\n      }).getClientIntakeInfo(clientID);\n    });\n\n    function addTaxYearRow() {\n      google.script.run.withSuccessHandler(data \u003d\u003e {\n        const reviewerOptions \u003d data.reviewers;\n        const seniorOptions \u003d data.seniors;\n\n        const table \u003d document.getElementById(\u0027taxYearTable\u0027);\n        const row \u003d table.insertRow();\n        const taxYearOptions \u003d Array.from({ length: 16 }, (_, i) \u003d\u003e (2025 - i).toString());\n\n        row.innerHTML \u003d `\n          \u003ctd\u003e\n            \u003cselect name\u003d\"taxYear\"\u003e\n              ${taxYearOptions.map(y \u003d\u003e `\u003coption value\u003d\"${y}\" ${y \u003d\u003d\u003d \u00272024\u0027 ? \u0027selected\u0027 : \u0027\u0027}\u003e${y}\u003c/option\u003e`).join(\u0027\u0027)}\n            \u003c/select\u003e\n          \u003c/td\u003e\n          \u003ctd\u003e\n            \u003cinput list\u003d\"reviewerList${rowCount}\" name\u003d\"reviewer\" placeholder\u003d\"Start typing reviewer\"\u003e\n            \u003cdatalist id\u003d\"reviewerList${rowCount}\"\u003e\n              ${reviewerOptions.map(r \u003d\u003e `\u003coption value\u003d\"${r}\"\u003e`).join(\u0027\u0027)}\n            \u003c/datalist\u003e\n            ${needsSeniorReview ? `\n              \u003cbr\u003e\n              \u003cinput list\u003d\"reviewerList${rowCount}_secondary\" name\u003d\"secondaryReviewer\" placeholder\u003d\"Start typing Senior reviewer\"\u003e\n              \u003cdatalist id\u003d\"reviewerList${rowCount}_secondary\"\u003e\n                ${seniorOptions.map(r \u003d\u003e `\u003coption value\u003d\"${r}\"\u003e`).join(\u0027\u0027)}\n              \u003c/datalist\u003e\n            ` : \u0027\u0027}\n          \u003c/td\u003e\n          \u003ctd\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"married\" ${isMarried ? \"checked\" : \"\"}\u003e\u003c/td\u003e\n          \u003ctd\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"filingStatus${rowCount}\" value\u003d\"efile\"\u003e EFILE\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"filingStatus${rowCount}\" value\u003d\"paper\"\u003e Paper\u003c/label\u003e\n            \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"filingStatus${rowCount}\" value\u003d\"incomplete\"\u003e Incomplete\u003c/label\u003e\n          \u003c/td\u003e\n          \u003ctd\u003e\u003cbutton onclick\u003d\"removeRow(this)\"\u003eRemove\u003c/button\u003e\u003c/td\u003e\n        `;\n        rowCount++;\n      }).getMentorList();\n    }\n\n    function pollHelpStatus() {\n      const volunteer \u003d document.getElementById(\u0027volunteer\u0027).value;\n      if (!volunteer) return;\n\n      google.script.run.withSuccessHandler(status \u003d\u003e {\n        const helpBtn \u003d document.getElementById(\u0027helpBtn\u0027);\n        const escalateBtn \u003d document.getElementById(\u0027escalateBtn\u0027);\n\n        if (status \u003d\u003d\u003d \"active\" || status \u003d\u003d\u003d \"escalated\") {\n          helpActive \u003d true;\n          helpBtn.textContent \u003d \u0027 Cancel Call\u0027;\n          helpBtn.classList.add(\u0027active\u0027);\n          escalateBtn.style.display \u003d \u0027inline-block\u0027;\n          escalateBtn.disabled \u003d (status \u003d\u003d\u003d \"escalated\");\n        } else {\n          helpActive \u003d false;\n          helpBtn.textContent \u003d \u0027 Quick Question!/Review\u0027;\n          helpBtn.classList.remove(\u0027active\u0027);\n          escalateBtn.style.display \u003d \u0027none\u0027;\n        }\n      }).getHelpStatus(volunteer);\n    }\n\n    // Poll every 10 seconds\n\n    function finalizeReturns() {\n      const volunteer \u003d document.getElementById(\u0027volunteer\u0027).value;\n      const client \u003d document.getElementById(\u0027client\u0027).value;\n      if (!volunteer || !client) {\n        showError(\u0027Please select both a volunteer and a client.\u0027);\n        return;\n      }\n      document.getElementById(\u0027confirmModal\u0027).style.display \u003d \u0027flex\u0027;\n    }\n\n    function proceedFinalize() {\n      closeModal();\n      document.getElementById(\u0027spinner\u0027).style.display \u003d \u0027block\u0027;\n\n      const volunteer \u003d document.getElementById(\u0027volunteer\u0027).value;\n      const client \u003d document.getElementById(\u0027client\u0027).value;\n      const rows \u003d [];\n      const taxYears \u003d new Set();\n      const table \u003d document.getElementById(\u0027taxYearTable\u0027);\n\n      for (let i \u003d 1; i \u003c table.rows.length; i++) {\n        const row \u003d table.rows[i];\n        row.classList.remove(\"error-highlight\");\n\n        const taxYear \u003d row.querySelector(\u0027select[name\u003d\"taxYear\"]\u0027).value;\n        const reviewer \u003d row.querySelector(\u0027input[name\u003d\"reviewer\"]\u0027).value.trim();\n        const secondaryReviewer \u003d row.querySelector(\u0027input[name\u003d\"secondaryReviewer\"]\u0027)?.value.trim() || \"\";\n        const married \u003d row.querySelector(\u0027input[name\u003d\"married\"]\u0027).checked;\n        const statusGroup \u003d row.querySelectorAll(`input[name\u003d\"filingStatus${i}\"]`);\n        let selectedStatus \u003d \"\";\n        statusGroup.forEach(r \u003d\u003e { if (r.checked) selectedStatus \u003d r.value; });\n\n        if (!reviewer || !selectedStatus || taxYears.has(taxYear)) {\n          row.classList.add(\"error-highlight\");\n          showError(`Please correct tax year ${taxYear}.`);\n          document.getElementById(\u0027spinner\u0027).style.display \u003d \u0027none\u0027;\n          return;\n        }\n\n        taxYears.add(taxYear);\n        rows.push({\n          taxYear,\n          reviewer,\n          secondaryReviewer,\n          married,\n          efile: selectedStatus \u003d\u003d\u003d \"efile\",\n          paper: selectedStatus \u003d\u003d\u003d \"paper\",\n          incomplete: selectedStatus \u003d\u003d\u003d \"incomplete\"\n        });\n      }\n\n      google.script.run.withSuccessHandler(success \u003d\u003e {\n        document.getElementById(\u0027spinner\u0027).style.display \u003d \u0027none\u0027;\n        if (success) {\n          showMessage(\u0027Returns finalized. Please direct client to exit receptionist.\u0027, true);\n          loadDropdowns();\n          setTimeout(clearForm, 5000);\n        } else {\n          showError(\u0027Could not finalize. Please try again.\u0027);\n        }\n      }).finalizeReturnsAndStore(volunteer, client, rows);\n    }\n\n    function closeModal() {\n      document.getElementById(\u0027confirmModal\u0027).style.display \u003d \u0027none\u0027;\n    }\n\n    function showError(message) {\n      const box \u003d document.getElementById(\u0027errorBox\u0027);\n      box.textContent \u003d message;\n      box.style.display \u003d \u0027block\u0027;\n      setTimeout(() \u003d\u003e box.style.display \u003d \u0027none\u0027, 5000);\n    }\n\n    function showMessage(message, success \u003d false) {\n      const box \u003d document.getElementById(\u0027messageBox\u0027);\n      box.textContent \u003d message;\n      box.style.backgroundColor \u003d success ? \u0027#27ae60\u0027 : \u0027#c0392b\u0027;\n      box.style.display \u003d \u0027block\u0027;\n      setTimeout(() \u003d\u003e box.style.display \u003d \u0027none\u0027, 5000);\n    }\n\n    function clearForm() {\n      document.getElementById(\u0027volunteer\u0027).value \u003d \u0027\u0027;\n      document.getElementById(\u0027client\u0027).innerHTML \u003d \u0027\u003coption value\u003d\"\"\u003eSelect Client\u003c/option\u003e\u0027;\n      const table \u003d document.getElementById(\u0027taxYearTable\u0027);\n      while (table.rows.length \u003e 1) table.deleteRow(1);\n      rowCount \u003d 1;\n    }\n\n    function removeRow(button) {\n      const row \u003d button.closest(\u0027tr\u0027);\n      row.remove();\n    }\n\n    let helpActive \u003d false;\n    function toggleHelpRequest() {\n      const volunteer \u003d document.getElementById(\u0027volunteer\u0027).value;\n      const helpBtn \u003d document.getElementById(\u0027helpBtn\u0027);\n      const escalateBtn \u003d document.getElementById(\u0027escalateBtn\u0027);\n\n      if (!volunteer) {\n        showError(\u0027Please select a volunteer before calling for help.\u0027);\n        return;\n      }\n\n      helpActive \u003d !helpActive;\n\n      if (helpActive) {\n        google.script.run.withSuccessHandler(() \u003d\u003e {\n          showMessage(\u0027Help request sent.\u0027);\n          helpBtn.textContent \u003d \u0027 Cancel Call\u0027;\n          helpBtn.classList.add(\u0027active\u0027);\n          escalateBtn.style.display \u003d \u0027inline-block\u0027;  // Show escalate button\n          escalateBtn.disabled \u003d false; // Enable it\n        }).sendHelpRequest(volunteer);\n      } else {\n        google.script.run.withSuccessHandler(() \u003d\u003e {\n          showMessage(\u0027Help request cleared.\u0027);\n          helpBtn.textContent \u003d \u0027 Call for Help\u0027;\n          helpBtn.classList.remove(\u0027active\u0027);\n          escalateBtn.style.display \u003d \u0027none\u0027;          // Hide on cancel\n        }).clearHelpRequest(volunteer);\n      }\n    }\n    function escalateHelpRequest() {\n      const volunteer \u003d document.getElementById(\u0027volunteer\u0027).value;\n      const escalateBtn \u003d document.getElementById(\u0027escalateBtn\u0027);\n\n      if (!volunteer) {\n        showError(\u0027Please select a volunteer before escalating.\u0027);\n        return;\n      }\n\n      google.script.run.withSuccessHandler(() \u003d\u003e {\n        showMessage(`Help request escalated for ${volunteer}.`);\n        escalateBtn.disabled \u003d true;\n      }).escalateHelpRequest(volunteer);\n    }\n    function preloadTaxYearRows(data) {\n      if (!data || !data.filingYears || data.filingYears.length \u003d\u003d\u003d 0) return;\n\n      // Reset current rows\n      const table \u003d document.getElementById(\u0027taxYearTable\u0027);\n      while (table.rows.length \u003e 1) table.deleteRow(1);\n      rowCount \u003d 1;\n\n      const isMarried \u003d data.situations?.includes(\"Married/Common-Law\");\n      const needsSeniorReview \u003d data?.needsSeniorReview \u003d\u003d\u003d true;\n      // Fetch mentor list first\n        google.script.run.withSuccessHandler(data \u003d\u003e {\n          const reviewerOptions \u003d data.reviewers;\n          const seniorOptions \u003d data.seniors;\n\n          const table \u003d document.getElementById(\u0027taxYearTable\u0027);\n          const row \u003d table.insertRow();\n          const taxYearOptions \u003d Array.from({ length: 16 }, (_, i) \u003d\u003e (2025 - i).toString());\n\n          row.innerHTML \u003d `\n            \u003ctd\u003e\n              \u003cselect name\u003d\"taxYear\"\u003e\n                ${taxYearOptions.map(y \u003d\u003e `\u003coption value\u003d\"${y}\" ${y \u003d\u003d\u003d \u00272024\u0027 ? \u0027selected\u0027 : \u0027\u0027}\u003e${y}\u003c/option\u003e`).join(\u0027\u0027)}\n              \u003c/select\u003e\n            \u003c/td\u003e\n            \u003ctd\u003e\n              \u003cinput list\u003d\"reviewerList${rowCount}\" name\u003d\"reviewer\" placeholder\u003d\"Start typing reviewer\"\u003e\n              \u003cdatalist id\u003d\"reviewerList${rowCount}\"\u003e\n                ${reviewerOptions.map(r \u003d\u003e `\u003coption value\u003d\"${r}\"\u003e`).join(\u0027\u0027)}\n              \u003c/datalist\u003e\n              ${needsSeniorReview ? `\n                \u003cbr\u003e\n                \u003cinput list\u003d\"reviewerList${rowCount}_secondary\" name\u003d\"secondaryReviewer\" placeholder\u003d\"Start typing Senior reviewer\"\u003e\n                \u003cdatalist id\u003d\"reviewerList${rowCount}_secondary\"\u003e\n                  ${seniorOptions.map(r \u003d\u003e `\u003coption value\u003d\"${r}\"\u003e`).join(\u0027\u0027)}\n                \u003c/datalist\u003e\n              ` : \u0027\u0027}\n            \u003c/td\u003e\n            \u003ctd\u003e\u003cinput type\u003d\"checkbox\" name\u003d\"married\"\u003e\u003c/td\u003e\n            \u003ctd\u003e\n              \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"filingStatus${rowCount}\" value\u003d\"efile\"\u003e EFILE\u003c/label\u003e\n              \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"filingStatus${rowCount}\" value\u003d\"paper\"\u003e Paper\u003c/label\u003e\n              \u003clabel\u003e\u003cinput type\u003d\"radio\" name\u003d\"filingStatus${rowCount}\" value\u003d\"incomplete\"\u003e Incomplete\u003c/label\u003e\n            \u003c/td\u003e\n            \u003ctd\u003e\u003cbutton onclick\u003d\"removeRow(this)\"\u003eRemove\u003c/button\u003e\u003c/td\u003e\n          `;\n          rowCount++;\n        }).getMentorList();\n    }\n  \u003c/script\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},{"id":"4f3c8f15-de42-4137-8c8c-45ea6f3612da","name":"queue_dashboard","type":"html","source":"\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n  \u003cbase target\u003d\"_top\"\u003e\n  \u003cstyle\u003e\n    :root {\n      --accent-color: rgb(142, 0, 0);\n      --bg-color-light: #ffffff;\n      --text-color-light: #1a1a1a;\n      --input-bg-light: #f2f2f2;\n      --border-light: #ccc;\n      --bg-color-dark: #1e1e1e;\n      --text-color-dark: #f0f0f0;\n      --input-bg-dark: #2a2a2a;\n      --border-dark: #444;\n    }\n\n    body.light {\n      background-color: var(--bg-color-light);\n      color: var(--text-color-light);\n    }\n\n    body.dark {\n      background-color: var(--bg-color-dark);\n      color: var(--text-color-dark);\n    }\n\n    /* Fix for warning rows in dark mode */\n    body.dark .warning-wait {\n      background-color: #ffee99; /* brighter yellow */\n      color: #1a1a1a; /* dark text for readability */\n    }\n\n    /* Fix for danger rows in dark mode */\n    body.dark .danger-wait {\n      background-color: #ff6666; /* deeper red */\n      color: #ffffff; /* white text is still okay here */\n    }\n\n    body {\n      margin: 0;\n      font-family: \u0027Segoe UI\u0027, Verdana, sans-serif;\n      padding: 20px;\n      transition: background 0.3s, color 0.3s;\n    }\n\n    header {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      margin-bottom: 30px;\n    }\n\n    header h3 {\n      font-family: Verdana, sans-serif;\n      color: var(--accent-color);\n      font-size: 1.5rem;\n      margin: 0 auto;\n      text-align: center;\n    }\n\n    .form-wrapper {\n      max-width: 800px;\n      margin: 0 auto;\n    }\n\n    table {\n      width: 100%;\n      border-collapse: collapse;\n      margin-bottom: 30px;\n    }\n\n    th, td {\n      border: 1px solid var(--border-light);\n      padding: 10px;\n      text-align: left;\n    }\n\n    th {\n      background-color: var(--accent-color);\n      color: white;\n    }\n\n    .assign-form {\n      display: flex;\n      gap: 10px;\n      align-items: center;\n      flex-wrap: wrap;\n    }\n\n    select, button {\n      padding: 8px;\n      border: 1px solid var(--border-light);\n      border-radius: 5px;\n    }\n\n    button {\n      background-color: var(--accent-color);\n      color: white;\n      cursor: pointer;\n      transition: background 0.2s;\n    }\n\n    button:hover {\n      background-color: #a00000;\n    }\n\n    .toggle-theme {\n      cursor: pointer;\n      font-size: 1.4em;\n    }\n    .warning-wait {\n      background-color: #fff3cd; /* yellow */\n    }\n\n    .danger-wait {\n      background-color: #ffcccc; /* red */\n    }\n\n    .pulse {\n      animation: pulseAnim 1.5s infinite;\n    }\n\n    @keyframes pulseAnim {\n      0% { opacity: 1; }\n      50% { opacity: 0.6; }\n      100% { opacity: 1; }\n    }\n\n\n  \u003c/style\u003e\n  \u003cscript\u003e\n  let clientQueue \u003d [];\n  let volunteers \u003d [];\n  let lastSerializedData \u003d \"\";  // \u003c--- NEW: used to detect changes\n\n  function toggleTheme() {\n    const body \u003d document.body;\n    body.classList.toggle(\u0027dark\u0027);\n    body.classList.toggle(\u0027light\u0027);\n  }\n\n  function loadQueue() {\n    google.script.run.withSuccessHandler(data \u003d\u003e {\n      const serialized \u003d JSON.stringify(data);\n\n      // Only re-render if data actually changed\n      if (serialized !\u003d\u003d lastSerializedData) {\n        lastSerializedData \u003d serialized;\n        clientQueue \u003d data.clients;\n        volunteers \u003d data.volunteers;\n        renderQueue();\n        populateVolunteerDropdown();\n      }\n    }).getQueueData();\n  }\n\n  //  NEW: Auto-refresh every 7 seconds\n  setInterval(loadQueue, 7000);\n\n  function renderQueue() {\n    const tbody \u003d document.getElementById(\u0027queueBody\u0027);\n    const queueCount \u003d document.getElementById(\u0027queueCount\u0027);\n    tbody.innerHTML \u003d \u0027\u0027;\n\n    const sortedQueue \u003d [...clientQueue].sort((a, b) \u003d\u003e {\n      return parseWaitTimeToMinutes(b.waitTime) - parseWaitTimeToMinutes(a.waitTime);\n    });\n\n    sortedQueue.forEach(client \u003d\u003e {\n      const row \u003d document.createElement(\u0027tr\u0027);\n      const waitMins \u003d parseWaitTimeToMinutes(client.waitTime);\n\n      if (waitMins \u003e\u003d 30) {\n        row.classList.add(\u0027danger-wait\u0027, \u0027pulse\u0027);\n      } else if (waitMins \u003e\u003d 15) {\n        row.classList.add(\u0027warning-wait\u0027);\n      }\n\n      row.innerHTML \u003d `\n        \u003ctd\u003e${client.clientId}\u003c/td\u003e\n        \u003ctd\u003e${client.waitTime}\u003c/td\u003e\n      `;\n      tbody.appendChild(row);\n    });\n\n    queueCount.textContent \u003d `Total clients in queue: ${sortedQueue.length}`;\n  }\n\n  function populateVolunteerDropdown() {\n    const volunteerSelect \u003d document.getElementById(\u0027volunteerSelect\u0027);\n    const clientSelect \u003d document.getElementById(\u0027clientSelect\u0027);\n    volunteerSelect.innerHTML \u003d \u0027\u003coption value\u003d\"\"\u003eSelect Volunteer\u003c/option\u003e\u0027;\n    clientSelect.innerHTML \u003d \u0027\u003coption value\u003d\"\"\u003eSelect Client\u003c/option\u003e\u0027;\n\n    volunteers.forEach(name \u003d\u003e {\n      volunteerSelect.innerHTML +\u003d `\u003coption value\u003d\"${name}\"\u003e${name}\u003c/option\u003e`;\n    });\n\n    clientQueue.forEach(c \u003d\u003e {\n      clientSelect.innerHTML +\u003d `\u003coption value\u003d\"${c.clientId}\"\u003e${c.clientId}\u003c/option\u003e`;\n    });\n  }\n\n  function assignClient() {\n    const client \u003d document.getElementById(\u0027clientSelect\u0027).value;\n    const volunteer \u003d document.getElementById(\u0027volunteerSelect\u0027).value;\n    if (!client || !volunteer) return alert(\u0027Please select both a client and a volunteer.\u0027);\n\n    google.script.run.withSuccessHandler(() \u003d\u003e {\n      const msg \u003d `Client ${client} has been assigned to ${volunteer}.`;\n      document.getElementById(\u0027modalMessage\u0027).textContent \u003d msg;\n      document.getElementById(\u0027confirmationModal\u0027).style.display \u003d \u0027flex\u0027;\n    }).assignClientToVolunteer(client, volunteer);\n  }\n\n  function refreshAfterModal() {\n    document.getElementById(\u0027confirmationModal\u0027).style.display \u003d \u0027none\u0027;\n    loadQueue();\n  }\n\n  function parseWaitTimeToMinutes(waitStr) {\n    const parts \u003d waitStr.split(\u0027 \u0027);\n    let total \u003d 0;\n    for (const part of parts) {\n      if (part.endsWith(\u0027h\u0027)) total +\u003d parseInt(part) * 60;\n      if (part.endsWith(\u0027m\u0027)) total +\u003d parseInt(part);\n    }\n    return total;\n  }\n\n  window.onload \u003d loadQueue;\n\u003c/script\u003e\n\u003c/head\u003e\n\u003cbody class\u003d\"light\"\u003e\n  \u003cheader\u003e\n    \u003ch3\u003eAFSA Tax Clinic Queue Dashboard\u003c/h3\u003e\n    \u003cspan class\u003d\"toggle-theme\" onclick\u003d\"toggleTheme()\"\u003e\u003c/span\u003e\n  \u003c/header\u003e\n\n  \u003cdiv class\u003d\"form-wrapper\"\u003e\n    \u003ch4\u003eClient Queue\u003c/h4\u003e\n    \u003ctable\u003e\n      \u003cp id\u003d\"queueCount\" style\u003d\"margin-top: -10px; margin-bottom: 10px; font-weight: bold;\"\u003e\u003c/p\u003e\n      \u003cthead\u003e\n        \u003ctr\u003e\n          \u003cth\u003eClient ID\u003c/th\u003e\n          \u003cth\u003eWait Time\u003c/th\u003e\n        \u003c/tr\u003e\n      \u003c/thead\u003e\n      \u003ctbody id\u003d\"queueBody\"\u003e\n        \u003c!-- Filled by JS --\u003e\n      \u003c/tbody\u003e\n    \u003c/table\u003e\n\n    \u003ch4\u003eAssign Client to Volunteer\u003c/h4\u003e\n    \u003cdiv class\u003d\"assign-form\"\u003e\n      \u003cselect id\u003d\"clientSelect\"\u003e\u003c/select\u003e\n      \u003cselect id\u003d\"volunteerSelect\"\u003e\u003c/select\u003e\n      \u003cbutton onclick\u003d\"assignClient()\"\u003eAssign\u003c/button\u003e\n    \u003c/div\u003e\n  \u003c/div\u003e\n  \u003cdiv id\u003d\"confirmationModal\" style\u003d\"display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;\"\u003e\n  \u003cdiv style\u003d\"background:white; color:#1a1a1a; padding:30px; border-radius:10px; max-width:400px; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,0.3);\"\u003e\n    \u003cp id\u003d\"modalMessage\" style\u003d\"font-size:1.1rem;\"\u003eClient has been assigned to volunteer.\u003c/p\u003e\n    \u003cbutton onclick\u003d\"refreshAfterModal()\" style\u003d\"margin-top:15px; padding:8px 20px; background-color:rgb(142, 0, 0); color:white; border:none; border-radius:5px; cursor:pointer;\"\u003eOK\u003c/button\u003e\n  \u003c/div\u003e\n\u003c/div\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},{"id":"b21338f8-c218-4792-8ee9-4c3626bbeef4","name":"Router","type":"server_js","source":"/**\n * Router for Web App Deployments\n * Routes requests to the correct app based on query parameter\n */\n\n/**\n * Main entry point for all web app deployments\n * Routes to the correct app based on the \u0027app\u0027 query parameter\n * Defaults to \u0027intake\u0027 if no parameter is provided\n * \n * @param {Object} e - Event object with query parameters\n * @returns {HtmlOutput} The HTML output for the requested app\n */\nfunction doGet(e) {\n  const app \u003d e?.parameter?.app || \u0027intake\u0027; // Default to intake if no parameter\n  \n  switch(app) {\n    case \u0027intake\u0027:\n      return doGetClientIntake();\n    case \u0027queue\u0027:\n      return doGetQueueDashboard();\n    case \u0027control\u0027:\n      return doGetControlSheet();\n    case \u0027admin\u0027:\n      return doGetAdminDashboard();\n    default:\n      return doGetClientIntake(); // Default fallback to intake\n  }\n}\n"}]}