<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    :root {
      --accent-color: rgb(142, 0, 0);
      --bg-color-light: #f5f5f5;
      --text-color-light: #1a1a1a;
      --input-bg-light: #ffffff;
      --border-light: #e0e0e0;
      --bg-color-dark: #1e1e1e;
      --text-color-dark: #f0f0f0;
      --input-bg-dark: #2a2a2a;
      --border-dark: #444;
      --success-color: #27ae60;
      --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    body.light {
      background-color: var(--bg-color-light);
      color: var(--text-color-light);
    }

    body.dark {
      background-color: var(--bg-color-dark);
      color: var(--text-color-dark);
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Verdana, sans-serif;
      padding: 30px 20px;
      transition: background 0.3s, color 0.3s;
      max-width: 1200px;
      margin: 0 auto;
      line-height: 1.6;
    }

    h1, h2, h3 {
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .request {
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 12px;
      color: white;
      font-weight: 600;
      box-shadow: var(--shadow-light);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .request:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-hover);
    }
    .toggle-theme {
      cursor: pointer;
      font-size: 1.4em;
      margin-left: 10px;
    }
    .request.active {
      background-color: #f4b400;
    }

    .request.escalated {
      background-color: #d93025;
      animation: pulse 1.2s infinite;
    }

    .request.review {
      background-color: #4285f4;
    }

    h3 {
      margin-top: 40px;
      margin-bottom: 20px;
      font-size: 1.3em;
      color: var(--accent-color);
      border-bottom: 2px solid var(--accent-color);
      padding-bottom: 8px;
    }

    h3:first-of-type {
      margin-top: 0;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.03); opacity: 0.9; }
      100% { transform: scale(1); opacity: 1; }
    }

    .summary-box {
      background: var(--input-bg-light);
      padding: 30px;
      border-radius: 12px;
      margin-top: 30px;
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-light);
      transition: box-shadow 0.3s;
    }

    .summary-box:hover {
      box-shadow: var(--shadow-hover);
    }

    body.dark .summary-box {
      background-color: var(--input-bg-dark);
      border-color: var(--border-dark);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    body.dark .summary-box:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    canvas {
      margin-top: 20px;
      width: 100%;
      max-width: 400px;  /* controls how wide the chart can go */
      height: auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }

    header h1 {
      font-size: 2em;
      color: var(--accent-color);
    }

    .return-item {
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      border: 2px solid var(--border-light);
      box-shadow: var(--shadow-light);
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s, border 0.3s;
    }

    .return-item:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-hover);
    }

    body.light .return-item {
      background-color: var(--input-bg-light);
      border-color: var(--border-light);
    }

    body.dark .return-item {
      background-color: var(--input-bg-dark);
      border-color: var(--border-dark);
    }

    .return-info strong {
      color: var(--accent-color);
      font-size: 1.1em;
    }

    /* Volunteer performance lists */
    #topVolunteersAllTime ol,
    #topVolunteersToday ol {
      padding-left: 20px;
      margin: 10px 0;
    }

    #topVolunteersAllTime li,
    #topVolunteersToday li {
      padding: 8px 0;
      line-height: 1.6;
    }

    body.light #topVolunteersAllTime li,
    body.light #topVolunteersToday li {
      color: var(--text-color-light);
    }

    body.dark #topVolunteersAllTime li,
    body.dark #topVolunteersToday li {
      color: var(--text-color-dark);
    }

    #topVolunteersAllTime strong,
    #topVolunteersToday strong {
      color: var(--accent-color);
    }

    #topVolunteersAllTime p,
    #topVolunteersToday p {
      font-style: italic;
      opacity: 0.7;
    }

    .summary-box h4 {
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 1.1em;
      font-weight: 600;
      color: var(--accent-color);
    }

    .footer-copyright {
      position: fixed;
      bottom: 10px;
      right: 20px;
      font-size: 11px;
      opacity: 0.6;
      transition: opacity 0.3s, color 0.3s;
      z-index: 1000;
      pointer-events: none;
      max-width: 400px;
      text-align: right;
      line-height: 1.3;
    }

    body.light .footer-copyright {
      color: var(--text-color-light);
    }

    body.dark .footer-copyright {
      color: var(--text-color-dark);
    }

    .footer-copyright:hover {
      opacity: 0.8;
    }
  </style>
</head>
<body class="light">
  <header>
    <div>
      <span class="toggle-theme" onclick="toggleTheme()">‚òÄÔ∏è</span>
    </div>
  </header>

  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <h3 style="margin: 0;">üö® AFSA Tax Clinic QQ Dashboard</h3>
    <button onclick="refresh()" style="padding: 8px 16px; font-size: 0.9em; background-color: var(--accent-color); color: white; border: none; border-radius: 5px; cursor: pointer;">üîÑ Refresh</button>
  </div>
  <div id="container">Loading help requests...</div>

  <h3>üìã Review Requests</h3>
  <div id="reviewContainer">Loading review requests...</div>

  <div class="summary-box">
    <h3>üìä Return Completion Summary</h3>
    <p>Total Completed: <strong id="totalCount">0</strong></p>
    <p>Completed Today: <strong id="todayCount">0</strong></p>
    <canvas id="completionChart" width = "400" height = "200"></canvas>
  </div>

  <div class="summary-box">
    <h3>üèÜ Volunteer Performance</h3>
    <p>Total Active Volunteers: <strong id="totalVolunteers">0</strong></p>
    <p>Average Returns per Volunteer: <strong id="avgReturns">0</strong></p>

    <h4 style="margin-top: 20px;">Top 10 All-Time</h4>
    <div id="topVolunteersAllTime"></div>

    <h4 style="margin-top: 20px;">Top 10 Today</h4>
    <div id="topVolunteersToday"></div>
  </div>

  <div id="messageBox"></div>
  <div id="errorBox"></div>

<?!= include('shared_scripts') ?>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let lastRequestsSerialized = "";
  let lastReviewRequestsSerialized = "";
  let lastSummarySerialized = "";
  let lastPerformanceSerialized = "";
  let chartInstance = null;   // persist chart instead of recreating


  function render(requests) {
    const serialized = JSON.stringify(requests);
    if (serialized === lastRequestsSerialized) return;  // no changes ‚Üí do nothing
    lastRequestsSerialized = serialized;

    const container = document.getElementById("container");
    container.innerHTML = "";

    if (requests.length === 0) {
      container.innerHTML = "<p>No active or escalated help requests.</p>";
      return;
    }

    for (const req of requests) {
      const div = document.createElement("div");
      div.className = `request ${req.status}`;
      div.innerHTML = `
        <div><strong>${escapeHtml(req.volunteer)}</strong></div>
        <div>‚è±Ô∏è ${req.minutesAgo} minutes ago</div>
        <div>üïí ${escapeHtml(req.timestamp)}</div>
      `;
      container.appendChild(div);
    }
  }

  function renderReviewRequests(requests) {
    const serialized = JSON.stringify(requests);
    if (serialized === lastReviewRequestsSerialized) return;  // no changes ‚Üí do nothing
    lastReviewRequestsSerialized = serialized;

    const container = document.getElementById("reviewContainer");
    container.innerHTML = "";

    if (requests.length === 0) {
      container.innerHTML = "<p>No active review requests.</p>";
      return;
    }

    for (const req of requests) {
      const div = document.createElement("div");
      div.className = `request review`;
      div.innerHTML = `
        <div><strong>${escapeHtml(req.volunteer)}</strong></div>
        <div>‚è±Ô∏è ${req.minutesAgo} minutes ago</div>
        <div>üïí ${escapeHtml(req.timestamp)}</div>
      `;
      container.appendChild(div);
    }
  }

  function renderSummary(data) {
    const serialized = JSON.stringify(data);
    if (serialized === lastSummarySerialized) return; // unchanged ‚Üí skip
    lastSummarySerialized = serialized;

    document.getElementById("totalCount").textContent = data.totalCompleted;
    document.getElementById("todayCount").textContent = data.completedToday;

    const labels = Object.keys(data.hourlyCounts).map(h => `${h}:00`);
    const counts = Object.values(data.hourlyCounts);

    const ctx = document.getElementById("completionChart").getContext("2d");

    // If a chart exists, update it instead of creating a new one
    if (chartInstance) {
      chartInstance.data.labels = labels;
      chartInstance.data.datasets[0].data = counts;
      chartInstance.update();
    } else {
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: "Returns Completed",
            data: counts,
            backgroundColor: '#8e0000'
          }]
        },
        options: {
          animation: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }
  }


  function renderPerformanceMetrics(data) {
    const serialized = JSON.stringify(data);
    if (serialized === lastPerformanceSerialized) return; // unchanged ‚Üí skip
    lastPerformanceSerialized = serialized;

    document.getElementById("totalVolunteers").textContent = data.totalVolunteers;
    document.getElementById("avgReturns").textContent = data.avgReturnsPerVolunteer;

    // Render top all-time volunteers
    const allTimeContainer = document.getElementById("topVolunteersAllTime");
    allTimeContainer.innerHTML = "";
    if (data.topVolunteers.length === 0) {
      allTimeContainer.innerHTML = "<p>No data available</p>";
    } else {
      const allTimeList = document.createElement("ol");
      allTimeList.style.paddingLeft = "20px";
      data.topVolunteers.forEach(vol => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${escapeHtml(vol.name)}</strong>: ${vol.count} returns`;
        allTimeList.appendChild(li);
      });
      allTimeContainer.appendChild(allTimeList);
    }

    // Render top today volunteers
    const todayContainer = document.getElementById("topVolunteersToday");
    todayContainer.innerHTML = "";
    if (data.todayVolunteers.length === 0) {
      todayContainer.innerHTML = "<p>No returns completed today yet</p>";
    } else {
      const todayList = document.createElement("ol");
      todayList.style.paddingLeft = "20px";
      data.todayVolunteers.forEach(vol => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${escapeHtml(vol.name)}</strong>: ${vol.count} returns`;
        todayList.appendChild(li);
      });
      todayContainer.appendChild(todayList);
    }
  }

  function refresh() {
    google.script.run.withSuccessHandler(function(data) {
      render(data.helpRequests);
      renderReviewRequests(data.reviewRequests);
      renderSummary(data.returnSummary);
      renderPerformanceMetrics(data.performanceMetrics);
    }).getAdminDashboardData();
  }

  // Initial load
  window.addEventListener('load', function() {
    refresh();
  });

  // Auto-refresh every 30 seconds
  setInterval(refresh, 30000);
</script>
<div class="footer-copyright">The Client And Tax Booking Utility System (CATBUS) is designed for use only by UW AFSA Tax Clinic.</div>
</body>
</html>
