<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    :root {
      --accent-color: rgb(142, 0, 0);
      --bg-color-light: #f5f5f5;
      --text-color-light: #1a1a1a;
      --input-bg-light: #ffffff;
      --border-light: #e0e0e0;
      --bg-color-dark: #1e1e1e;
      --text-color-dark: #f0f0f0;
      --input-bg-dark: #2a2a2a;
      --border-dark: #444;
      --success-color: #27ae60;
      --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    body.light {
      background-color: var(--bg-color-light);
      color: var(--text-color-light);
    }

    body.dark {
      background-color: var(--bg-color-dark);
      color: var(--text-color-dark);
    }

    /* Fix for warning rows in dark mode */
    body.dark .warning-wait {
      background-color: #ffee99; /* brighter yellow */
      color: #1a1a1a; /* dark text for readability */
    }

    /* Fix for danger rows in dark mode */
    body.dark .danger-wait {
      background-color: #ff6666; /* deeper red */
      color: #ffffff; /* white text is still okay here */
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Verdana, sans-serif;
      padding: 30px 20px;
      transition: background 0.3s, color 0.3s;
      max-width: 1200px;
      margin: 0 auto;
      line-height: 1.6;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }

    h1, h2, h3 {
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    header h3 {
      font-family: Verdana, sans-serif;
      color: var(--accent-color);
      font-size: 1.8rem;
      margin: 0 auto;
      text-align: center;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    .form-wrapper {
      max-width: 800px;
      margin: 0 auto;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 30px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-light);
    }

    th, td {
      border-bottom: 1px solid var(--border-light);
      padding: 14px 16px;
      text-align: left;
    }

    body.dark th, body.dark td {
      border-bottom-color: var(--border-dark);
    }

    th {
      background-color: var(--accent-color);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 0.5px;
    }

    tbody tr {
      transition: background-color 0.2s;
    }

    tbody tr:hover {
      background-color: rgba(142, 0, 0, 0.05);
    }

    body.dark tbody tr:hover {
      background-color: rgba(142, 0, 0, 0.15);
    }

    tbody tr:nth-child(even) {
      background-color: rgba(0, 0, 0, 0.02);
    }

    body.dark tbody tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.02);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .assign-form {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select, button {
      padding: 12px 16px;
      border: 2px solid var(--border-light);
      border-radius: 8px;
      font-size: 14px;
    }

    select:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(142, 0, 0, 0.1);
    }

    button {
      background-color: var(--accent-color);
      color: white;
      cursor: pointer;
      font-weight: 600;
      border: none;
      transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
    }

    button:hover:not(:disabled) {
      background-color: #a00000;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(142, 0, 0, 0.3);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .toggle-theme {
      cursor: pointer;
      font-size: 1.4em;
    }
    .warning-wait {
      background-color: #fff3cd; /* yellow */
    }

    .danger-wait {
      background-color: #ffcccc; /* red */
    }

    .pulse {
      animation: pulseAnim 1.5s infinite;
    }

    @keyframes pulseAnim {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }

    .footer-copyright {
      position: fixed;
      bottom: 10px;
      right: 20px;
      font-size: 11px;
      opacity: 0.6;
      transition: opacity 0.3s, color 0.3s;
      z-index: 1000;
      pointer-events: none;
      max-width: 400px;
      text-align: right;
      line-height: 1.3;
    }

    body.light .footer-copyright {
      color: var(--text-color-light);
    }

    body.dark .footer-copyright {
      color: var(--text-color-dark);
    }

    .footer-copyright:hover {
      opacity: 0.8;
    }

    /* Mobile Improvements */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      header h3 {
        font-size: 1.2rem;
      }

      .form-wrapper {
        max-width: 100%;
      }

      /* Card-based layout for mobile */
      table {
        display: none; /* Hide table on mobile */
      }

      #queueBody.mobile-cards {
        display: block;
      }

      .mobile-card {
        background-color: var(--input-bg-light);
        border: 2px solid var(--border-light);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 12px;
        transition: background 0.3s, border 0.3s;
      }

      body.dark .mobile-card {
        background-color: var(--input-bg-dark);
        border-color: var(--border-dark);
      }

      .mobile-card.warning-wait {
        background-color: #fff3cd;
        border-color: #ffc107;
      }

      .mobile-card.danger-wait {
        background-color: #ffcccc;
        border-color: #dc3545;
        animation: pulseAnim 1.5s infinite;
      }

      body.dark .mobile-card.warning-wait {
        background-color: #ffee99;
        color: #1a1a1a;
      }

      body.dark .mobile-card.danger-wait {
        background-color: #ff6666;
        color: #ffffff;
      }

      .mobile-card-title {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 8px;
        color: var(--accent-color);
      }

      .mobile-card-info {
        font-size: 0.95em;
        margin-top: 5px;
      }

      /* Larger touch targets for mobile */
      select, button {
        padding: 12px;
        font-size: 1em;
        min-height: 44px;
        width: 100%;
        margin-bottom: 10px;
      }

      .assign-form {
        flex-direction: column;
        gap: 0;
      }

      .toggle-theme {
        font-size: 1.8em;
        padding: 8px;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }

  </style>
  <script>
  let clientQueue = [];
  let volunteers = [];
  let lastSerializedData = "";  // used to detect changes
  let refreshInterval = null;
  let isPageVisible = true;
  let lastUpdateTime = null;

  function toggleTheme() {
    const body = document.body;
    const toggle = document.querySelector('.toggle-theme');
    if (body.classList.contains('dark')) {
      body.classList.replace('dark', 'light');
      toggle.textContent = '‚òÄÔ∏è';
      localStorage.setItem('darkMode', 'false');
    } else {
      body.classList.replace('light', 'dark');
      toggle.textContent = 'üåô';
      localStorage.setItem('darkMode', 'true');
    }
  }

  // Load saved theme preference on page load
  function loadThemePreference() {
    const darkMode = localStorage.getItem('darkMode');
    const body = document.body;
    const toggle = document.querySelector('.toggle-theme');
    if (darkMode === 'true') {
      body.classList.replace('light', 'dark');
      toggle.textContent = 'üåô';
    }
  }

  function updateLastUpdatedTime() {
    const timeElement = document.getElementById('lastUpdated');
    if (timeElement) {
      const now = new Date();
      lastUpdateTime = now;
      timeElement.textContent = `Last updated: ${now.toLocaleTimeString()}`;
    }
  }

  function loadQueue() {
    if (!isPageVisible) return; // Don't refresh if page is not visible
    
    google.script.run.withSuccessHandler(data => {
      const serialized = JSON.stringify(data);

      // Only re-render if data actually changed
      if (serialized !== lastSerializedData) {
        lastSerializedData = serialized;
        clientQueue = data.clients;
        volunteers = data.volunteers;
        renderQueue();
        populateVolunteerDropdown();
        updateLastUpdatedTime();
      } else {
        // Still update timestamp even if data didn't change
        updateLastUpdatedTime();
      }
    }).getQueueData();
  }

  function manualRefresh() {
    loadQueue();
  }

  // Auto-refresh every 30 seconds
  function startAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(loadQueue, 30000); // 30 seconds
  }

  // Pause refresh when page is not visible
  document.addEventListener('visibilitychange', function() {
    isPageVisible = !document.hidden;
    if (isPageVisible) {
      startAutoRefresh();
      loadQueue(); // Refresh immediately when page becomes visible
    } else {
      if (refreshInterval) clearInterval(refreshInterval);
    }
  });

  // Start auto-refresh on page load
  startAutoRefresh();

  function renderQueue() {
    const tbody = document.getElementById('queueBody');
    const queueCount = document.getElementById('queueCount');
    tbody.innerHTML = '';

    // Detect if mobile view
    const isMobile = window.innerWidth <= 768;

    // Sort by priority first (High Priority first), then by wait time (longest first)
    const sortedQueue = [...clientQueue].sort((a, b) => {
      // Priority comparison: High Priority (true) comes before Normal (false)
      const aPriority = a.isHighPriority === true;
      const bPriority = b.isHighPriority === true;
      if (aPriority !== bPriority) {
        return bPriority ? 1 : -1; // High priority first
      }
      // If same priority, sort by wait time (longest first)
      return parseWaitTimeToMinutes(b.waitTime) - parseWaitTimeToMinutes(a.waitTime);
    });

    if (isMobile) {
      // Mobile: Card-based layout
      tbody.classList.add('mobile-cards');
      sortedQueue.forEach(client => {
        const card = document.createElement('div');
        card.className = 'mobile-card';
        const waitMins = parseWaitTimeToMinutes(client.waitTime);

        if (waitMins >= 30) {
          card.classList.add('danger-wait', 'pulse');
        } else if (waitMins >= 15) {
          card.classList.add('warning-wait');
        }

        const priorityBadge = client.isHighPriority
          ? '<span style="background-color: #c0392b; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.9em; font-weight: bold; display: inline-block; margin-bottom: 8px;">HIGH PRIORITY</span><br>'
          : '';

        card.innerHTML = `
          ${priorityBadge}
          <div class="mobile-card-title">${client.clientId}</div>
          <div class="mobile-card-info">‚è±Ô∏è Wait Time: ${client.waitTime}</div>
        `;
        tbody.appendChild(card);
      });
    } else {
      // Desktop: Table layout
      tbody.classList.remove('mobile-cards');
      sortedQueue.forEach(client => {
        const row = document.createElement('tr');
        const waitMins = parseWaitTimeToMinutes(client.waitTime);

        if (waitMins >= 30) {
          row.classList.add('danger-wait', 'pulse');
        } else if (waitMins >= 15) {
          row.classList.add('warning-wait');
        }

        // Add priority indicator
        const priorityBadge = client.isHighPriority
          ? '<span style="background-color: #c0392b; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.85em; font-weight: bold; margin-right: 8px;">HIGH PRIORITY</span>'
          : '';

        row.innerHTML = `
          <td>${priorityBadge}${client.clientId}</td>
          <td>${client.waitTime}</td>
        `;
        tbody.appendChild(row);
      });
    }

    queueCount.textContent = `Total clients in queue: ${sortedQueue.length}`;
  }

  function populateVolunteerDropdown() {
    const volunteerSelect = document.getElementById('volunteerSelect');
    const clientSelect = document.getElementById('clientSelect');
    volunteerSelect.innerHTML = '<option value="">Select Volunteer</option>';
    clientSelect.innerHTML = '<option value="">Select Client</option>';

    volunteers.forEach(name => {
      volunteerSelect.innerHTML += `<option value="${name}">${name}</option>`;
    });

    clientQueue.forEach(c => {
      clientSelect.innerHTML += `<option value="${c.clientId}">${c.clientId}</option>`;
    });
  }

  function assignClient() {
    const client = document.getElementById('clientSelect').value;
    const volunteer = document.getElementById('volunteerSelect').value;
    if (!client || !volunteer) return alert('Please select both a client and a volunteer.');

    google.script.run.withSuccessHandler(() => {
      const msg = `Client ${client} has been assigned to ${volunteer}.`;
      document.getElementById('modalMessage').textContent = msg;
      document.getElementById('confirmationModal').style.display = 'flex';
    }).assignClientToVolunteer(client, volunteer);
  }

  function refreshAfterModal() {
    document.getElementById('confirmationModal').style.display = 'none';
    loadQueue();
  }

  function parseWaitTimeToMinutes(waitStr) {
    const parts = waitStr.split(' ');
    let total = 0;
    for (const part of parts) {
      if (part.endsWith('h')) total += parseInt(part) * 60;
      if (part.endsWith('m')) total += parseInt(part);
    }
    return total;
  }

  // Re-render on window resize (for orientation changes)
  let resizeTimer;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
      renderQueue();
    }, 250);
  });

  window.onload = function() {
    loadThemePreference();
    loadQueue();
    updateLastUpdatedTime();
  };
</script>
</head>
<body class="light">
  <header>
    <h3>AFSA Tax Clinic Queue Dashboard</h3>
    <span class="toggle-theme" onclick="toggleTheme()">‚òÄÔ∏è</span>
  </header>

  <div class="form-wrapper">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
      <h4 style="margin: 0;">Client Queue</h4>
      <div style="display: flex; gap: 10px; align-items: center;">
        <span id="lastUpdated" style="font-size: 0.9em; color: #666;"></span>
        <button onclick="manualRefresh()" style="padding: 6px 12px; font-size: 0.9em;">üîÑ Refresh</button>
      </div>
    </div>
    <table>
      <p id="queueCount" style="margin-top: -10px; margin-bottom: 10px; font-weight: bold;"></p>
      <thead>
        <tr>
          <th>Client ID</th>
          <th>Wait Time</th>
        </tr>
      </thead>
      <tbody id="queueBody">
        <!-- Filled by JS -->
      </tbody>
    </table>

    <h4>Assign Client to Volunteer</h4>
    <div class="assign-form">
      <select id="clientSelect"></select>
      <select id="volunteerSelect"></select>
      <button onclick="assignClient()">Assign</button>
    </div>
  </div>
  <div id="confirmationModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:white; color:#1a1a1a; padding:30px; border-radius:10px; max-width:400px; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,0.3);">
    <p id="modalMessage" style="font-size:1.1rem;">Client has been assigned to volunteer.</p>
    <button onclick="refreshAfterModal()" style="margin-top:15px; padding:8px 20px; background-color:rgb(142, 0, 0); color:white; border:none; border-radius:5px; cursor:pointer;">OK</button>
  </div>
</div>
<div class="footer-copyright">The Client And Tax Booking Utility System (CATBUS) is designed for use only by UW AFSA Tax Clinic.</div>
</body>
</html>
