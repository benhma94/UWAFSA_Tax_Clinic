{"files":[{"id":"36869872-b5c5-4226-b602-ccc67ad4e73e","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"America/New_York\",\n  \"dependencies\": {},\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\",\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  }\n}"},{"id":"bfe13d75-e684-49f7-bce5-dde9573b70e6","name":"Code","type":"server_js","source":"function doGet() {\n  return HtmlService.createTemplateFromFile(\u0027admin\u0027)\n    .evaluate()\n    .setTitle(\u0027Tax Clinic Queue Master Dashboard\u0027);\n}\n\nfunction include(filename) {\n  return HtmlService.createHtmlOutputFromFile(filename).getContent();\n}\n\nfunction getClientQueue() {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const intakeSheet \u003d ss.getSheetByName(\u0027Client Intake\u0027);\n  const assignmentSheet \u003d ss.getSheetByName(\u0027Client Assignment\u0027);\n\n  const intakeData \u003d intakeSheet.getDataRange().getValues();\n  const assignmentData \u003d assignmentSheet.getDataRange().getValues();\n\n  const assignedClientIds \u003d new Set(\n    assignmentData.slice(1).map(row \u003d\u003e row[1]?.toString().trim()) // Column B of Client Assignment\n  );\n\n  const queue \u003d [];\n  const now \u003d new Date();\n\n  for (let i \u003d 1; i \u003c intakeData.length; i++) {\n    const timestamp \u003d intakeData[i][0];        // Column A\n    const clientId \u003d intakeData[i][5]?.toString().trim(); // Column F\n\n    if (clientId \u0026\u0026 !assignedClientIds.has(clientId)) {\n      queue.push({\n        clientId,\n        waitTime: formatElapsedTime(now - new Date(timestamp)),\n        row: i + 1\n      });\n    }\n  }\n\n  return queue;\n}\n\nfunction assignClientToVolunteer(clientId, volunteerName) {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const intakeSheet \u003d ss.getSheetByName(\u0027Client Intake\u0027);\n  const assignmentSheet \u003d ss.getSheetByName(\u0027Client Assignment\u0027);\n  const intakeData \u003d intakeSheet.getDataRange().getValues();\n\n  // Check if the clientId exists and is unassigned (in Client Intake)\n  let found \u003d false;\n  for (let i \u003d 1; i \u003c intakeData.length; i++) {\n    const currentClientId \u003d intakeData[i][5]; // Column F: Client ID\n    const assigned \u003d intakeData[i][2];        // Column C: Assigned volunteer (ignore now)\n\n    if (currentClientId \u003d\u003d\u003d clientId) {\n      found \u003d true;\n      break;\n    }\n  }\n\n  if (!found) return false;\n\n  // Log assignment to \u0027Client Assignment\u0027 sheet\n  assignmentSheet.appendRow([\n    new Date(),     // Column A: Timestamp\n    clientId,       // Column B\n    volunteerName   // Column C\n  ]);\n\n  return true;\n}\n\nfunction formatElapsedTime(milliseconds) {\n  const totalMinutes \u003d Math.floor(milliseconds / 60000);\n  const hours \u003d Math.floor(totalMinutes / 60);\n  const minutes \u003d totalMinutes % 60;\n\n  if (hours \u003e 0) {\n    return `${hours}h ${minutes}m`;\n  } else {\n    return `${minutes}m`;\n  }\n}\n\nfunction getQueueData() {\n  const queue \u003d getClientQueue();\n  const volunteers \u003d getAvailableVolunteers(); // You\u0027ll need this helper\n\n  return {\n    clients: queue,\n    volunteers: volunteers\n  };\n}\n\nfunction getAvailableVolunteers() {\n  const ss \u003d SpreadsheetApp.openById(\u00271W669LwuA8IpB03BlmhwnUkkupMZW2Cg0I_6cvSp0pwI\u0027);\n  const volunteerSheet \u003d ss.getSheetByName(\u0027Volunteer List\u0027);\n  const signOutSheet \u003d ss.getSheetByName(\u0027SignOut\u0027);\n  const assignmentSheet \u003d ss.getSheetByName(\u0027Client Assignment\u0027);\n\n  const volunteerData \u003d volunteerSheet.getDataRange().getValues();\n  const signOutData \u003d signOutSheet.getDataRange().getValues();\n  const assignmentData \u003d assignmentSheet.getDataRange().getValues();\n\n  const today \u003d new Date().toDateString();\n  const activeVolunteers \u003d [];\n\n  // Build a set of currently busy volunteers\n  const busyVolunteers \u003d new Set(\n    assignmentData.slice(1)\n      .filter(row \u003d\u003e !row[3])              // ignore \"Complete\" check‚Äîmore reliable\n      .map(row \u003d\u003e {\n        const label \u003d row[2]?.toString() || \"\";\n        return label.includes(\"‚Äì\")\n          ? label.split(\"‚Äì\")[1].trim()\n          : label.trim();\n      })\n      .filter(Boolean)\n  );\n\n  for (let i \u003d 1; i \u003c volunteerData.length; i++) {\n    const signInDate \u003d new Date(volunteerData[i][0]).toDateString();\n    const name \u003d volunteerData[i][1]?.toString().trim();\n    const station \u003d volunteerData[i][2]?.toString().trim();\n    const sessionId \u003d volunteerData[i][3]?.toString().trim();\n\n    if (!name || !station || !sessionId) continue;\n    if (station \u003d\u003d\u003d \"Mentor\" || station \u003d\u003d\u003d \"Receptionist\") continue;\n    if (signInDate !\u003d\u003d today) continue;\n\n    // Check if signed out\n    const signedOut \u003d signOutData.some(row \u003d\u003e {\n      const outId \u003d row[2]?.toString().trim();\n      return outId \u003d\u003d\u003d sessionId;\n    });\n\n    if (signedOut) continue;\n    if (busyVolunteers.has(name)) continue;\n\n    activeVolunteers.push(`Station ${station} ‚Äì ${name}`);\n  }\n\n  return activeVolunteers.sort((a, b) \u003d\u003e {\n    const getNum \u003d s \u003d\u003e parseInt(s.split(\"‚Äì\")[0].replace(\"Station\", \"\").trim());\n    return getNum(a) - getNum(b);\n  });\n}\n\n"},{"id":"a6ab69fd-f2d2-49a2-b054-0de08d8afa30","name":"admin","type":"html","source":"\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n  \u003cbase target\u003d\"_top\"\u003e\n  \u003cstyle\u003e\n    :root {\n      --accent-color: rgb(142, 0, 0);\n      --bg-color-light: #ffffff;\n      --text-color-light: #1a1a1a;\n      --input-bg-light: #f2f2f2;\n      --border-light: #ccc;\n      --bg-color-dark: #1e1e1e;\n      --text-color-dark: #f0f0f0;\n      --input-bg-dark: #2a2a2a;\n      --border-dark: #444;\n    }\n\n    body.light {\n      background-color: var(--bg-color-light);\n      color: var(--text-color-light);\n    }\n\n    body.dark {\n      background-color: var(--bg-color-dark);\n      color: var(--text-color-dark);\n    }\n\n    /* Fix for warning rows in dark mode */\n    body.dark .warning-wait {\n      background-color: #ffee99; /* brighter yellow */\n      color: #1a1a1a; /* dark text for readability */\n    }\n\n    /* Fix for danger rows in dark mode */\n    body.dark .danger-wait {\n      background-color: #ff6666; /* deeper red */\n      color: #ffffff; /* white text is still okay here */\n    }\n\n    body {\n      margin: 0;\n      font-family: \u0027Segoe UI\u0027, Verdana, sans-serif;\n      padding: 20px;\n      transition: background 0.3s, color 0.3s;\n    }\n\n    header {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      margin-bottom: 30px;\n    }\n\n    header h3 {\n      font-family: Verdana, sans-serif;\n      color: var(--accent-color);\n      font-size: 1.5rem;\n      margin: 0 auto;\n      text-align: center;\n    }\n\n    .form-wrapper {\n      max-width: 800px;\n      margin: 0 auto;\n    }\n\n    table {\n      width: 100%;\n      border-collapse: collapse;\n      margin-bottom: 30px;\n    }\n\n    th, td {\n      border: 1px solid var(--border-light);\n      padding: 10px;\n      text-align: left;\n    }\n\n    th {\n      background-color: var(--accent-color);\n      color: white;\n    }\n\n    .assign-form {\n      display: flex;\n      gap: 10px;\n      align-items: center;\n      flex-wrap: wrap;\n    }\n\n    select, button {\n      padding: 8px;\n      border: 1px solid var(--border-light);\n      border-radius: 5px;\n    }\n\n    button {\n      background-color: var(--accent-color);\n      color: white;\n      cursor: pointer;\n      transition: background 0.2s;\n    }\n\n    button:hover {\n      background-color: #a00000;\n    }\n\n    .toggle-theme {\n      cursor: pointer;\n      font-size: 1.4em;\n    }\n    .warning-wait {\n      background-color: #fff3cd; /* yellow */\n    }\n\n    .danger-wait {\n      background-color: #ffcccc; /* red */\n    }\n\n    .pulse {\n      animation: pulseAnim 1.5s infinite;\n    }\n\n    @keyframes pulseAnim {\n      0% { opacity: 1; }\n      50% { opacity: 0.6; }\n      100% { opacity: 1; }\n    }\n\n\n  \u003c/style\u003e\n  \u003cscript\u003e\n  let clientQueue \u003d [];\n  let volunteers \u003d [];\n  let lastSerializedData \u003d \"\";  // \u003c--- NEW: used to detect changes\n\n  function toggleTheme() {\n    const body \u003d document.body;\n    body.classList.toggle(\u0027dark\u0027);\n    body.classList.toggle(\u0027light\u0027);\n  }\n\n  function loadQueue() {\n    google.script.run.withSuccessHandler(data \u003d\u003e {\n      const serialized \u003d JSON.stringify(data);\n\n      // Only re-render if data actually changed\n      if (serialized !\u003d\u003d lastSerializedData) {\n        lastSerializedData \u003d serialized;\n        clientQueue \u003d data.clients;\n        volunteers \u003d data.volunteers;\n        renderQueue();\n        populateVolunteerDropdown();\n      }\n    }).getQueueData();\n  }\n\n  // üîÑ NEW: Auto-refresh every 7 seconds\n  setInterval(loadQueue, 7000);\n\n  function renderQueue() {\n    const tbody \u003d document.getElementById(\u0027queueBody\u0027);\n    const queueCount \u003d document.getElementById(\u0027queueCount\u0027);\n    tbody.innerHTML \u003d \u0027\u0027;\n\n    const sortedQueue \u003d [...clientQueue].sort((a, b) \u003d\u003e {\n      return parseWaitTimeToMinutes(b.waitTime) - parseWaitTimeToMinutes(a.waitTime);\n    });\n\n    sortedQueue.forEach(client \u003d\u003e {\n      const row \u003d document.createElement(\u0027tr\u0027);\n      const waitMins \u003d parseWaitTimeToMinutes(client.waitTime);\n\n      if (waitMins \u003e\u003d 30) {\n        row.classList.add(\u0027danger-wait\u0027, \u0027pulse\u0027);\n      } else if (waitMins \u003e\u003d 15) {\n        row.classList.add(\u0027warning-wait\u0027);\n      }\n\n      row.innerHTML \u003d `\n        \u003ctd\u003e${client.clientId}\u003c/td\u003e\n        \u003ctd\u003e${client.waitTime}\u003c/td\u003e\n      `;\n      tbody.appendChild(row);\n    });\n\n    queueCount.textContent \u003d `Total clients in queue: ${sortedQueue.length}`;\n  }\n\n  function populateVolunteerDropdown() {\n    const volunteerSelect \u003d document.getElementById(\u0027volunteerSelect\u0027);\n    const clientSelect \u003d document.getElementById(\u0027clientSelect\u0027);\n    volunteerSelect.innerHTML \u003d \u0027\u003coption value\u003d\"\"\u003eSelect Volunteer\u003c/option\u003e\u0027;\n    clientSelect.innerHTML \u003d \u0027\u003coption value\u003d\"\"\u003eSelect Client\u003c/option\u003e\u0027;\n\n    volunteers.forEach(name \u003d\u003e {\n      volunteerSelect.innerHTML +\u003d `\u003coption value\u003d\"${name}\"\u003e${name}\u003c/option\u003e`;\n    });\n\n    clientQueue.forEach(c \u003d\u003e {\n      clientSelect.innerHTML +\u003d `\u003coption value\u003d\"${c.clientId}\"\u003e${c.clientId}\u003c/option\u003e`;\n    });\n  }\n\n  function assignClient() {\n    const client \u003d document.getElementById(\u0027clientSelect\u0027).value;\n    const volunteer \u003d document.getElementById(\u0027volunteerSelect\u0027).value;\n    if (!client || !volunteer) return alert(\u0027Please select both a client and a volunteer.\u0027);\n\n    google.script.run.withSuccessHandler(() \u003d\u003e {\n      const msg \u003d `Client ${client} has been assigned to ${volunteer}.`;\n      document.getElementById(\u0027modalMessage\u0027).textContent \u003d msg;\n      document.getElementById(\u0027confirmationModal\u0027).style.display \u003d \u0027flex\u0027;\n    }).assignClientToVolunteer(client, volunteer);\n  }\n\n  function refreshAfterModal() {\n    document.getElementById(\u0027confirmationModal\u0027).style.display \u003d \u0027none\u0027;\n    loadQueue();\n  }\n\n  function parseWaitTimeToMinutes(waitStr) {\n    const parts \u003d waitStr.split(\u0027 \u0027);\n    let total \u003d 0;\n    for (const part of parts) {\n      if (part.endsWith(\u0027h\u0027)) total +\u003d parseInt(part) * 60;\n      if (part.endsWith(\u0027m\u0027)) total +\u003d parseInt(part);\n    }\n    return total;\n  }\n\n  window.onload \u003d loadQueue;\n\u003c/script\u003e\n\u003c/head\u003e\n\u003cbody class\u003d\"light\"\u003e\n  \u003cheader\u003e\n    \u003ch3\u003eAFSA Tax Clinic Queue Dashboard\u003c/h3\u003e\n    \u003cspan class\u003d\"toggle-theme\" onclick\u003d\"toggleTheme()\"\u003e‚òÄÔ∏è\u003c/span\u003e\n  \u003c/header\u003e\n\n  \u003cdiv class\u003d\"form-wrapper\"\u003e\n    \u003ch4\u003eClient Queue\u003c/h4\u003e\n    \u003ctable\u003e\n      \u003cp id\u003d\"queueCount\" style\u003d\"margin-top: -10px; margin-bottom: 10px; font-weight: bold;\"\u003e\u003c/p\u003e\n      \u003cthead\u003e\n        \u003ctr\u003e\n          \u003cth\u003eClient ID\u003c/th\u003e\n          \u003cth\u003eWait Time\u003c/th\u003e\n        \u003c/tr\u003e\n      \u003c/thead\u003e\n      \u003ctbody id\u003d\"queueBody\"\u003e\n        \u003c!-- Filled by JS --\u003e\n      \u003c/tbody\u003e\n    \u003c/table\u003e\n\n    \u003ch4\u003eAssign Client to Volunteer\u003c/h4\u003e\n    \u003cdiv class\u003d\"assign-form\"\u003e\n      \u003cselect id\u003d\"clientSelect\"\u003e\u003c/select\u003e\n      \u003cselect id\u003d\"volunteerSelect\"\u003e\u003c/select\u003e\n      \u003cbutton onclick\u003d\"assignClient()\"\u003eAssign\u003c/button\u003e\n    \u003c/div\u003e\n  \u003c/div\u003e\n  \u003cdiv id\u003d\"confirmationModal\" style\u003d\"display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;\"\u003e\n  \u003cdiv style\u003d\"background:white; color:#1a1a1a; padding:30px; border-radius:10px; max-width:400px; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,0.3);\"\u003e\n    \u003cp id\u003d\"modalMessage\" style\u003d\"font-size:1.1rem;\"\u003eClient has been assigned to volunteer.\u003c/p\u003e\n    \u003cbutton onclick\u003d\"refreshAfterModal()\" style\u003d\"margin-top:15px; padding:8px 20px; background-color:rgb(142, 0, 0); color:white; border:none; border-radius:5px; cursor:pointer;\"\u003eOK\u003c/button\u003e\n  \u003c/div\u003e\n\u003c/div\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"}]}